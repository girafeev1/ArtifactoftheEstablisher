# P-027-09r — ERL cascade with multi-code banks & parenthesized path segments

## Save path
prompts/p-027-09r.md

## Branch & PR
- Branch: codex/wire-erl-cascade-parenthesized-codes-09r
- PR title: feat(payment): multi-code banks, parenthesized path lookup, side-by-side selects, safe identifier (P-027-09r)
- Labels: payments, ui, codex
- Do not change CI, Actions, or Vercel settings in this PR.

## Goal
Make the Add Payment **Entity → Bank → Account** cascade read the **erl-directory** database exactly as it is now:

- Each `/bankAccount/{bankName}` document includes `code` as **array of numbers** (e.g. `[40, 40]` or `[40]` etc.).
- Child collections beneath the bank name use **parenthesized** IDs, e.g. `/bankAccount/Dah Sing Bank/(040)/…`.
- Also continue to support the alternate schema `/banks/{040}/accounts/*` when present.

## Behavior (plain-English)
1. **Load banks**
   - Source A (preferred when present): `/banks/{code}` — gather all `{code}` values.
   - Source B (fallback): `/bankAccount/{bankName}` — read each doc’s `code` array.
   - Normalize each code: **string, zero-padded to 3 digits** (e.g. `40 → "040"`).
   - Build options for the **Bank** dropdown as **one option per code** (so multi-code banks appear multiple times):
     - **Label:** `"{bankName} {code}"` (e.g. `Dah Sing Bank 040`).
     - **Carry both**: `bankName`, `codeNormalized` (e.g. `"040"`), and the **raw parenthesized segment** `rawCodeSegment = "(" + codeNormalized + ")"`.

2. **Load accounts after a bank option is picked**
   - Try **new schema** first: `/banks/{codeNormalized}/accounts/*`.
   - If none, use **legacy path** with parentheses: `/bankAccount/{bankName}/{rawCodeSegment}/*` (e.g. `/bankAccount/Dah Sing Bank/(040)/*`).
   - Merge/dedupe if both exist (key = `accountDocId`).
   - Show **Bank Account** options with **label = `accountType`**, value = `accountDocId`.

3. **Write fields on submit (ERL only)**
   - Always write: `method`, `entity`, `refNumber`, `timestamp`, `editedBy`.
   - Also write: `bankCode = codeNormalized` and `accountDocId`.
   - **Identifier** = `"{codeNormalized}/{accountDocId}"`.
   - If the user typed a custom identifier that doesn’t match our pattern, overwrite with the composed one.

4. **Layout**
   - On ERL, **Bank** and **Bank Account** sit **side-by-side on one row** (wrap on very narrow screens).
   - Keep the **3-dots** and **Service Mode** on the same baseline inside the card footer.
   - Render the tiny **Nunito/200 P-prompt badge** once, top-right inside the card.

5. **Friendly errors**
   - If directory reads are blocked or empty, show inline message:
     “Bank directory unavailable (check rules on the **erl-directory** database).”
   - Do not crash; switching Entity to Personal hides bank/account and allows continue.

## Tests (describe behavior; no code)
- **Unit**
  - Code sanitizer: `40`, `"040"`, `"(040)"` → **normalized `"040"`** and **`rawCodeSegment "(040)"`**.
  - Fallback logic chooses `/banks/{code}/accounts` first; otherwise uses `/bankAccount/{name}/(code)/*`.
  - Identifier composer yields `"040/accountDocId"` and overrides malformed user input.
- **Component/E2E**
  1. Multi-code bank shows **one Bank option per code** (e.g., `Dah Sing Bank 040` and `Dah Sing Bank 012`).
  2. Picking a Bank option loads accounts from the correct parenthesized path when `/banks` doesn’t exist.
  3. Submit writes `method`, `entity`, `bankCode: "040"`, `accountDocId`, `identifier: "040/{accountDocId}"`, plus audit fields.
  4. ERL row layout: Bank + Bank Account side-by-side; footer baseline alignment; single prompt badge.

## Acceptance
- Bank dropdown correctly reflects **multi-code** banks.
- Accounts load via **`(code)`** paths when `/banks` is absent.
- Submitted ERL payments always have a **sanitized code** and correct **identifier**.
- Side-by-side selects; baseline-aligned footer; single badge.
- Clear inline error when reads fail; no crashes; no new TS errors.
