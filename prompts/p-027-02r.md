P-027-02r — Ship the actual Add Payment cascade UI + sticky Back + single Remaining blink + stable assignment

Save exactly at: prompts/p-027-02r.md
Branch: codex/complete-add-payment-cascade-02r
PR title: feat(payment): Add Payment cascade (Entity→Bank→Account) UI, sticky Back, single Remaining blink, stable assignment (P-027-02r)
Labels: payments, ui, codex
Do not modify: CI/workflows, deployment configs, Task Log (separate prompt will handle docs).

Background (what’s still missing)

Add Payment dialog doesn’t yet render the Entity → Bank → Bank Account dependent dropdowns; only submit-time stamping exists.

Back button is not reliably inside the sticky footer.

Remaining sometimes doubles up (two renders/classes).

Session assignment UI can disappear; needs a persistent shell/zero-state.

Keep the list view “For Session(s)” column (≤5 + …) and header ellipsis work intact.

Deliverables
A) Sticky footer & Back placement (StudentDialog)

Render the Back control inside the sticky footer/action bar (same container as primary actions).

Ensure the dialog body is the scroll container; add bottom padding equal to the footer height so content is never obscured.

Footer style (adapt to your styling system):

position: sticky;
bottom: 0;
z-index: 10;
border-top: 1px solid var(--mui-palette-divider);
box-shadow: 0 -2px 8px rgba(0,0,0,.04);
background: inherit;


Add data-testid="dialog-footer" and data-testid="back-button".

B) Remaining blink — single render only

Payment Amount: never blinks.

Remaining: render once with the blink class (e.g., .blink-remaining); remove any duplicate element/spans.

If you currently compute remaining in two places, refactor to a single memo + one <span data-testid="remaining-amount">…</span>.

Respect prefers-reduced-motion (existing tokens/classes).

C) Session assignment — always visible & functional

Keep the assignment section mounted even when no rows: render a zero-state (e.g., “No sessions available”) with data-testid="assignment-zero".

Selecting/unselecting sessions updates Remaining immediately and persists via existing hooks/services.

Ensure “For Session(s)” summary in detail view does not hide/replace the assignment controls.

D) Add Payment dialog — full cascade UI + writes

Implement the exact UI + data flow. Use controlled components with clear state, types, and data-testids.

Payment Method (dropdown)

Options: FPS, Bank Transfer, Cheque

Save to method: string.

data-testid="method-select"

Entity (dropdown)

Options: Music Establish (ERL), Personal

Save to entity: string (use the label text).

On change to Personal, clear bankCode, accountDocId, and **identifier`.

data-testid="entity-select"

If Entity = "Music Establish (ERL)" show two dependent dropdowns:

Bank

Fetch from ERL directory DB. Prefer structure banks/{bankCode}; gracefully fallback to legacy bankAccount/{bankCode}/accounts/*.

Option label: {bankName} {bankCode} (fallback {docId} {collectionId} if missing).

Save selected bankCode.

data-testid="bank-select"

Bank Account

Dependent on Bank; list sub-collection accounts for the selected bank.

Option label: accountType; value: accountDocId.

Save selected accountDocId.

data-testid="bank-account-select"

Reference Number (text)

Save to refNumber: string.

data-testid="ref-input"

Submit (rename from Save)

On submit:

If entity === "Music Establish (ERL)", set identifier = "${bankCode}/${accountDocId}".

If user entered identifier exists but doesn’t match /^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/, recompute from {bankCode}/{accountDocId}.

Stamp timestamp and editedBy.

data-testid="submit-payment"

Validation UX

Disable Submit until required fields are valid:

Always: method, entity.

If ERL: bankCode & accountDocId.

Show inline helper/error text; keep to your existing pattern.

Data access helper

If missing, add lib/erlDirectory.ts with typed helpers:

listBanks(): Promise<Array<{ bankCode: string; bankName?: string }>>

listAccounts(bankCode): Promise<Array<{ accountDocId: string; accountType?: string }>>

Implement graceful fallback between the two Firestore shapes above; no secrets in code.

E) List view “For Session(s)”

Keep the column present; display ≤5 ordinals with a trailing … when more exist.

Do not regress header ellipsis/resizers.

File hints (search/adapt)

components/StudentDialog/PaymentModal.tsx — cascade UI + submit logic

components/StudentDialog/PaymentDetail.tsx — single Remaining render; assignment shell/zero-state

components/StudentDialog/PaymentHistory.tsx — verify sessions column & header ellipsis

styles/studentDialog.css — sticky footer polish

lib/erlDirectory.ts — ERL directory helpers (banks/accounts)

Tests (no placeholders; add data-testids above to target)
Unit

normalizeIdentifier() — valid, invalid → recompute; ERL vs Personal transitions.

ERL directory transforms (label builders, fallbacks).

Cypress / component (run locally; guard in CI if needed)

Sticky Back

Assert data-testid="back-button" is inside data-testid="dialog-footer" and remains visible while body scrolls.

Blink

Change assignment selection; assert only data-testid="remaining-amount" has the blink class; amount never has it.

Assignment

With zero available rows, data-testid="assignment-zero" is visible (section doesn’t vanish).

Selecting a session moves it to assigned and updates Remaining (numeric assertion).

Cascade

Select method, entity="Music Establish (ERL)", pick a Bank, then Bank Account; fill refNumber; Submit.

Verify document writes: method, entity, bankCode, accountDocId, identifier = bankCode/accountDocId, refNumber, timestamp, editedBy.

Switch entity to Personal and ensure bank/account fields clear and identifier isn’t forced.

Keep specs committed. If CI lacks GUI deps, wrap with if (Cypress.env('CI_HEADLESS')) this.skip() or similar. Do not edit Actions.

Acceptance checklist

 Back sits inside sticky footer; footer sticks to window edge.

 Remaining uses one blinking element; Payment Amount is static.

 Assignment section is persistent with a zero-state and works end-to-end.

 Add Payment cascade UI works exactly: Entity→Bank→Account, with writes & normalization + audit fields.

 List “For Session(s)” remains (≤5 + …).

 No new TypeScript errors; tests added with real assertions.

Save this prompt

Create prompts/p-027-02r.md with this content verbatim (no renames).
