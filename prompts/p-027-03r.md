# P-027-03r — Finish Add Payment cascade UI + sticky Back + single Remaining blink + stable assignment + UI badge + 3-dots placement

## Background
Live review still shows missing cascade UI (Entity→Bank→Account), Back not reliably in sticky footer, Remaining occasionally double-renders, and assignment shell can disappear. Also add a tiny version/badge and correct the 3-dots settings button placement.

## Deliverables

### 1) Sticky footer & Back placement (StudentDialog)
- Render **Back** inside the sticky footer/action bar (same region as primary actions).
- Ensure the **dialog body** is the scroll container; add bottom padding = footer height.
- Footer CSS (adapt to theme):
  position: sticky; bottom: 0; z-index: 10;
  border-top: 1px solid var(--mui-palette-divider);
  box-shadow: 0 -2px 8px rgba(0,0,0,.04);
  background: inherit;
- Add: data-testid="dialog-footer", data-testid="back-button".

### 2) Remaining blink — single element only
- **Payment Amount**: never blinks.
- **Remaining**: render once with blink class (e.g. .blink-remaining).
- Remove any duplicate span/fragment; expose data-testid="remaining-amount".
- Respect prefers-reduced-motion.

### 3) Session assignment — always visible & functional
- Keep section **mounted** with a **zero-state** (“No sessions available.”) when rows are 0.
- Selecting/unselecting sessions updates **Remaining** immediately and persists via existing hooks/services.
- The “For Session(s)” summary must **not** hide/replace assignment controls.
- Add data-testid="assignment-zero".

### 4) **Add Payment** dialog — full cascade **UI** + writes
Implement actual UI (controlled components) + dependent fetches + submit writes.

1) **Method** (select) — `FPS`, `Bank Transfer`, `Cheque` → `method: string`  
   data-testid="method-select"

2) **Entity** (select) — `Music Establish (ERL)`, `Personal` → `entity: string`  
   - When switching to Personal: clear `bankCode`, `accountDocId`, `identifier`.  
   data-testid="entity-select"

3) If **Entity = "Music Establish (ERL)"**:
   - **Bank** (select): list from ERL directory; label `{bankName} {bankCode}`; fallback `{docId} {collectionId}`; write `bankCode`.  
     data-testid="bank-select"
   - **Bank Account** (select): dependent on bank; list accounts; label `accountType`; value `accountDocId`; write `accountDocId`.  
     data-testid="bank-account-select`
   - On submit: set `identifier = "${bankCode}/${accountDocId}"`.

4) **Reference Number** (text) → `refNumber: string`  
   data-testid="ref-input"

5) **Submit** button (rename from Save)  
   data-testid="submit-payment"  
   On submit:
   - Validate required fields: `method`, `entity`; if ERL then `bankCode` & `accountDocId`.
   - Write fields; stamp `timestamp` & `editedBy`.
   - If user-entered `identifier` exists but fails `/^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/`, recompute from `{bankCode}/{accountDocId}` before write.

6) **Data access helper**  
   If missing, add `lib/erlDirectory.ts`:
   - `listBanks(): Promise<Array<{ bankCode: string; bankName?: string }>>`
   - `listAccounts(bankCode: string): Promise<Array<{ accountDocId: string; accountType?: string }>>`
   Gracefully support both Firestore shapes. No secrets in code.

### 5) Tiny chrome badge — show current P-prompt in top-right
- Add a tiny badge in the **app top-right corner** (global layout/top bar), showing the **current prompt id** for this PR: **“P-027-03r”**.
- Style: font-family `Nunito`, font-weight 200 (ExtraLight), font-size 10–11px, opacity ~0.6; pointer-events: none.
- Place within the app chrome (not overlapping menus).  
  data-testid="pprompt-badge"
> For future prompts, this text will be updated by changing the constant.

### 6) 3-dots settings button — bottom-left **inside white card**
- The 3-dots settings button should be **sticky to the bottom** but **inside** the white card container, **not** in the left sidebar.
- Implementation: position the button in a container that is `position: sticky; bottom: 0;` relative to the **card**; ensure the card is the containing block.
- Respect card padding; place at the **bottom-left corner of the white card area**.
- Add data-testid="settings-3dots"

### 7) Keep list view “For Session(s)”
- Ensure column remains (≤5 ordinals + trailing “…”). Keep header ellipsis/resizers intact.

## Tests (no placeholders)
### Unit
- normalizeIdentifier() valid/invalid; ERL→Personal clears; label builders for ERL lists.

### Cypress / component
1) **Sticky Back**: `data-testid="back-button"` is inside `data-testid="dialog-footer"` and remains visible while body scrolls.
2) **Blink**: change assignment; only `data-testid="remaining-amount"` blinks; amount never blinks.
3) **Assignment**: with zero available rows, `data-testid="assignment-zero"` is visible; selecting session updates Remaining and persists.
4) **Cascade**: select method, entity=ERL → pick bank → account → submit; verify doc has `method`, `entity`, `bankCode`, `accountDocId`, `identifier`, `refNumber`, `timestamp`, `editedBy`.
5) **Badge**: `data-testid="pprompt-badge"` renders with text “P-027-03r”.
6) **3-dots**: button sticks to **bottom-left inside card** (not sidebar); assert bounding rect within card container.

> Keep specs committed; if CI lacks GUI deps, guard with conditional skip. Do **not** edit workflows.

## Acceptance
- Back in sticky footer; single Remaining blink; assignment persistent; cascade UI implemented; badge shows “P-027-03r”; 3-dots positioned bottom-left **inside** card; no new TS errors.
- List out task completed per listed above for confirmation that all tasks are completed as requested
