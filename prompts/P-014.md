P-014 — Session totals revert, column auto-size, balance-due unification, dialog z-index audit, base-rate history

Context / Why

“Total Sessions” regressed: it no longer counts cancelled/proceeded like before.

Column default widths are too wide; we want Google-Sheets-style double-click to auto-size to the widest visible cell.

“Due” on student cards sometimes mismatches vs. Payment/Billing views (and sometimes shows nothing).

“Add payment” dialog can be covered by the student dialog; need a general overlay/z-index/portal hardening pass to prevent any recurrence.

Add a Base Rate audit trail with an info icon next to “Base Rate”, with history + add flow and editedBy.

Scope
Touch only the web app; keep Apps Script unchanged.

1) Revert “Total Sessions” to previous behavior

Goal

“Total Sessions” in SessionsTab header and the dashboard card must include cancelled and proceeded sessions (i.e., everything that ever existed for the account), like we had before.

Requirements

In components/StudentDialog/SessionsTab.tsx:

Ensure summary.totalSessions is computed from all sessions for the account (cancelled + proceeded + pending), not filtered by period or by flags. (Keep “Period” filter only for the visible table, not for the summary.)

The ordinal (“#”) mapping in Sessions must still align with the full chronology (including cancelled), so when a payment references #N, N is stable.

In pages/dashboard/businesses/coaching-sessions.tsx (student cards):

“Total: X → upcoming” → X must match summary.totalSessions (all sessions). “upcoming” stays as future-dated sessions only.

Acceptance checks

Create a cancelled session and a normal session → total increases by 2, even if one is cancelled.

Changing the Period filter does not change the total.

2) Double-click column lever to auto-size to widest visible content

Goal

Keep the current drag-to-resize, but double-click on the lever should auto-size the column to fit the widest visible cell content (header or body) with a small padding, and persist the width (localStorage) per user.

Implementation notes

lib/useColumnWidths.ts

Add a autoSize(key: string, root: HTMLElement) function:

Query header cell and body cells for that column via a data attribute (e.g., data-col="paymentMade").

Measure natural width via scrollWidth or getBoundingClientRect().width on an inner wrapper (consider text wrapping disabled for measurement).

Compute next = clamp(maxWidth + padding, 60, 1000).

Set width + persist (localStorage).

Expose onDoubleClick handler from the hook: onResizerDoubleClick(key, rootEl).

Tables:

In SessionsTab, PaymentHistory, RetainersTab (and the “For session” table in PaymentDetail), add data-col="<key>" to header and each column’s TableCell.

On the resizer box (.col-resizer), add onDoubleClick={(e) => onResizerDoubleClick(key, tableRootRef.current!)}.

Provide a ref to the table root container so the hook can query descendants.

Accessibility

Cursor remains col-resize.

Keep existing keyboard behavior (no regression).

Acceptance checks

Double-click resizer instantly sizes column to the widest visible content.

Resized width persists on reload (per user).

3) Balance-due: unify source of truth + UI consistency

Goal

Card view “Due” must equal the balance due used in Payment/Retainer/Sessions logic. Avoid blanks / stale cache issues.

Plan

Canonical compute: always compute current balance from useBilling(abbr, account) (client-side truth).

Cache: after any operation that changes money state, write the computed balanceDue into Students/{abbr}.billingSummary.balanceDue (for external consumers).

We already call writeSummaryFromCache(qc, abbr, account) in key flows; audit any misses:

Session rate edit (RateModal)

Voucher mark/unmark

Payment assign/unassign

Retainer add/edit

Calendar resync changes that adjust amounts (if any write path exists)

Card view fix (coaching-sessions.tsx):

Display a skeleton (or the existing slow blink) while useBilling is loading.

When useBilling resolves, use bill.balanceDue for display.

Optionally still listen to billingSummary.balanceDue as a fallback if useBilling failed, but prefer the computed value.

Acceptance checks

Make changes (assign payment, edit rate, voucher) → card “Due” matches Payment view within a refresh cycle; no “—” except while loading.

4) Dialog/overlay z-index & portal audit (fix “Add payment” being covered)

5) The Add Payment and Add Retainer button, and even the page layout for the Retainer tab and the Payment History tab looks not the same as previously deployed, please help revery it back when those button were a 'create' icon like the current session voucher tab

6) Within the selected payment history, it should be the remaining amount that blinks when there's still a remaining amount in value rather than the payment amount

Goal

Any top-level dialog (PaymentModal, RetainerModal, RateModal, etc.) should always overlay the Student Dialog; no clipping or stacking issues.

Implementation

Global theme (we already portaled Popper/Menu/Popover). Extend theme to dialogs:

In lib/theme.ts, add defaults for MuiDialog (ensures body container):

const theme = createTheme({
  components: {
    MuiPopover: { defaultProps: { container: () => document.body } },
    MuiPopper:  { defaultProps: { container: () => document.body } },
    MuiMenu:    { defaultProps: { container: () => document.body } },
    MuiDialog:  { defaultProps: { container: typeof window !== 'undefined' ? () => document.body : undefined } },
  },
});

Ensure all modals (PaymentModal, RetainerModal, RateModal, any custom modal) are implemented as MUI <Dialog/> (or <Modal/>) with default portal behavior; remove ad-hoc fixed overlays that fight the stack (e.g., hand-rolled fixed <Box> overlays).

If a custom overlay must remain, set sx={{ zIndex: (t) => t.zIndex.modal + 1 }}.

Remove any parent containers with z-index that rises above modal (audit StudentDialog wrappers, keep them at default z-index or below theme.zIndex.modal).

Verify no position: relative + high z-index on dialog content wrappers.

Acceptance checks

From PaymentHistory list, click “Add Payment” → modal always on top.

Test Retainer edits, Rate modal, Select menus, and tooltips inside dialogs—no clipping.

5) Base Rate audit trail + editor

Goal

Next to “Base Rate” label, show an info icon that opens a modal with:

History list (most recent first) with rate, timestamp, editedBy.

Add entry form: rate (number), auto timestamp (now), editedBy (current user email).

On save: append to Students/{abbr}/BaseRateHistory and update the effective base rate field used by default for new sessions (wherever that lives today).

Close modal → latest base rate reflects in SessionDetail and any place that shows “Base Rate”.

Implementation details

Data:

Collection: Students/{abbr}/BaseRateHistory/{autoId}

Document shape: { rate: number, timestamp: serverTimestamp(), editedBy: string }

UI:

In SessionDetail (where “Base Rate” is rendered), append a small IconButton with tooltip (“Base rate history”).

New BaseRateHistoryModal.tsx: lists entries (query orderBy timestamp, desc). Add a simple “Add” section at top.

Auth:

editedBy = useSession().user.email || 'unknown'

Acceptance checks

Add a new history entry → appears at top; effective base rate updates immediately where displayed.

QA checklist

 Total Sessions includes cancelled/proceeded everywhere.

 Double-click to auto-size works in Sessions, Payments, Retainers, and PaymentDetail’s “For session” table.

 Card “Due” matches computed billing; no empty values post-load.

 All dialogs appear above Student Dialog; no clipping of menus/popovers.

 BaseRateHistory works; editedBy saved.

Files you’ll likely touch

components/StudentDialog/SessionsTab.tsx

pages/dashboard/businesses/coaching-sessions.tsx

components/StudentDialog/PaymentHistory.tsx, PaymentDetail.tsx, RetainersTab.tsx

components/StudentDialog/SessionDetail.tsx (+ new BaseRateHistoryModal.tsx)

lib/useColumnWidths.ts

lib/theme.ts

styles/studentDialog.css (if needed for measurement helpers)

