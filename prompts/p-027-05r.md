# P-027-05r — Complete cascade behaviors, fix badge duplication, align 3-dots, finish sessions sorting, auto-detect latest P-prompt

## A) 3-dots vs Service Mode — exact alignment
Goal: the **settings 3-dots** button should sit on the **same horizontal line** as the **Service Mode** button, and be inside the white card (not the sidebar).

Implementation:
- The card container (e.g., Card, Panel) must host a **footer row**: `display:flex; align-items:center; justify-content:space-between; gap:12px;` with left=3-dots, right=Service Mode.
- Ensure the **card** (not page) is the containing block. The footer row may use `position: sticky; bottom: 0;` **within the card** so it sticks to the card’s bottom.
- Add `data-testid="card-footer-row"` and `data-testid="settings-3dots"`.
- Remove any positioning that anchors the 3-dots to the sidebar/page.

Acceptance:
- 3-dots and Service Mode share the **same baseline** in the card footer row.
- Left edge of 3-dots remains **inside** card padding (never in sidebar).

## B) Duplicate badge — render only once (card view)
- Keep the tiny Nunito/200 badge, but render it **in card view only** (top-right of the card view page).
- Remove any TopBar duplicate so exactly **one** badge shows per page.
- Test id: `data-testid="pprompt-badge-card"`.

## C) Auto-detect latest P-prompt (no hard-wire)
- Implement `lib/promptId.ts` with:
  - `export function latestPromptIdFromFiles(): string` — at **build-time/server** read `/prompts`, match `/^p-(\d{3})(?:-(\d{2})r)?\.md$/i`, sort by number then revision, and return an ID like `P-027-05r` or `P-027`.
  - `export function usePromptId(): string` — client hook that receives the value via a prop/provider (from a server component/layout calling `latestPromptIdFromFiles`).
- Update the badge to use this ID so future prompts are shown automatically.

## D) Complete **cascade behaviors** (visible UI + side effects)
In **Payment Detail** (editing-on-empty) and **Add Payment** dialog:
1) **Entity** change to **Personal** → immediately hide Bank/Account, and **clear** `bankCode`, `accountDocId`, `identifier`.
2) **Entity** change to **ERL** → show Bank select; after pick, show dependent Bank Account select.
3) **Submit**:
   - Require `method`, `entity`; if ERL require `bankCode` & `accountDocId`.
   - Compute **`identifier = "${bankCode}/${accountDocId}"`** for ERL.
   - Normalize: if user-typed identifier fails regex, recompute.
   - Also write `refNumber`, and stamp **`timestamp`** & **`editedBy"`.
4) **Read-only after set**: when those fields are no longer empty, render read-only values (with an optional guarded “Edit anyway” path if already present).

## E) Remaining blink — single element
- Ensure **Payment Amount** never blinks.
- **Remaining** renders once with the blink class; expose `data-testid="remaining-amount"`.
- Remove any duplicate spans/fragments and respect reduced motion.

## F) Sessions tab — finish sorting UX
- Header click toggles asc/desc; `aria-sort` reflects state.
- Persist sort per user (reuse existing user settings store).
- Keep min-width/ellipsis/resizers intact.

## Tests (no placeholders)
- Unit: prompt filename parser/sorter; normalizeIdentifier; ERL label fallbacks; sessions comparators.
- Cypress/component:
  1) **Alignment**: 3-dots and Service Mode share baseline inside `data-testid="card-footer-row"`.
  2) **Badge**: single `data-testid="pprompt-badge-card"` present; no TopBar duplicate.
  3) **Cascade**: Entity→Personal clears bank/account/identifier; Entity→ERL enables Bank→Account; Submit writes `method`, `entity`, `bankCode`, `accountDocId`, `identifier`, `refNumber`, `timestamp`, `editedBy`.
  4) **Blink**: only `data-testid="remaining-amount"` blinks; Amount static.
  5) **Sessions sorting**: header toggles sort; `aria-sort` updates; order changes; preference persists.

## Acceptance
- Alignment correct; one badge only; latest prompt auto-detected; cascade behaviors visible and working; single Remaining blink; sessions are sortable; no new TS errors.

