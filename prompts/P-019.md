P-019 — Column min-width squeeze, Sessions summary format (T-217 regression), Payment blink logic, and Base Rate history redesign

Save this exact prompt to prompts/P-019.md.
On completion, append the Task Log rows from Prompt 2 to the top of docs/Task Log.md.
Continue to include a Context Bundle in the PR (the workflow from P-018 should post/update it).

A) Column minimum width (all resizable tables)

Why: Current min ~60px is still too wide.
Change:

In lib/useColumnWidths.ts lower the min clamp from 60 → 36.

When a column is narrower than its content:

use text-overflow: ellipsis; overflow: hidden; white-space: nowrap;

add title or <Tooltip> on the <TableCell> so the full value is accessible on hover/focus.

Keep double-click auto-fit and persisted widths intact.

Ensure headers also ellipsize gracefully (no layout jump).

Acceptance:

User can drag any column down to ~36px; content ellipsizes with hover tooltip; double-click still auto-fits.

B) Sessions tab summary — fix T-217 regression

Requested display:
Total: {all} (❌ {cancelled}) and tooltip shows ✔️ {all - cancelled} excluding cancelled.

Change:

In components/StudentDialog/SessionsTab.tsx:

Replace the current three separate counters with one line:
Total: {all} (❌ {cancelled})
Attach a tooltip on that line showing ✔️ {all - cancelled} excluding cancelled.

Keep the internal counts you already compute; just change the presentation.

Mirror the same line/tooltip in the Personal tab summary where we surface student metrics.

Acceptance:

One compact line appears as above; tooltip text matches request; the Personal tab shows the same format.

C) Payment History — blink logic

Yellow blink when a payment still has remaining balance

In components/StudentDialog/PaymentHistory.tsx, compute:
remaining = remainingAmount ?? (amount - appliedAmount)

If remaining > 0, the Amount Received cell blinks yellow (same animation style as the selected payment’s “Remaining amount”).

Red blink when remaining is insufficient to pay any unpaid session

From useBilling(abbr, account), build the set of unpaid sessions (not cancelled, not voucherUsed, not inRetainer, and not already assigned to this or another payment).

Find minDue = min(amountDue) across those; if none exist, do nothing.

If remaining > 0 && remaining < minDue, apply a red blink class instead of yellow.

Add CSS classes, e.g. .blink-amount--warn (yellow) and .blink-amount--error (red). Respect prefers-reduced-motion: reduce.

Acceptance:

A payment row with leftover money blinks yellow; if that leftover can’t cover the smallest unpaid session, it blinks red. After reload, behavior persists.

D) Base Rate audit trail — move entry point & redesign dialog

Move the info button:

Remove the info button from SessionDetail.

Add the info button next to the “Base Rate” field title in the Billing tab (where base rate is shown/edited globally).

Dialog behavior changes (new fields & layout):

Footer buttons: Move Add button to the bottom-left of the Base Rate History dialog; Close stays bottom-right.

Add flow: Clicking Add opens a secondary modal (prompt) with:

New Rate (number)

Effective Date (date-only, Asia/Hong_Kong, default = “today” in HK time; no time input)

Storage:

Keep timestamp as the entry time (when the history row was created).

Store the chosen effective date as effectDate (timestamp) at 00:00:00 in Asia/Hong_Kong.

Ensure editedBy is captured on every entry (current user email; fallback 'unknown').

Columns shown: Replace the Timestamp column with Effective Date.

If effectDate is missing, show a blinking “–” and allow inline edit to set effectDate (again writing 00:00:00 in HK).

Remove the Edited By column; show editedBy in a tooltip when hovering the row or rate cell.

Timezone implementation:

Add Day.js with utc + timezone plugins (or equivalent) and set dayjs.tz.setDefault('Asia/Hong_Kong').

When writing effectDate, normalize to HK midnight: dayjs.tz(selectedDate, 'Asia/Hong_Kong').startOf('day').

Files:

components/StudentDialog/BaseRateHistoryDialog.tsx

components/StudentDialog/BillingTab.tsx (or wherever the Base Rate field title lives)

Remove Base-rate info button from SessionDetail.tsx

Add dayjs, dayjs-plugin-utc, dayjs-plugin-timezone

Acceptance:

Info button is in Billing tab, not Session detail.

Dialog has Footer Add (left) and Close (right).

Add flow uses a secondary prompt with New Rate + Effective Date; writes effectDate (HK midnight), timestamp (entry), and editedBy.

Table shows Effective Date; missing values blink “–” and are inline-editable.

Hover shows editedBy in tooltip.

E) Styling & a11y

Add/extend blink animation tokens:

.blink-amount--warn (yellow)

.blink-amount--error (red)

Wrap all motion in @media (prefers-reduced-motion: reduce) to disable animations.

F) Tests

Extend Cypress:

column_autofit spec still passes with the new min width.

New spec payment_blink_logic.cy.js:

seed one payment with remaining > 0 and another with remaining < min unpaid → assert yellow vs red classes.

base_rate_history.cy.js:

open dialog → Add → check new row shows effectDate (HK midnight of chosen date); tooltip reveals editedBy.
