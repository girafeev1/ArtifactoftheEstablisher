P-023 — Payments metadata & UI polish (headers, “For Session(s)”, sticky footer)

Save as: prompts/P-023.md
In this PR: Do not modify docs/Task Log.md.
PR comment: include the Context Bundle raw link (evergreen bot will attach on next PR as well).

Goals

Column headers vs value width

Allow headers to compress beyond label width: ellipsis header text, don’t block column squeeze.

Keep keyboard resize + autosize intact.

Payment History — “For Session(s)” truncation

Render at most 5 session numbers; if more, append just … (three dots), no count.

Sticky dialog footer

In Student dialog views where footers sit above the scroller, make the footer stick to the window bottom edge, not the scrollable area.

Payment metadata (Add Payment + listing + detail)

Add to Add Payment dialog:

Payment Method: dropdown: FPS, Bank Transfer, Cheque → save to payment doc field method: string.

Entity: dropdown: Music Establish (by ERL), Personal → save to entity: string (use ME-ERL for the first; Personal for the latter).

If Entity = ME-ERL: show two dependent dropdowns:

Bank and Bank Account.

Read from the Firestorm DB erl-directory (see Implementation) and populate:

Bank dropdown displays “{bank name} {bank code}”.

Bank Account dropdown displays each account’s accountType string (the internal identifier).

On Submit, set identifier on the payment doc to "{bankCode}/{accountDocId}".

Reference Number (free text) → save to refNumber: string.

Rename SAVE → Submit.

On submit, also stamp timestamp: Timestamp.now() and editedBy: <user email>.

Payment History table:

Rename columns:

Payment Made On → Payment Date

Amount Received → Amount

Add columns: Method, Entity (if entity is ME, display Music Establish (ERL)).

Payment Detail (selected payment):

Show all new fields in a two-column invisible grid (labels left, values right) with nice wrapping/ellipsis.

Implementation notes

A) Header width vs value width

In all tables that use useColumnWidths, ensure header cells ellipsis instead of forcing min width:

Header <TableCell>: white-space: nowrap; overflow: hidden; text-overflow: ellipsis;

Keep a title={label} for a11y.

Confirm autoSize() measures only body cells; if headers are included anywhere, exclude thead from the [data-col] query or add a data-col-header guard.

Keep clamps at 24–26px (P-021) and keyboard 8px steps.

B) “For Session(s)” truncation

In PaymentHistory.tsx, where you render the session indices, slice to 5, join with , , then append … if there were more than 5. Do not append “+N more”—just ….

C) Sticky footer

Make FloatingWindow (and dialog content wrappers) a flex column container with the scroller on the middle pane.

Apply:

Container: display:flex; flex-direction:column; height:100%

Scrollable content: flex:1; min-height:0; overflow:auto

Footer (DialogActions in this context): position: sticky; bottom: 0; z-index: 1; backdrop-filter: blur(2px); background: color-mix(in oklab, var(--paper, #fff), transparent 15%)

Ensure no nested scroller clips the footer.

D) ERL Directory (banks)

Add lib/erlDirectory.ts:

Export dbDirectory = getFirestore(app, 'erl-directory') (web v9: initializeFirestore(app, { databaseId: 'erl-directory' })).

Build an accessor that supports two shapes to avoid blocking:

Preferred: banks/{bankCode} docs (fields: name, code) with subcollection accounts/{accountDocId} (fields: accountType, etc.).

Legacy: bankAccount/{bankCode}/accounts/{accountDocId} (if that’s what exists).

Try Preferred; if 404/permission, fall back to Legacy. If both fail, surface a non-blocking UI notice: “Bank directory unavailable (check permissions)”.

Add types and small cache to avoid refetch on every open.

E) Payment writes

Extend PaymentModal submit to write:

method, entity, conditional identifier, refNumber, timestamp, editedBy.

Update PaymentHistory query mapping to include/format new columns.

Confirm blink logic still uses Amount cell (class is on cell or inner span).

F) Tests

Unit:

Header truncation util (if added) and “For Session(s)” formatter.

Guard that identifier only writes when entity = ME-ERL and both selects are chosen.

E2E:

Add Payment → choose ME-ERL → pick Bank + Account → verify new fields in list & detail.

Footer sticks while scrolling long content.

Acceptance

Header labels ellipsis; columns can compress beyond label width.

“For Session(s)” shows at most five numbers then … when there are more.

Footer is stuck to the bottom of the dialog window on long pages.

Add Payment captures Method, Entity, optional Bank/Account (ME-ERL), Reference Number; writes timestamp and editedBy.

Payment list shows Payment Date, Amount, Method, Entity; detail shows a two-column summary.

ERL directory error doesn’t block Add Payment; a friendly message appears if the directory can’t be read.

Likely files to touch

components/StudentDialog/PaymentModal.tsx (new fields + writes)

components/StudentDialog/PaymentHistory.tsx (columns rename/add, “For Session(s)” truncation)

components/StudentDialog/PaymentDetail.tsx (two-column layout)

components/StudentDialog/*Tab*.tsx, styles/studentDialog.css (header ellipsis + sticky footer)

lib/erlDirectory.ts, lib/firebase.ts (db init)

lib/billing/* (formatter helpers if you add them)

cypress/e2e/* + a few unit tests

PR checklist

Context Bundle attached

No edits to docs/Task Log.md

Reduced-motion safe

Tests updated/added

FINISH ALL TASKS AND DO NOT STOP UNTIL YOU DO
