# P-027-06r — Add Payment **dialog** cascade UI (Entity→Bank→Account) + exact 3-dots alignment + real Cypress checks

## Save path
prompts/p-027-06r.md

## Branch & PR
- Branch: codex/finish-add-payment-modal-cascade-06r
- PR title: feat(payment): Add Payment dialog cascade UI (Entity→Bank→Account), identifier writes, exact 3-dots alignment; real E2E (P-027-06r)
- Labels: payments, ui, codex
- Do NOT modify CI/Actions, deploy configs, or docs/Task Log in this prompt.

## Background
Badge shows **P-027-05r** and sessions sorting scaffolding exists. However:
- The **Add Payment dialog** still lacks the visible **Entity → Bank → Bank Account** dependent selects.
- Selecting “Entity” doesn’t trigger the cascade behaviors (clear/hide; dependent loads; validation).
- **3-dots settings** button still isn’t aligned to the **same baseline** as the **Service Mode** button within the card (and must stay inside the white card).

## Deliverables

### A) Add Payment **dialog**: visible cascade UI + behaviors
Implement in the Add Payment modal (not only in detail view).

Controls (all **controlled** with state and test ids):

1) **Method** select — options: `FPS`, `Bank Transfer`, `Cheque`
   - Writes `method: string`
   - `data-testid="method-select"`

2) **Entity** select — options: `Music Establish (ERL)`, `Personal`
   - Writes `entity: string`
   - On change to **Personal**:
     - Hide Bank + Bank Account controls
     - **Clear** `bankCode`, `accountDocId`, and `identifier`
   - On change to **ERL**:
     - Show Bank control and load options
   - `data-testid="entity-select"`

3) **Bank** select (visible only when `entity === 'Music Establish (ERL)'`)
   - Options from ERL directory:
     - Prefer schema `banks/{bankCode}`; fallback to legacy `bankAccount/{bankCode}/accounts/*`
   - Label each as **`{bankName} {bankCode}`**, fallback **`{docId} {collectionId}`** if missing
   - Writes `bankCode`
   - `data-testid="bank-select"`

4) **Bank Account** select (visible only when ERL **and** a Bank is chosen)
   - Options from the selected bank:
     - Label **`accountType`**, value **`accountDocId`**
   - Writes `accountDocId`
   - `data-testid="bank-account-select"`

5) **Reference Number** input
   - Writes `refNumber: string`
   - `data-testid="ref-input"`

6) **Submit** button (rename from Save if not already)
   - Disabled until required fields valid:
     - Always: `method`, `entity`
     - If ERL: `bankCode` and `accountDocId`
   - On submit:
     - If ERL, compute **`identifier = "${bankCode}/${accountDocId}"`**
     - If user-entered identifier exists but fails `/^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/`, recompute from bank/account
     - Also stamp **`timestamp`** and **`editedBy`**
   - `data-testid="submit-payment"`

> Use existing `lib/erlDirectory.ts` helpers; if missing pieces, add:
> `listBanks(): Promise<Array<{ bankCode: string; bankName?: string }>>`
> `listAccounts(bankCode: string): Promise<Array<{ accountDocId: string; accountType?: string }>>`
> with graceful fallback between schemas. No secrets in code.

### B) 3-dots settings button — exact alignment in card
Goal: **same horizontal baseline** as **Service Mode** within the **white card**, never in the sidebar.

- Ensure the **card** is the containing block (`position: relative`).
- Create a **card footer row** inside the card:
  - `display:flex; align-items:center; justify-content:space-between; gap:12px;`
  - Left: 3-dots; Right: Service Mode
- Footer row may be **sticky inside the card** (`position: sticky; bottom: 0;`) if needed; it must not anchor to page/sidebar.
- Test ids:
  - `data-testid="card-footer-row"`
  - `data-testid="settings-3dots"`
  - `data-testid="service-mode-btn"`

**Acceptance for alignment:** bounding-rect baselines of `settings-3dots` and `service-mode-btn` are equal (±1px), and the left coordinate of `settings-3dots` is **≥ card padding** (i.e., inside the white card, never in sidebar).

### C) Non-regression
- Keep the **badge** rendered once (no duplicates). It should already display the auto-detected latest prompt id.
- Keep **sessions sorting** intact (headers toggle; `aria-sort` updates; persists).

## Tests (no placeholders)

### Unit
- Identifier normalizer (valid/invalid → recompute).
- ERL label builders + schema fallback.

### Cypress / component
1) **Cascade UI presence**
   - Open Add Payment dialog
   - Assert existence of: `method-select`, `entity-select`
   - Choose `entity = "Music Establish (ERL)"` → `bank-select` appears with ≥1 option
   - Choose a bank → `bank-account-select` appears with ≥1 option

2) **Cascade behaviors**
   - With ERL selected, pick bank + account, fill `ref-input`, pick `method`, click `submit-payment`
   - Intercept write call (spy on the payment create/update) and **assert payload** includes:
     - `method`, `entity`, `bankCode`, `accountDocId`
     - `identifier = bankCode/accountDocId`
     - `refNumber`, `timestamp`, `editedBy`

3) **Personal clears**
   - Switch `entity` to **Personal**
   - Assert `bank-select` and `bank-account-select` **not visible**
   - Submit: payload **does not** contain `bankCode`, `accountDocId`, and `identifier` is either empty or absent (no forced compute)

4) **Alignment**
   - On the card page, assert `settings-3dots` and `service-mode-btn` share baseline within 1px
   - Assert `settings-3dots` left x ≥ card inner left x (inside card padding)

> If CI lacks GUI deps, guard with conditional skip; but keep these specs committed with **real assertions**. Do not edit workflows.

## Acceptance
- Add Payment **dialog** shows Entity/Bank/Account selects with dependent loading & validation
- Submit writes all required fields and computed identifier; Personal path clears ERL fields
- 3-dots and Service Mode share baseline inside the **card**; 3-dots never drifts into sidebar
- No duplicate badge; sessions sorting remains; no new TS errors

