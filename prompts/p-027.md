# P-027 — Finish Add Payment cascade + sticky Back + single Remaining blink + stable assignment

**Save this prompt exactly at:** `prompts/p-027.md`
**Branch:** `codex/finalize-add-payment-cascade-p027`
**PR title:** `feat(payment): Add Payment cascade (Entity→Bank→Account), sticky Back, single Remaining blink, stable assignment (P-027)`
**Labels:** `payments`, `ui`, `codex`
**Rules:** Do **not** modify CI/Actions or deployment settings. Do **not** touch Task Log in this prompt.

## Background (what’s still missing)

* **Add Payment cascade UI** is not fully implemented (Entity → Bank → Bank Account).
* **Back** control is not consistently inside the **sticky footer**.
* **Remaining** sometimes renders twice (blink/flicker).
* **Assignment section** can still disappear without a persistent shell/zero-state in some flows.
* List view “For Session(s)” column exists; keep it intact.

---

## What to build

### A) Sticky footer & Back placement (StudentDialog)

* Render the **Back** control **inside** the dialog’s sticky footer/action bar (same container as primary actions).
* Ensure the **dialog body** is the scroll container. Add **bottom padding** equal to the footer height so content isn’t obscured.
* Footer CSS (adapt to stack):

  * `position: sticky; bottom: 0; z-index: 10;`
  * `border-top: 1px solid var(--mui-palette-divider);`
  * `box-shadow: 0 -2px 8px rgba(0,0,0,.04);`
  * `background: inherit;`

### B) Remaining blink — single element only

* **Payment Amount** must never blink.
* **Remaining** must render **once** using the blink class; remove any duplicate span/fragment that causes double-blink/flicker.
* Respect reduced-motion prefs.

### C) Session assignment list — always visible & functional

* Keep a **persistent container** (zero-state when rows are 0) so the section never disappears during loading/filters.
* Selecting/unselecting sessions updates **Remaining** immediately and persists via the **existing hooks/services**.

### D) **Add Payment** dialog — full cascade + writes

Implement the UI and data writes exactly as follows:

1. **Payment Method** dropdown — options: `FPS`, `Bank Transfer`, `Cheque`

   * Save to `method: string`.

2. **Entity** dropdown — options: `Music Establish (ERL)`, `Personal`

   * Save to `entity: string` (use the label text).

3. If **Entity = "Music Establish (ERL)"**:

   * **Bank** dropdown:

     * Fetch banks from the ERL directory DB. Prefer structure `banks/{bankCode}`, fallback legacy `bankAccount/{bankCode}/accounts/*`.
     * Label each option as **`{bankName} {bankCode}`**, fallback **`{docId} {collectionId}`** if missing.
     * Save chosen `bankCode`.
   * **Bank Account** dropdown (dependent on Bank):

     * List sub-collection accounts for the chosen bank.
     * Label with each account’s **`accountType`**.
     * Save chosen **`accountDocId`**.
   * On **Submit**, compute & write **`identifier = "{bankCode}/{accountDocId}"`**.

4. **Reference Number** input → save to **`refNumber: string`**.

5. Rename **Save** → **Submit**.

6. On **Submit**, also stamp **`timestamp`** and **`editedBy`**.

7. **Normalization guard**: if a user-entered `identifier` exists but **doesn’t** match `/^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/`, **recompute** from `{bankCode}/{accountDocId}` before write.

#### Data access notes

* Use any existing ERL directory reader; otherwise add a small `lib/erlDirectory.ts` with typed helpers to fetch banks/accounts with graceful fallback between the two shapes above.
* No secrets in code; rely on existing runtime config.

### E) Payment History (list) — keep “For Session(s)”

* Ensure the column remains present and displays up to **5** ordinals; if more, append a trailing `…`.
* Keep header ellipsis behavior and resizers intact.

### F) A11y & UX polish

* Keyboard navigation for all new selects (focus ring, ARIA labels).
* Reduced-motion respected for blinks/transitions.

---

## File hints (search/adapt)

* `components/StudentDialog/PaymentModal.tsx` (all cascade UI and submit logic)
* `components/StudentDialog/PaymentDetail.tsx` (blink class, single render; assignment shell/zero-state)
* `components/StudentDialog/PaymentHistory.tsx` (verify “For Session(s)” column; header ellipsis intact)
* `styles/studentDialog.css` (footer stickiness/shadow)
* `lib/erlDirectory.ts` (add if missing; banks+accounts fetch, typed)

---

## Tests

### Unit

* `lib/payments/format.test.ts` — keep/build on `buildIdentifier` (valid, invalid → recompute).
* `lib/payments/truncate.test.ts` — already exists; ensure still green.
* If new helpers added for ERL fetch/transform, add light unit tests with mocked data.

### E2E / Component (Cypress)

* **Sticky Back**: Back renders in sticky footer; remains visible while body scrolls.
* **Remaining blink**: only Remaining blinks when selection changes; Payment Amount never blinks.
* **Assignment**: zero-state visible; selecting a session updates Remaining and persists.
* **Add Payment cascade**: choose Entity=ERL → pick Bank → pick Bank Account → Submit → verify document has `method`, `entity`, `bankCode`, `accountDocId`, `identifier`, `refNumber`, plus `timestamp`, `editedBy`.
* **List “For Session(s)”**: shows ≤5 ordinals with trailing `…` when more exist.

> Keep specs committed. If CI lacks GUI deps, guard with conditional skip; **do not** edit workflows.

---

## Acceptance criteria (self-check)

* [ ] Back control sits inside sticky footer; footer sticks to window edge on all StudentDialog screens.
* [ ] Remaining uses a **single** blinking element; Payment Amount is static.
* [ ] Assignment section has a persistent shell (zero-state) and works end-to-end.
* [ ] Add Payment cascade fully implemented; correct writes & normalization; audit fields present.
* [ ] Payment History list shows “For Session(s)” ≤5 + `…`.
* [ ] No new TypeScript errors; existing tests pass; new tests added.

---

## Save this prompt

Create **exactly** `prompts/p-027.md` and copy this prompt’s full text into it (no renames).
