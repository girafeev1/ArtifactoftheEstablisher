# P-027-07r — Rebase & resolve conflicts, remove stray test page, ship Add Payment dialog cascade UI, align 3-dots, keep single badge, finish sessions sorting

## Save path
prompts/p-027-07r.md

## Branch & PR
- Branch: codex/finalize-add-payment-cascade-and-alignments-07r
- PR title: feat(payment): resolve conflicts, remove stray test page, Add Payment dialog cascade UI, 3-dots alignment, single badge, sessions sorting (P-027-07r)
- Labels: payments, ui, codex
- Do NOT modify CI/Actions or deployment settings.

## 0) Rebase & conflict policy (first step)
- Rebase this branch onto latest `main`.
- If conflicts on **docs/context/PR-*.md** → prefer `main` (keep the archived context as-is).
- If conflicts on **docs/Task Log.md** → keep `main` and reapply ONLY necessary status tweaks in a separate docs PR later (do not touch Task Log here).
- If conflicts on **prompts/** → keep both files by preserving `main` content and re-adding THIS prompt as `prompts/p-027-07r.md`.
- No other docs changes in this PR.

## 1) Remove stray test page
- Delete any dev/test page accidentally added (e.g., `pages/test/coaching-sessions*.tsx`, `pages/*coaching-sessions-test*.tsx`).
- Ensure no route exists that is not part of the product.
- Commit: "chore(ui): remove stray test coaching-sessions page"

## 2) Add Payment **dialog** — VISIBLE cascade UI + behaviors (Entity → Bank → Account)
Implement in the **Add Payment modal** (not only in detail view).

Controls (controlled, with test ids):
- **Method** select: options `FPS`, `Bank Transfer`, `Cheque` → writes `method`  
  `data-testid="method-select"`
- **Entity** select: `Music Establish (ERL)` | `Personal` → writes `entity`  
  `data-testid="entity-select"`
  - On **Personal**: hide Bank/Account and **clear** `bankCode`, `accountDocId`, `identifier`.
  - On **ERL**: show Bank select.
- **Bank** select (visible only if ERL): list ERL banks; label `{bankName} {bankCode}` (fallback `{docId} {collectionId}`) → writes `bankCode`  
  `data-testid="bank-select"`
- **Bank Account** select (visible only when ERL AND a bank chosen): list accounts for that bank; label `accountType`, value = `accountDocId` → writes `accountDocId`  
  `data-testid="bank-account-select"`
- **Reference Number** input → writes `refNumber`  
  `data-testid="ref-input"`
- **Submit** (rename from Save if needed)  
  `data-testid="submit-payment"`
  - Disable until required fields valid (always: `method`, `entity`; if ERL: `bankCode` & `accountDocId`).
  - On submit:
    - If ERL: set **`identifier = "${bankCode}/${accountDocId}"`**.
    - If a user-entered identifier exists but fails `/^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/`, recompute from bank/account.
    - Also stamp **`timestamp`** and **`editedBy`**.

Use/extend `lib/erlDirectory.ts`:
- `listBanks(): Promise<Array<{ bankCode: string; bankName?: string }>>`
- `listAccounts(bankCode: string): Promise<Array<{ accountDocId: string; accountType?: string }>>`
Gracefully handle both schemas (`banks/{bankCode}` new vs `bankAccount/{bankCode}/accounts/*` legacy). No secrets in code.

## 3) 3-dots settings button — align with Service Mode on SAME baseline inside card
- The white **card** is the containing block (`position: relative`).
- Add a **card footer row** inside the card:
  `display:flex; align-items:center; justify-content:space-between; gap:12px;`
  - Left: 3-dots → `data-testid="settings-3dots"`
  - Right: Service Mode → `data-testid="service-mode-btn"`
- The footer row may be `position: sticky; bottom: 0;` **inside the card**.
- Acceptance: baselines of 3-dots and Service Mode are equal (±1px); left x of 3-dots ≥ card inner left (never in sidebar).

## 4) Badge — render exactly once
- Keep the tiny Nunito/200 badge but **only in card view** (top-right).
- Remove any TopBar duplicate.  
  `data-testid="pprompt-badge-card"`

## 5) Remaining blink — single element (non-regression)
- **Payment Amount** never blinks.
- **Remaining** renders once with blink class; expose `data-testid="remaining-amount"`.
- Respect reduced-motion.

## 6) Sessions tab — sorting polish (non-regression)
- Headers toggle asc/desc; `aria-sort` reflects state.
- Persist sort per user; keep min-width/ellipsis/resizers unchanged.

## Tests (no placeholders)
### Unit
- Identifier normalizer (valid/invalid → recompute).
- ERL label builders + schema fallback.
- Sessions comparators.

### Cypress / component
1) **Cascade UI presence**: open Add Payment → assert `method-select`, `entity-select`. Choose ERL → `bank-select` appears with ≥1 option. Choose bank → `bank-account-select` appears with ≥1 option.
2) **Cascade behaviors**: pick method, ERL, bank, account, ref; submit → assert write payload includes `method`, `entity`, `bankCode`, `accountDocId`, `identifier = bankCode/accountDocId`, `refNumber`, `timestamp`, `editedBy`.
3) **Personal clears**: switch entity to Personal → bank/account selects hidden; submit payload lacks `bankCode`/`accountDocId`; identifier not forced.
4) **Alignment**: on card page, 3-dots and Service Mode share baseline within 1px and 3-dots left x ≥ card inner left.
5) **Badge**: single `pprompt-badge-card` present; no duplicate elsewhere.
6) **Blink**: only `remaining-amount` blinks on selection change; amount static.
7) **Sorting**: header click toggles sort; `aria-sort` updates; order changes; preference persists across reload.

## Acceptance
- Rebase complete; conflicts resolved per policy; no doc churn.
- Stray test page removed.
- Add Payment dialog shows real cascade UI & behaviors; correct writes.
- 3-dots aligned with Service Mode on same baseline inside card.
- One badge only; single-element Remaining blink; sessions sorting intact.
- No new TypeScript errors.
