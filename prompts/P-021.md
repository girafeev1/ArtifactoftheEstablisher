Housekeeping: Update (overwrite) prompts/P-021.md with this exact content.
In this PR: Do not edit docs/Task Log.md.
PR comment: Include a Context Bundle link (raw URL) as usual.

Goals (no numbering changes needed in Task Log yet)
    • Loading UX: remove title/label spinners/text; show a blinking “–” in the value area while pending (respect prefers-reduced-motion).
    • Card Due must always match the dialog; use consistent loading fallback (no stale values).
    • Session Vouchers column hidden by default (still togglable/persisted per user).
    • Payment History amount cell blinks yellow if remainingAmount > 0, and red if remainingAmount < minUnpaidRate (computed from outstanding sessions).
    • Base Rate History:
    • Move Add button to footer-left; Close remains right.
    • Add sub-dialog with New Rate (HKD) and Effective Date (date-only, default to “today” in Asia/Hong_Kong, stored at 00:00:00 HK).
    • Allow edit (rate + effective date).
    • If an entry lacks effectDate, show blinking “–” in that cell with inline fix affordance.
    • Keep “Rate (HKD)” column name and currency formatting; keep tooltip “Edited by … on …”.
    • Relocate the info icon/entry point from Session Detail → to Billing tab’s Base Rate field label.
    • Column min-width: lower clamp to ~24–26 px with ellipsis + title tooltips + keyboard left/right resize preserved.
    • Calendar scan: now that env is sorted, harden incremental/full rescan paths and ensure Calendar deletes propagate; surface API errors in UI.

Scope

Web app + our Next API + Apps Script where needed. Keep the Task Log out of this PR.

Implementation notes & acceptance

A) Loading UX (blink “–”, no label spinner)
    • Remove any spinner/“Loading” in labels (e.g., Total Sessions line).
    • Render the value as a blinking “–” while pending.
    • Respect prefers-reduced-motion: fall back to a static, subdued “–”.
    • Acceptance: All previously spinnered label areas now have static labels; values show blinking/stationary “–” until data resolves.

B) Card “Due” = dialog “Balance Due”
    • Cards prefer cached.billingSummary.balanceDue (fallback to legacy field only if needed).
    • During load, show the same blinking “–”.
    • When useBilling resolves, ensure both surfaces match exactly (avoid stale reads).
    • Acceptance: After payment/rate/voucher/retainer changes, card Due == dialog Due. While loading, both show “–”.

C) Vouchers column default hidden
    • In SessionsTab, exclude “Session Vouchers” from default visible columns.
    • Keep toggle in Columns/Filters; persist per user via existing storage.
    • Acceptance: Fresh user sees it hidden; toggling persists.

D) Payment blink: yellow / red
    • In Payment History table Amount Received cell:
    • Yellow blink when remainingAmount > 0.
    • Red blink when remainingAmount < minUnpaidRate.
    • Implement a small helper to compute minUnpaidRate from unpaid sessions (ignoring those covered by vouchers/retainers).
    • Respect reduced-motion with static warning/error colors.
    • Acceptance: Visual matches logic; RM users see non-animated states.

E) Base Rate History UX & editing
    • Move Add to footer-left; opens sub-dialog with:
    • New Rate (HKD) (number),
    • Effective Date (date only), default today in HK, stored as HK midnight.
    • Edit: allow updating rate and effective date on existing rows.
    • If an entry lacks effectDate, show blinking “–” and allow inline date fix.
    • Keep timestamp as entry time; ensure editedBy is written for every entry.
    • Relocate the info icon to Billing tab’s Base Rate label (remove from Session Detail).
    • Acceptance: New/edit flows work; sessions pick base rate by effectDate; missing dates can be corrected inline; tooltips show “Edited by … on …”.

F) Column min-width v3
    • Clamp min width to ~24–26 px; apply white-space: nowrap; overflow: hidden; text-overflow: ellipsis; and title attributes.
    • Ensure keyboard resizing still steps left/right cleanly (e.g., 8px steps).
    • Acceptance: Tables can compress further without layout breaks; sticky ordinal remains readable.

G) Calendar rescan hardening
    • Next API /api/calendar-scan: surface error strings (401/500/missing env) to a toast/Snackbar.
    • UI: show human-readable reason on failure.
    • Apps Script: if sync token 410, clear token and full resync; ensure cancellation/deletion events remove/mark sessions and recompute summaries.
    • Optionally store a tiny ScanLogs (last N runs) to assist troubleshooting; show last result/time as a small caption in the Tools menu.
    • Acceptance: Incremental and Full Rescan succeed; Calendar deletions reflect in the app; failures are clearly shown.

Tests
    • Unit: minUnpaidRate calc; base-rate selection by effectDate; min-width keyboard stepper.
    • E2E: vouchers column default hidden; Base Rate add/edit; rescan error surfaces.

Files to touch (likely)
    • components/StudentDialog/* (Overview/Sessions/PaymentHistory/BaseRateHistoryDialog + Billing tab entry point)
    • pages/dashboard/businesses/coaching-sessions.tsx
    • lib/billing/* (minUnpaidRate helper if placed here)
    • lib/useColumnWidths.ts, styles/*
    • pages/api/calendar-scan.ts (+ Apps Script scan where needed)

PR checklist
    • Overwrite prompts/P-021.md with this content.
    • Add Context Bundle and link it in the PR comment.
    • No Task Log edits here.
    • Tests updated where meaningful.
