P-021 — Loading UX, card due parity, vouchers column default, payment blink, base rate history UX & edit, column min-width v3, calendar scan reliability

Save this exact prompt to: prompts/P-021.md
Do not modify docs/Task Log.md in this PR. Include a Context Bundle in the PR comment (what/why/files/test steps + screenshots/GIFs).

Goals (maps to T-055…T-065)
1. Replace title-line spinners with a blinking “–” in the value area (respect reduced-motion).
2. Due parity: card “Due” must match dialog; robust loading fallback—no mismatches.
3. Hide “Session Vouchers” column by default (user-toggle, persisted per user).
4. Payment History blink: yellow if remaining>0; red if remaining < minUnpaidRate.
5. Base Rate History UX: move Add to footer-left; show sub-dialog (New Rate, Effective Date at HK midnight); allow edit of rate/effective date; inline fix for missing dates; keep “Rate (HKD)” & tooltips.
6. Column min-width v3: allow ~24–26 px minimum with ellipsis + a11y tooltip; keep keyboard left/right resize.
7. Calendar scan reliability: fix Incremental/Full rescan; surface errors in UI; verify delete propagation; handle 410 sync token.

⸻

A) Loading UX: spinner → blinking dash
• In places currently showing “Loading” or spinners in the label (e.g., Total Sessions:), remove the spinner from the label.
• Render the value as a blinking “–” while data is pending.
• Respect prefers-reduced-motion: use a static subtle color instead of blink.
• Likely files: components/StudentDialog/OverviewTab.tsx, any other fields that currently append spinners to labels.

Acceptance: While loading, the label text is stable; the value shows a blinking “–” (or static subdued “–” for reduced motion).

⸻

B) Card “Due” parity & loading fallback
• Cards: prefer cached.billingSummary.balanceDue (fall back to legacy billingSummary).
• While billing is loading, show the same blinking “–”.
• If useBilling is available but slow, don’t print stale mismatched values; once it resolves, both card and dialogs must match.
• Add a tiny “last updated” timestamp in state (not shown in UI) so we can compare/debug freshness if needed.

Acceptance: After any payment/rate/voucher/retainer change, card “Due” equals dialog “Balance Due” without divergence; during load it’s just “–”.

⸻

C) Session Vouchers column default
• In SessionsTab, do not include “Session Vouchers” in the default visible columns.
• Keep it togglable via the existing Columns/Filters menu; persist per user via localStorage (consistent with other columns).

Acceptance: Fresh user sees the column hidden by default; toggling persists.

⸻

D) Payment History blink logic
• Table row Amount Received cell:
• Yellow blink when remainingAmount > 0.
• Red blink when remainingAmount < minUnpaidRate, where minUnpaidRate is computed from unpaid sessions not covered by vouchers/retainers.
• Add a reduced-motion fallback (no blink; static warn/error color).
• Add a small unit util to compute minUnpaidRate so we can test it.

Acceptance: Visual states match logic; reduced-motion renders static styles.

⸻

E) Base Rate History UX & editing
• Move “Add” button into the dialog footer (left), Close stays right.
• Clicking Add opens a sub-dialog with:
• New Rate (HKD) (number) and
• Effective Date (date-only), default today in Asia/Hong_Kong; store at 00:00:00 HK.
• Row editing: affordance to edit rate and effective date.
• If an entry lacks effectDate, display a blinking “–” in that cell; clicking allows inline date edit.
• Persist fields: rate, effectDate (HK midnight), keep timestamp as entry time, editedBy (current user email).
• Keep existing “Rate (HKD)” label and currency formatting; keep “Edited by … on …” tooltip.

Acceptance: Add/edit workflows work; sessions derive base rate from effectDate correctly; missing dates can be fixed inline.

⸻
F) Column min-width v3
• Lower the clamp from 30 → 24 px (with caution):
• Cells must use white-space: nowrap; overflow: hidden; text-overflow: ellipsis; and set title for a11y.
• Resizer handle keeps keyboard left/right (8px steps).
• Validate sticky ordinal column remains readable.

Acceptance: Columns can squeeze further without layout breakage; keyboard resize still works.

⸻

G) Calendar scan reliability (incremental/full + deletes)
• Next API (/api/calendar-scan): log and bubble upstream errors (401, 500, etc.) to the UI toast/snackbar. Include whether CALENDAR_SCAN_URL or SCAN_SECRET is missing.
• UI Tools menu: show success/failure reason strings from the API response.
• Apps Script: verify X-Scan-Secret check; if sync token is 410, clear token and perform a full resync.
• Ensure deletes/cancellations from Calendar propagate: when Google returns a cancelled event, mark or delete the related session appropriately and recompute summaries.
• Add an optional ScanLogs collection (last N entries) and display the latest result/time in the UI (small caption in Tools menu).

Acceptance: Incremental and full rescan both work; deleted events are reflected in the app; UI shows clear success/failure messages.

⸻

Tests
• Unit: blink logic thresholds; base-rate selection by effectDate; min-width keyboard resize util.
• E2E/Cypress: vouchers column default hidden; Add/Edit Base Rate flows; rescan error surfacing.

⸻

Files you’ll likely touch
• components/StudentDialog/OverviewTab.tsx, SessionsTab.tsx, PaymentHistory.tsx, BaseRateHistoryDialog.tsx (+ small Add/Edit sub-dialogs)
• pages/dashboard/businesses/coaching-sessions.tsx (card due parity)
• lib/billing/* (minUnpaidRate helper if placed here)
• lib/useColumnWidths.ts, styles/* (min-width v3)
• pages/api/calendar-scan.ts (error surfacing), GAS script (410/full resync & deletes)
• Optional: components/Tools/* or wherever the menu lives (scan logs/status caption)

⸻

PR checklist
• Context Bundle with before/after & test steps.
• Respects prefers-reduced-motion.
• No changes to docs/Task Log.md.
• Add/updated tests where meaningful.

⸻
Make sure that you've worked on all tasks and list out the tasks you've completed here after you've finished them
