# P-016 — Autosize columns, session totals parity, balance due source, modal stacking fix, base rate audit, scan security/timezone

## Goals
1) Double-click autosize for table columns (Sessions, Retainers, Payments).
2) Show **Total Sessions** including cancelled/proceeded (as it used to).
3) Make **Balance Due** consistent between card view and dialog by using the **same** source of truth.
4) Fix dialog stacking so “Add Payment” (and similar) never hides behind the Student dialog.
5) Add **Base Rate** audit trail (view & add) incl. `editedBy`.
6) GAS: set proper timezone and secure the scan endpoint with a shared secret.

---

## 1) Column autosize on double-click
- File: `lib/useColumnWidths.ts`
  - Add an `autoSize(key: string, rootEl: HTMLElement)` function that:
    - Measures header cell text width **and** all visible body cells for that column (use a hidden off-screen measurer or temporarily set `width: auto` on clones).
    - Adds padding for cell gutters + a small buffer (e.g. +16–24px).
    - Clamps between 60 and 600.
    - Updates `widths[key]` and persists to localStorage as today.
  - Export `onDblClick` handler: `dblClickResize(key, e)` → calls `autoSize`.
- Files:
  - `components/StudentDialog/SessionsTab.tsx`
  - `components/StudentDialog/RetainersTab.tsx`
  - `components/StudentDialog/PaymentHistory.tsx`
    - On each `.col-resizer` add `onDoubleClick={(e) => dblClickResize('<colKey>', e)}`.
- Acceptance:
  - Double-clicking a lever snaps to fit widest visible content; drag still works; persisted per user/table.

## 2) Total Sessions parity (include cancelled/proceeded)
- File: `components/StudentDialog/SessionsTab.tsx`
  - When computing `summary.totalSessions`, **do not** exclude cancelled/proceeded. Count all sessions in the time window (as before).
  - Optional (nice to have): in the header summary row, show a small breakdown:  
    `Total Sessions: N  •  Cancelled: C  •  Proceeded: P`
- Acceptance:
  - Count matches the old behavior; cancelled/proceeded no longer disappear from the total.

## 3) Balance Due single source of truth
- Preferred source: `useBilling(abbr, account)` summary (computed live) **or** a single canonical summary doc that `writeSummaryFromCache` always updates.
- File: `pages/dashboard/businesses/coaching-sessions.tsx`
  - Replace reliance on `Students/{abbr}.billingSummary.balanceDue` if it lags. Either:
    - a) Use `useBilling` for each card (batched or lazy on expand), OR
    - b) Read `Students/{abbr}/Billing/Summary` (single doc) that is updated whenever sessions/payments/retainers change.
- Ensure `writeSummaryFromCache(qc, abbr, account)` is called on **every** mutation path that affects money:
  - Already present in: payment assignment, voucher mark/unmark, retainer payment; verify in `SessionDetail`, `PaymentDetail`, retainer flows.
- Acceptance:
  - Card “Due” and dialog “Balance Due” always match after any change; no “—” unless truly loading.

## 4) Modal stacking audit (Payment/Retainer and peers)
- Convert custom overlays to true MUI `Dialog` or ensure portal + higher z-index:
  - Files:
    - `components/StudentDialog/PaymentModal.tsx` (ensure it is a MUI `Dialog` with `open`/`onClose` and **portals to body**).
    - `components/StudentDialog/RetainerModal.tsx` (same).
  - If keeping custom overlay, wrap content in `<Portal container={document.body}>` and set `z-index` above the parent Dialog (>= `theme.zIndex.modal`, e.g. 1500).
- Theme:
  - File: `lib/theme.ts`
    - We already set Popper/Menu containers; add explicit `zIndex: { modal: 1500 }` if needed.
- Acceptance:
  - “Add Payment” and similar dialogs never appear beneath the Student dialog; keyboard focus is correct.

## 5) Base Rate audit trail
- UI:
  - In `SessionDetail.tsx`, next to **Base Rate**, add an `IconButton` (info icon). Clicking opens `BaseRateHistoryDialog`.
- New: `components/StudentDialog/BaseRateHistoryDialog.tsx`
  - Lists entries sorted desc: `{ rate: number, timestamp: Timestamp, editedBy: string }`
  - “Add entry” allows setting a rate (number) → writes a new doc with `editedBy = session.user.email || 'unknown'`.
- Data:
  - Collection path proposal: `Students/{abbr}/BaseRateHistory` (per student). If per account, include `account` in path or as a field.
- Acceptance:
  - View shows history; adding creates a new entry with `editedBy` captured.

## 6) Apps Script hardening (timezone + secret)
- File: `apps-script/CONFIG.gs`
  - Set `TIMEZONE` to `'Asia/Hong_Kong'` **or** compute from `Session.getScriptTimeZone()` if accessible; otherwise make it a Script Property and read it.
- Security (Apps Script):
  - In `ScanEndpoint.gs#doPost`, require header `X-Scan-Secret`. Compare with a Script Property `SCAN_SECRET`; reject missing/mismatched.
- Next.js API:
  - File: `pages/api/calendar-scan.ts`
    - Read `process.env.SCAN_SECRET` and send `X-Scan-Secret` header to GAS.
- Docs / env:
  - File: `.env.local.example` (or README)
    ```
    CALENDAR_SCAN_URL="https://script.google.com/macros/s/AKfycbzESImrT9yROHCEq0HFM70mGNLd_x-HYT-nJ1E9X_urFxxOPKi3XYqHZW79bGk3tqgFZA/exec"
    SCAN_SECRET="choose-a-long-random-string"
    ```
- Acceptance:
  - Scan fails with 401 if secret absent/wrong; successful otherwise. Timestamps formatted for HK.

## Regression checklist
- Column drag/resize still works and persists.
- Payments “Amount Received” still blinks when remaining > 0 / none assigned (both list + detail).
- Sticky footers intact; sticky ordinal column intact.
- “For Session(s)” still shows # ordinals.
