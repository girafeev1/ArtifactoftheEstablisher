# P-027-01r — Finish Payment UX + Add Payment cascade (first revise)

## Save path
prompts/p-027-01r.md

## Branch & PR
- Branch: codex/finalize-payment-ux-and-functionality-enhancements-01r
- PR title: feat(payment): sticky Back, single Remaining blink, stable assignment, Add Payment cascade (P-027-01r)
- Labels: payments, ui, codex
- Do NOT edit CI/Actions or Task Log in this prompt.

## Background
List “For Session(s)” and some identifier writes landed. Missing from live app:
- Back not inside sticky footer.
- Remaining sometimes double-renders (blink/flicker).
- Assignment section can disappear; needs persistent shell/zero-state.
- **Add Payment** cascade UI (Entity→Bank→Account) not implemented.

## Tasks

### A) Sticky footer & Back
- Render **Back** inside the dialog’s sticky footer/action bar.
- Make dialog **body** the scroll container; add bottom padding = footer height.
- Footer style: `position: sticky; bottom: 0; z-index: 10; border-top: 1px solid var(--mui-palette-divider); box-shadow: 0 -2px 8px rgba(0,0,0,.04); background: inherit;`.

### B) Remaining blink — single element
- **Payment Amount** never blinks.
- **Remaining** renders **once** with the blink class; remove any duplicate span/fragment.

### C) Session assignment — always visible & functional
- Keep the assignment section mounted with a **zero-state** when rows are 0 (loading/filters).
- Selecting/unselecting sessions updates **Remaining** immediately and persists via existing hooks/services.

### D) Add Payment dialog — full cascade + writes
1) **Method** dropdown: `FPS`, `Bank Transfer`, `Cheque` → write `method`.
2) **Entity** dropdown: `Music Establish (ERL)`, `Personal` → write `entity`.
3) If **ERL**:
   - **Bank** dropdown: list ERL directory banks; label `{bankName} {bankCode}` (fallback `{docId} {collectionId}`); write `bankCode`.
   - **Bank Account** dropdown (dependent): list accounts for bank; label `accountType`; write `accountDocId`.
   - On submit, set **`identifier = "{bankCode}/{accountDocId}"`**.
4) **Reference Number** text → `refNumber`.
5) Button label **Submit** (rename from Save).
6) On submit also stamp **`timestamp`** and **`editedBy`**.
7) If a user-entered `identifier` exists but fails `/^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/`, recompute from bank/account before write.

### E) List view — keep “For Session(s)”
- Ensure the column remains (≤5 ordinals + trailing `…`), header ellipsis and resizers intact.

### F) File hints (search/adapt)
- `components/StudentDialog/PaymentModal.tsx` (cascade UI + submit logic)
- `components/StudentDialog/PaymentDetail.tsx` (blink single render; assignment shell)
- `components/StudentDialog/PaymentHistory.tsx` (verify sessions column; header ellipsis)
- `styles/studentDialog.css` (sticky footer polish)
- `lib/erlDirectory.ts` (add if missing: typed fetch for banks/accounts; graceful fallback between data shapes)

## Tests

### Unit
- Identifier normalize/recompute helper.
- Any small transform helpers (e.g., session truncation) remain green.

### Cypress / component
- **Sticky Back**: Back is visible in sticky footer while body scrolls.
- **Blink**: only Remaining blinks on selection changes; Amount stays static.
- **Assignment**: zero-state visible; selection updates Remaining and persists.
- **Cascade**: Entity=ERL → pick Bank → Bank Account → Submit → document has `method`, `entity`, `bankCode`, `accountDocId`, `identifier`, `refNumber`, `timestamp`, `editedBy`.

> Keep specs committed; if CI lacks GUI deps, conditionally skip. Do NOT touch workflows.

## Acceptance
- Back is in sticky footer; footer sticks to window edge.
- Remaining uses a single blinking element.
- Assignment section is persistent and functional end-to-end.
- Add Payment cascade UI works; writes + normalization + audit fields present.
- No new TypeScript errors.

## Save this prompt
Write this file to **prompts/p-027-01r.md** verbatim (no renames).
