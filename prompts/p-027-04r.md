# P-027-04r — Add Payment cascade UI (detail), sticky Back, 3-dots placement, single Remaining blink, sessions sorting, card-view badge

## Background
Recent merges show identifier-normalization work and helpers, but the visible UI is still missing:
- Entity → Bank → Bank Account **dropdowns** are not showing in Payment **Detail**.
- The Back control is not reliably inside the **sticky footer**.
- The **3-dots settings** button is not anchored correctly to the bottom-left **inside** the white card; it drifts toward the sidebar.
- **Remaining** still risks double-render blink.
- Sessions tab lacks **sorting**.
- Keep the small “P-prompt” badge visible in the **card view** page (top-right).

> PR-226 was docs-only; PR-227 title claims cascade UI, but the dropdowns aren’t visible in the app yet. Ensure UI is truly present and testable.

## Deliverables

### 1) Sticky footer & Back placement (StudentDialog)
- Render **Back** inside the sticky footer/action bar (same container as primary actions).
- Ensure the **dialog body** is the scroll container; add bottom padding equal to footer height so content is never obscured.
- CSS (adapt to theme):
  position: sticky; bottom: 0; z-index: 10;
  border-top: 1px solid var(--mui-palette-divider);
  box-shadow: 0 -2px 8px rgba(0,0,0,.04);
  background: inherit;
- Add test ids: `data-testid="dialog-footer"`, `data-testid="back-button"`.

### 2) 3-dots settings button — exact placement inside card
- Button must be **sticky to the bottom-left inside the white card** (NOT in the sidebar; NOT relative to page/viewport).
- Implementation requirements:
  - The **card container** is `position: relative;`.
  - The 3-dots wrapper is **within that card** and uses `position: sticky; bottom: 0; left: 0;` (or a card-internal sticky area) so it tracks the card’s bottom edge.
  - Layout aligns the 3-dots button to the **same Y/baseline** as any bottom controls (e.g., “Service Mode” if present in that card’s footer row). Use a card-footer flex row: `display: flex; align-items: center; justify-content: space-between;`.
  - Add `data-testid="settings-3dots"` and `data-testid="card-footer-row"`.
- Do not position it relative to the page/sidebar. Visual regression: the left edge of the button must remain **inside** the card’s padding box.

### 3) Remaining blink — single element only
- **Payment Amount** never blinks.
- **Remaining** renders **once** with the blink class (e.g., `.blink-remaining`).
- Remove any duplicate elements/spans; expose `data-testid="remaining-amount"`.
- Respect reduced-motion.

### 4) Payment **Detail** — Entity/Bank/Account dropdown **editing-on-empty**
- In the **selected Payment** detail panel:
  - When a field is **empty**, show edit controls:
    - **Entity** (select): `Music Establish (ERL)` | `Personal`. (`data-testid="detail-entity-select"`)
    - If ERL:
      - **Bank** (select): list ERL banks labeled `{bankName} {bankCode}` (fallback `{docId} {collectionId}`). (`data-testid="detail-bank-select"`)
      - **Bank Account** (select): dependent on bank; list accounts labeled by `accountType`, value=`accountDocId`. (`data-testid="detail-bank-account-select"`)
    - **Reference Number** (text). (`data-testid="detail-ref-input"`)
  - On **Save/Submit** in detail:
    - Validate: `entity` required; if ERL then `bankCode` + `accountDocId` required.
    - Write fields; compute **`identifier = "{bankCode}/{accountDocId}"`** for ERL.
    - Stamp `timestamp` & `editedBy`.
    - If user-entered identifier exists but fails `/^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/`, recompute from bank/account.
  - When a field becomes non-empty, render it **read-only** (per earlier spec). Add a small “Edit anyway” affordance **behind a confirm dialog** if you need to override (optional, only if already present pattern).

> Keep the Add Payment dialog cascade as implemented/queued; this item covers editing missing metadata in the **detail** view specifically.

### 5) Sessions tab — sorting
- Add column sorting to the **Sessions** table:
  - Click header toggles asc/desc; keyboard accessible; ARIA `aria-sort` reflects state.
  - Persist last sort per user (reuse your user settings store).
  - Default sort unchanged unless user sets one.
  - Keep min-width/ellipsis behavior intact.

### 6) Badge in **card view** (top-right)
- Render a tiny text badge at the **top-right of the card view page** showing the current prompt id: **“P-027-04r”**.
- Style: font `Nunito`, weight 200 (ExtraLight), size 10–11px, opacity ~0.6; pointer-events: none.
- `data-testid="pprompt-badge-card"`

### 7) ERL helpers
- Ensure `lib/erlDirectory.ts` provides:
  - `listBanks(): Promise<Array<{ bankCode: string; bankName?: string }>>`
  - `listAccounts(bankCode: string): Promise<Array<{ accountDocId: string; accountType?: string }>>`
- Graceful fallback between both Firestore shapes (new `banks/{bankCode}` and legacy `bankAccount/{bankCode}/accounts/*`). No secrets in code.

## Tests (no placeholders)
### Unit
- normalizeIdentifier: valid/invalid + ERL enforcement.
- ERL label builders + fallbacks.
- Sessions sort comparator (at least one numeric/date and one text column).

### Cypress / component
1) **Sticky Back**: `data-testid="back-button"` is inside `data-testid="dialog-footer"` and remains visible while body scrolls.
2) **3-dots**: `data-testid="settings-3dots"` stays within `data-testid="card-footer-row"` and visually inside the card (check bounding rect).
3) **Blink**: after selection change, only `data-testid="remaining-amount"` has blink class; Amount never blinks.
4) **Detail editing**: with empty metadata, entity/bank/account dropdowns appear; pick values → Save → verify document writes `entity`, `bankCode`, `accountDocId`, `identifier`, `refNumber`, `timestamp`, `editedBy`; fields turn read-only.
5) **Sessions sorting**: clicking a header toggles sort; `aria-sort` updates; order reflects comparator; state persists across refresh.
6) **Badge**: `data-testid="pprompt-badge-card"` shows “P-027-04r” on the card view page.

> Keep specs committed. If CI lacks GUI deps, guard with conditional skip. Do not edit workflows.

## Acceptance
- Back in sticky footer; 3-dots anchored bottom-left **inside** card; Remaining single-render; detail cascade editing works (write+lock); sessions sortable; badge shows “P-027-04r”; no new TS errors.

