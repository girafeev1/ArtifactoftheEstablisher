# P-018 — Context Bundle automation, payment summary write, overlay test hardening, README link fix

> Save this exact prompt file to: `prompts/p-018.md`.

# Non-Skip Rules (Read first)
- Implement **every** item in this prompt.
- If anything is blocked/ambiguous, **stop** and post a PR comment listing the blocker and your proposed resolution. Do **not** submit a partial PR without that note.
- When you open the PR, include the **Completion Checklist** below and check off each line with (✅/⚠️/❌), linking to file+lines for your change.

# Completion Checklist (fill in before requesting review)
- [ ] A. Context Bundle Action added and verified on PR open/update (comment upsert, not spam).
- [ ] B. PaymentModal writes summary via `writeSummaryFromCache` (files/lines + how tested).
- [ ] C. Overlay test asserts “Add Payment” dialog is topmost (test link/screenshot).
- [ ] D. README now links to `docs/Task Log.md`.
- [ ] Docs updated; Task Log updated; prompt saved to `prompts/p-018.md`.

## Scope
Close gaps from the last cycle: add a GitHub Action that **posts/updates a “Context Bundle”** comment on every PR open/sync, make **PaymentModal** update the summary cache, strengthen the **overlay Cypress test**, and fix the **Task Log link** in README.

## A) GitHub Action: Context Bundle (PR comment on open/sync)
Add `.github/workflows/context-bundle.yml`:

- **Triggers:** `pull_request` with types `[opened, synchronize, reopened, ready_for_review]`. Also allow `workflow_dispatch` for manual runs.
- **Behavior:** Create or update a single PR comment titled `### Context Bundle` that includes:
  - PR title/number, head branch, commit SHA short.
  - Files changed (group by top-level dir), with additions/deletions totals.
  - If `docs/Task Log.md` changed: show **lines added vs removed**, and warn if removal > 10 (the guard will fail anyway).
  - If any `prompts/p-*.md` is in the diff: list them with IDs.
- **Upsert** (don’t spam): find an existing bot comment that starts with `### Context Bundle` and **edit** it; otherwise create it.

Suggested implementation using `actions/github-script@v7`:

```yaml
name: Context Bundle
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch: {}
permissions:
  pull-requests: write
  issues: write
jobs:
  bundle:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const {owner, repo} = context.repo;
            const files = await github.paginate(
              github.rest.pulls.listFiles, { owner, repo, pull_number: pr.number, per_page: 100 }
            );
            const groups = new Map();
            let add=0, del=0;
            for (const f of files) {
              add += f.additions; del += f.deletions;
              const top = (f.filename.split('/')[0]) || '.';
              const arr = groups.get(top) || [];
              arr.push(`- \`${f.filename}\` (+${f.additions}/-${f.deletions})`);
              groups.set(top, arr);
            }
            const groupMd = [...groups.entries()]
              .map(([g, arr]) => `**${g}/**\n` + arr.join('\n'))
              .join('\n\n');

            // Task Log deltas
            const tl = files.find(f => f.filename === 'docs/Task Log.md');
            let tlLine = tl
              ? `- Task Log changed: +${tl.additions}/-${tl.deletions}` +
                (tl.deletions > 10 ? ' ⚠️ (removals > 10 will fail guard)' : '')
              : '- Task Log changed: no';

            // Prompts touched
            const prompts = files.filter(f => f.filename.startsWith('prompts/')).map(f => f.filename);
            const promptsLine = prompts.length ? `- Prompts: ${prompts.map(p => `\`${p}\``).join(', ')}` : '- Prompts: none';

            const body = [
              '### Context Bundle',
              `**PR** #${pr.number}: ${pr.title}`,
              `**Head** \`${pr.head.ref}\` @ \`${pr.head.sha.slice(0,7)}\``,
              `**Files**: ${files.length}  (**+${add} / -${del}**)`,
              '',
              tlLine,
              promptsLine,
              '',
              groupMd || '_No file changes?_'
            ].join('\n');

            // Upsert comment
            const comments = await github.paginate(
              github.rest.issues.listComments, { owner, repo, issue_number: pr.number, per_page: 100 }
            );
            const mine = comments.find(c =>
              c.user.type === 'Bot' && c.user.login.endsWith('[bot]') && c.body.startsWith('### Context Bundle')
            );
            if (mine) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: mine.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number: pr.number, body });
            }
```
