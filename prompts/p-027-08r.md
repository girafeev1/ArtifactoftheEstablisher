# P-027-08r — Wire ERL cascade to current Firestore structure, side-by-side selects, add cascade to Payment Detail (when empty), keep single badge & alignment

## Save path
prompts/p-027-08r.md

## Branch & PR
- Branch: codex/finalize-add-payment-cascade-and-alignments-08r
- PR title: feat(payment): ERL cascade wired to bankAccount structure, side-by-side selects, detail fallback, single badge, alignment (P-027-08r)
- Labels: payments, ui, codex
- Do not change CI, Actions, or Vercel settings in this PR.

## A) ERL directory hookup (no new helpers, adapt existing files)
- Update lib/erlDirectory.ts to read new `erl-directory/bankAccount/{BankName}` docs that require a `code` field.
- listBanks(): prefer `banks/*`; fallback to `bankAccount/*` using `data.code`.
- listAccounts(bankCode): prefer `banks/{bankCode}/accounts/*`; fallback via `collectionGroup(dbDirectory, bankCode)` filtering paths containing `/bankAccount/`.
- buildBankLabel unchanged.
- Missing `code` on bank docs should surface a toast and inline hint in the UI.

## A2. Add Payment dialog — keep cascade, make it actually populate
- Entity "Music Establish (ERL)" triggers bank/account cascade using updated helpers.
- If listBanks() empty or throws, inline message: `Bank directory unavailable or missing 'code' on bank docs`.
- Submit writes method, entity, refNumber, timestamp, editedBy and for ERL also bankCode, accountDocId, identifier = "${bankCode}/${accountDocId}".

## B) UI layout tweaks
- Bank & Bank Account selects render side-by-side in PaymentModal (Grid container md={6}).
- Coaching Sessions card footer: keep 3-dots (`settings-3dots`) and Service Mode (`service-mode-btn`) in footer row; baselines match and stay inside card.
- P-prompt badge: single `pprompt-badge-card` at top-right of card view only.

## C) Payment Detail — fallback cascade only when fields are empty
- When method/entity/bankCode/accountDocId missing, render inline cascade to complete metadata once.
- Save writes same fields as Add Payment plus timestamp & editedBy; once set, fields become read-only.

## D) Tests
- lib/erlDirectory.test.ts: banks/accounts fallback logic.
- PaymentModal.test.tsx: ERL cascade populates and submit stores identifier & audit fields.
- PaymentDetail.test.tsx: metadata cascade saves once then renders read-only.

## Acceptance
- Add Payment dialog shows working cascade with current ERL structure.
- Bank and Bank Account selects side-by-side.
- Payment Detail shows cascade only when metadata missing; after save, fields read-only.
- 3-dots and Service Mode share baseline inside card; no sidebar drift.
- Only one P-prompt badge rendered (top-right of card).
- No TypeScript errors; unit/RTL tests pass.
