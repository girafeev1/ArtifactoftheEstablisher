P-024 — Payment UI polish & data rules (post P-023)

Goal: Finish the remaining P-023 items and add guardrails/tests so they persist:

Payment History columns/labels finalized

“For Session(s)” list truncation with “(+N more)” and expand

Sticky dialog footer across StudentDialog tabs

Enforce identifier = "{bankCode}/{accountDocId}" at write-time (and display)

Minimal unit + e2e tests

MANDATORY repo hygiene

Do not alter CI or GitHub Actions.

Save this exact prompt to: prompts/p-024.md (lowercase, hyphenated, no extra words).
Do not create any other prompt filename (e.g., “p-tasklog-…md”).

Use a single feature branch: codex/feat-payment-ui-polish-p024.

What to build
A) Payment History table headers & new columns

Update the Payment History list/table so its headers are exactly:

Date

Amount (currency formatted)

Method (NEW)

Entity (NEW) — e.g., bank/wallet name

Bank Account — show the identifier (see D)

Reference # — free text reference

Keep columns responsive; headers must ellipsize (no wrapping).

B) “For Session(s)” truncation in Payment Detail

In the Payment Detail panel/modal:

Show at most 5 session entries inline.

If more than 5, render … (+N more) where N = total - 5.

Provide a View all affordance to reveal the full list within the same panel (no navigation change).

C) Sticky footer for StudentDialog panels

For all StudentDialog tabs/panels with bottom actions:

Make the footer sticky: position: sticky; bottom: 0; z-index: 10 with a subtle top border/shadow.

Ensure the scroll container has bottom padding so content isn’t hidden under the footer.

Works on small & large viewports.

D) Identifier format (create + display)

Define identifier as: ${bankCode}/${accountDocId}.

On payment create/update:

If identifier is missing but bankCode and the selected bank account document ID exist, compute and set identifier.

If identifier exists but does not match /^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/, rebuild and store it.

Display:

Show identifier under Bank Account in the table and detail view.

If unavailable, show — (em dash). Never block rendering.

E) Robustness for empties

When rendering method, entity, identifier, referenceNumber, use safe fallbacks:

Empty/undefined → render —.

File hints (search targets; adapt to actual paths)

components/StudentDialog/**/PaymentHistory*.tsx (table/list view)

components/StudentDialog/**/PaymentDetail*.tsx|.ts (detail panel)

components/StudentDialog/** (the panel/container that holds the footer)

lib/**/payments*.ts or lib/billing/** (write path for normalization)

Shared typography/cell components for header ellipsis (if present)

Small helpers (add if not present)

lib/payments/format.ts

export function buildIdentifier(bankCode?: string, accountDocId?: string): string | undefined

Return undefined if either part is missing; else ${bankCode}/${accountDocId}.

lib/payments/truncate.ts

export function truncateList<T>(arr: T[], limit = 5): { visible: T[]; hiddenCount: number }

Tests

Unit (Jest)

lib/payments/format.test.ts — cases: missing parts, valid parts, regex validation.

lib/payments/truncate.test.ts — arrays of length 0,1,5,6,7.

E2E (Cypress)

Extend/create: cypress/e2e/payment_metadata.cy.ts:

Payment with ≥6 sessions: only 5 inline; shows (+N more) and expands to all.

Table headers include Method, Entity, Bank Account, Reference #.

Identifier text equals bankCode/accountDocId when both exist; — otherwise.

If CI lacks GUI libs, keep the spec but mark it non-blocking in CI if necessary (e.g., conditional skip). Do not change CI workflow files.

Acceptance criteria

Payment History shows the exact headers listed above.

Payment Detail truncates “For Session(s)” to 5 with … (+N more) and can reveal all.

StudentDialog footer remains visible while scrolling in all tabs.

Newly saved/updated payments have identifier in the specified format when inputs exist.

Unit tests pass locally; Cypress spec exists and passes locally (CI may skip if headless deps are missing, but the spec must be committed).

Commit plan (suggested, squash OK)

feat(payment): finalize history columns (P-024 A)

feat(payment-detail): truncate session list with expand (P-024 B)

feat(ui): sticky footer across StudentDialog (P-024 C)

feat(payments): identifier normalization + display (P-024 D)

test: add unit tests for buildIdentifier + truncateList (P-024)

test(e2e): payment metadata + sessions truncation (P-024)

docs(task-log): update T-xxx and Latest summary for P-024

Branch & PR

Branch: codex/feat-payment-ui-polish-p024

PR title: feat(payment): finalize history columns, truncate session list, sticky footer, identifier rule (P-024)

Labels: payments, ui, codex

MANDATORY — Prompt file protocol

Create exactly: prompts/p-024.md

Write the full text of this prompt into that file verbatim (no extra commentary, no renames).

MANDATORY — Task Log maintenance (docs/task-log-vol-1.md)

After implementing and running tests, update the Task Log to reflect what actually happened:

Latest change summary — add a new top bullet list for P-024 with short, past-tense items, e.g.

“Payment History: headers finalized (Method, Entity, Bank Account, Reference #).”

“Payment Detail: ‘For Session(s)’ truncates to 5 with expand.”

“StudentDialog: sticky footer across tabs.”

“Identifier normalization on write; safe display with em dash.”

“Unit + e2e tests added.”

Tasks T-xxx — append a new task block using the next available task id. Use this template and fill in status based on results (✅ / ⚠️ / ❌):

### T-<next>
- Title: Payment UI polish & data rules (P-024)
- Branch: codex/feat-payment-ui-polish-p024
- PR: <link to this PR>
- Status: <Completed | Partially Completed | Follow-up Needed>
- Outcomes:
  - A) History headers: <PASS/FAIL + 1-line note>
  - B) Sessions truncation: <PASS/FAIL + 1-line note>
  - C) Sticky footer: <PASS/FAIL + 1-line note>
  - D) Identifier rule: <PASS/FAIL + 1-line note>
  - E) Tests: <PASS/FAIL + 1-line note (mention if Cypress skipped in CI)>
- Notes: <optional short notes or TODOs>


Prompts P-### — add an entry for P-024 with a link to prompts/p-024.md and this PR.

If docs/task-log-vol-1.md does not exist, create it with headings:

“Latest change summary”

“Tasks T-xxx”

“Prompts P-###”

Save Task Log changes in a separate commit titled:

docs(task-log): update Latest, T-<next>, and P-024

Definition of Done (self-checklist)

 Headers: Method, Entity, Bank Account, Reference # present and responsive

 “For Session(s)” truncation + expand works

 Sticky footer in StudentDialog everywhere

 Identifier built and shown; safe fallback —

 Unit tests for buildIdentifier and truncateList

 Cypress spec added/updated

 prompts/p-024.md written verbatim

 docs/task-log-vol-1.md updated per “Task Log maintenance”
