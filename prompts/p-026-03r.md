# P-026-03r — Finish Payment UX and Add Payment cascade (final touches)

## Save this prompt exactly at
prompts/p-026-03r.md

## Branch & PR
- Branch: codex/finalize-payment-ux-and-functionality-enhancements-03r
- PR title: feat(payment): finish sticky Back, single remaining blink, stable assignment, Add Payment cascade, list “For Session(s)” truncation (P-026-03r)
- Labels: payments, ui, codex

## Rules
- Do NOT modify CI or any GitHub Actions.
- Keep changes minimal, typed, and in existing components.

---

## A) Sticky footer + Back placement
- Render the **Back** control INSIDE the dialog’s **sticky footer/action bar** (same container as primary actions).
- Ensure the dialog **body** is the scroll container; add bottom padding equal to footer height so content isn’t hidden.
- Footer CSS (adapt to stack):
  - position: sticky; bottom: 0; z-index: 10;
  - border-top: 1px solid var(--mui-palette-divider);
  - box-shadow: 0 -2px 8px rgba(0,0,0,.04);
  - background: inherit;

## B) Remaining blink — single render only
- **Payment Amount**: never blinks.
- **Remaining**: render **once** with the blink class; **remove any duplicate span/element** that causes flicker/double-blink.

## C) Session assignment list — always visible & functional
- Keep the assignment section visible even when computed rows are 0 (show a zero-state).
- Selecting/unselecting sessions updates **Remaining** immediately and persists via existing hooks/services.
- The “For Session(s)” summary in the **detail view** must NOT hide or replace the assignment controls.

## D) Add Payment dialog — cascade + writes (the big missing piece)
Implement the full cascade exactly:

1) **Payment Method** (dropdown): `FPS`, `Bank Transfer`, `Cheque` → store `method: string`.
2) **Entity** (dropdown): `Music Establish (ERL)`, `Personal` → store `entity: string` (use the label).
3) If **Entity = "Music Establish (ERL)"**:
   - **Bank** dropdown: list ERL directory banks. Display label = `{bankName} {bankCode}` (fallback `{docId} {collectionId}` if needed).
   - **Bank Account** dropdown: for the chosen bank, list sub-collection accounts; label with each account’s **`accountType`**.
   - On submit, set **`identifier = "{bankCode}/{accountDocId}"`** (accountDocId = selected account document id).
4) **Reference Number** (text) → store `refNumber: string`.
5) Rename **Save** → **Submit**.
6) On submit also stamp **`timestamp`** and **`editedBy`**.
7) Normalization: if a user-entered `identifier` does not match `/^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/`, recompute from `{bankCode}/{accountDocId}` before write.

> Data access: use the existing ERL directory reader if present; otherwise add a tiny `lib/erlDirectory.ts` that fetches banks + accounts from the ERL directory database with graceful fallback (both `banks/{bankCode}` and `bankAccount/{bankCode}/accounts/*` shapes acceptable). No secrets in code.

## E) Payment History (list) — “For Session(s)” column
- Ensure the column exists and shows up to **5** session ordinals; if more, append a trailing **`…`** after the 5th (no count here; detail already shows `(+N more)`).

## F) Header width decouple (so long headers don’t block narrowing)
- Apply `table-layout: fixed` where appropriate.
- Ensure `th`/header cells have: `overflow: hidden; text-overflow: ellipsis; white-space: nowrap`.
- Keep data cells resizable as today.

---

## Tests
- **Unit:** helpers for session truncation and identifier build/normalize.
- **Cypress / component:**
  - Only Remaining blinks; Payment Amount is static.
  - Assignment table shows zero-state and updates Remaining on selection.
  - Add Payment cascade: pick Entity=ERL → Bank → Bank Account → Submit; verify `method`, `entity`, `identifier`, `refNumber`, `timestamp`, `editedBy`.
  - Payment History list shows “For Session(s)” with ≤5 ordinals + `…`.

> CI may skip Cypress due to headless deps; keep specs committed and guard with conditional skip if needed. Do NOT edit workflows.

---

## Acceptance
- Back sits in the sticky footer; footer sticks to the window edge.
- Remaining uses a **single** blinking element (no duplicates).
- Assignment section remains visible and functional end-to-end.
- Add Payment cascade implemented; `identifier` and audit fields written.
- List “For Session(s)” shows 5-then-ellipsis.
- No new TypeScript errors.

## Save this prompt
Write this file to **prompts/p-026-03r.md** verbatim (no renames).
