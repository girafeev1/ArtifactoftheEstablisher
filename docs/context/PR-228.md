# PR #228 — Diff Summary

- **Base (target)**: `d86791bc6d62d71052060eb3c75a33520a7f5722`
- **Head (source)**: `bfda9229f5836770a0556c5893bae65ee7b292fa`
- **Repo**: `girafeev1/ArtifactoftheEstablisher`

## Changed Files

```txt
A	components/StudentDialog/PaymentDetail.test.tsx
M	components/StudentDialog/PaymentDetail.tsx
M	components/StudentDialog/SessionsTab.tsx
M	lib/promptId.ts
A	lib/sessionsSort.test.ts
A	lib/sessionsSort.ts
A	pages/dashboard/businesses/coaching-sessions.test.tsx
M	pages/dashboard/businesses/coaching-sessions.tsx
A	prompts/p-027-04r.md
```

## Stats

```txt
 components/StudentDialog/PaymentDetail.test.tsx    | 112 ++++++++++++
 components/StudentDialog/PaymentDetail.tsx         | 192 +++++++++++++++++----
 components/StudentDialog/SessionsTab.tsx           |  67 ++++---
 lib/promptId.ts                                    |   2 +-
 lib/sessionsSort.test.ts                           |  19 ++
 lib/sessionsSort.ts                                |  32 ++++
 .../businesses/coaching-sessions.test.tsx          |  49 ++++++
 pages/dashboard/businesses/coaching-sessions.tsx   |  65 +++++--
 prompts/p-027-04r.md                               |  94 ++++++++++
 9 files changed, 548 insertions(+), 84 deletions(-)
```

## Unified Diff (truncated to first 4000 lines)

```diff
diff --git a/components/StudentDialog/PaymentDetail.test.tsx b/components/StudentDialog/PaymentDetail.test.tsx
new file mode 100644
index 0000000..33c859b
--- /dev/null
+++ b/components/StudentDialog/PaymentDetail.test.tsx
@@ -0,0 +1,112 @@
+/**
+ * @jest-environment jsdom
+ */
+import React from 'react'
+import '@testing-library/jest-dom'
+import { render, screen, fireEvent, waitFor } from '@testing-library/react'
+import PaymentDetail from './PaymentDetail'
+
+jest.mock('../../lib/billing/useBilling', () => ({
+  useBillingClient: () => ({ setQueryData: jest.fn() }),
+  useBilling: () => ({ data: { rows: [] } }),
+}))
+jest.mock('../../lib/billing/minUnpaidRate', () => ({ minUnpaidRate: () => 0 }))
+jest.mock('../../lib/liveRefresh', () => ({
+  patchBillingAssignedSessions: jest.fn(),
+  writeSummaryFromCache: jest.fn(),
+  payRetainerPatch: jest.fn(),
+  upsertUnpaidRetainerRow: jest.fn(),
+}))
+jest.mock('../../lib/firebase', () => ({ db: {} }))
+jest.mock('next-auth/react', () => ({
+  useSession: () => ({ data: { user: { email: 'tester@example.com' } }, status: 'authenticated' }),
+}))
+jest.mock('firebase/firestore', () => ({
+  doc: () => ({}),
+  setDoc: jest.fn(),
+  updateDoc: jest.fn(),
+  onSnapshot: jest.fn(() => () => {}),
+  collection: jest.fn(),
+  Timestamp: { now: () => ({ seconds: 0 }) },
+}))
+jest.mock('../../lib/erlDirectory', () => ({
+  listBanks: () => Promise.resolve([{ bankCode: '001', bankName: 'Bank1' }]),
+  listAccounts: () =>
+    Promise.resolve([{ accountDocId: 'A1', accountType: 'Savings' }]),
+  buildBankLabel: (b: any) => `${b.bankName || ''} ${b.bankCode}`.trim(),
+}))
+
+describe('PaymentDetail', () => {
+  const basePayment = {
+    id: 'p1',
+    amount: 100,
+    paymentMade: new Date(),
+    remainingAmount: 100,
+  }
+
+  it('renders Back inside sticky footer', () => {
+    render(
+      <PaymentDetail
+        abbr="A"
+        account="acct"
+        payment={{ ...basePayment }}
+        onBack={() => {}}
+      />,
+    )
+    const footer = screen.getByTestId('dialog-footer')
+    const back = screen.getByTestId('back-button')
+    expect(footer).toContainElement(back)
+  })
+
+  it('only remaining amount blinks', () => {
+    render(
+      <PaymentDetail
+        abbr="A"
+        account="acct"
+        payment={{ ...basePayment }}
+        onBack={() => {}}
+      />,
+    )
+    const blinkEls = document.querySelectorAll('.blink-remaining')
+    expect(blinkEls).toHaveLength(1)
+    expect(blinkEls[0]).toBe(screen.getByTestId('remaining-amount'))
+  })
+
+  it('allows editing empty metadata and saves', async () => {
+    const payment: any = { ...basePayment }
+    render(
+      <PaymentDetail
+        abbr="A"
+        account="acct"
+        payment={payment}
+        onBack={() => {}}
+      />,
+    )
+    fireEvent.change(screen.getByTestId('detail-entity-select'), {
+      target: { value: 'Music Establish (ERL)' },
+    })
+    await waitFor(() => screen.getByTestId('detail-bank-select'))
+    fireEvent.change(screen.getByTestId('detail-bank-select'), {
+      target: { value: '001' },
+    })
+    await waitFor(() => screen.getByTestId('detail-bank-account-select'))
+    fireEvent.change(screen.getByTestId('detail-bank-account-select'), {
+      target: { value: 'A1' },
+    })
+    fireEvent.change(screen.getByTestId('detail-ref-input'), {
+      target: { value: 'REF1' },
+    })
+    await waitFor(() =>
+      expect(screen.getByTestId('detail-save')).not.toBeDisabled(),
+    )
+    fireEvent.click(screen.getByTestId('detail-save'))
+    await waitFor(() =>
+      expect(payment.entity).toBe('Music Establish (ERL)'),
+    )
+    expect(payment.bankCode).toBe('001')
+    expect(payment.accountDocId).toBe('A1')
+    expect(payment.identifier).toBe('001/A1')
+    expect(payment.refNumber).toBe('REF1')
+  })
+})
+
diff --git a/components/StudentDialog/PaymentDetail.tsx b/components/StudentDialog/PaymentDetail.tsx
index c36c287..43030eb 100644
--- a/components/StudentDialog/PaymentDetail.tsx
+++ b/components/StudentDialog/PaymentDetail.tsx
@@ -12,8 +12,16 @@ import {
   TableSortLabel,
   CircularProgress,
   TextField,
+  MenuItem,
 } from '@mui/material'
-import { doc, setDoc, updateDoc, onSnapshot, collection } from 'firebase/firestore'
+import {
+  doc,
+  setDoc,
+  updateDoc,
+  onSnapshot,
+  collection,
+  Timestamp,
+} from 'firebase/firestore'
 import { db } from '../../lib/firebase'
 import { formatMMMDDYYYY } from '../../lib/date'
 import { titleFor } from './title'
@@ -32,6 +40,13 @@ import {
 } from '../../lib/liveRefresh'
 import { useSession } from 'next-auth/react'
 import { useColumnWidths } from '../../lib/useColumnWidths'
+import {
+  listBanks,
+  listAccounts,
+  buildBankLabel,
+  BankInfo,
+  AccountInfo,
+} from '../../lib/erlDirectory'
 
 const formatCurrency = (n: number) =>
   new Intl.NumberFormat(undefined, {
@@ -75,8 +90,11 @@ export default function PaymentDetail({
   const [showAllSessions, setShowAllSessions] = useState(false)
   const [methodVal, setMethodVal] = useState(payment.method || '')
   const [entityVal, setEntityVal] = useState(payment.entity || '')
-  const [identifierVal, setIdentifierVal] = useState(payment.identifier || '')
   const [refVal, setRefVal] = useState(payment.refNumber || '')
+  const [bankCodeVal, setBankCodeVal] = useState(payment.bankCode || '')
+  const [accountIdVal, setAccountIdVal] = useState(payment.accountDocId || '')
+  const [banks, setBanks] = useState<BankInfo[]>([])
+  const [accounts, setAccounts] = useState<AccountInfo[]>([])
   const qc = useBillingClient()
   const { data: bill } = useBilling(abbr, account)
   const [retainers, setRetainers] = useState<any[]>([])
@@ -95,6 +113,25 @@ export default function PaymentDetail({
   )
   const tableRef = React.useRef<HTMLTableElement>(null)
   const minDue = React.useMemo(() => minUnpaidRate(bill?.rows || []), [bill])
+  const isErl =
+    entityVal === 'Music Establish (ERL)' || entityVal === 'ME-ERL'
+  useEffect(() => {
+    if (isErl && banks.length === 0) {
+      listBanks()
+        .then((b) => setBanks(b))
+        .catch(() => setBanks([]))
+    }
+  }, [isErl, banks.length])
+  useEffect(() => {
+    if (isErl && bankCodeVal) {
+      listAccounts(bankCodeVal)
+        .then((a) => setAccounts(a))
+        .catch(() => setAccounts([]))
+    } else {
+      setAccounts([])
+      setAccountIdVal('')
+    }
+  }, [isErl, bankCodeVal])
 
   const saveMeta = async (
     field: 'method' | 'entity' | 'identifier' | 'refNumber',
@@ -191,6 +228,36 @@ export default function PaymentDetail({
     )
   }
 
+  const needsMeta =
+    !payment.entity ||
+    ((payment.entity === 'Music Establish (ERL)' || payment.entity === 'ME-ERL') &&
+      (!payment.bankCode || !payment.accountDocId)) ||
+    !payment.refNumber
+
+  const saveMetaDetails = async () => {
+    const patch: any = {
+      entity: entityVal,
+      refNumber: refVal,
+      timestamp: Timestamp.now(),
+      editedBy: userEmail,
+    }
+    if (isErl) {
+      if (!bankCodeVal || !accountIdVal) return
+      patch.bankCode = bankCodeVal
+      patch.accountDocId = accountIdVal
+      const id = normalizeIdentifier(
+        entityVal,
+        bankCodeVal,
+        accountIdVal,
+        payment.identifier,
+      )
+      if (id) patch.identifier = id
+    }
+    await updateDoc(doc(db, PATHS.payments(abbr), payment.id), patch)
+    Object.assign(payment, patch)
+    await writeSummaryFromCache(qc, abbr, account)
+  }
+
   useEffect(() => {
     const d = payment.paymentMade?.toDate
       ? payment.paymentMade.toDate()
@@ -378,17 +445,78 @@ export default function PaymentDetail({
                     : payment.entity
                   : (
                       <TextField
+                        select
                         size="small"
                         value={entityVal}
                         onChange={(e) => setEntityVal(e.target.value)}
-                        onBlur={() => saveMeta('entity', entityVal)}
                         inputProps={{
+                          'data-testid': 'detail-entity-select',
                           style: { fontFamily: 'Newsreader', fontWeight: 500 },
                         }}
-                      />
+                      >
+                        <MenuItem value="Music Establish (ERL)">
+                          Music Establish (ERL)
+                        </MenuItem>
+                        <MenuItem value="Personal">Personal</MenuItem>
+                      </TextField>
                     ),
               },
             ]
+            const showBank =
+              payment.entity === 'ME-ERL' ||
+              payment.entity === 'Music Establish (ERL)' ||
+              (!payment.entity && entityVal === 'Music Establish (ERL)')
+            if (showBank) {
+              fields.push({
+                label: 'Bank',
+                value: payment.bankCode
+                  ? buildBankLabel({
+                      bankCode: payment.bankCode,
+                      bankName: banks.find((b) => b.bankCode === payment.bankCode)?.bankName,
+                    })
+                  : (
+                      <TextField
+                        select
+                        size="small"
+                        value={bankCodeVal}
+                        onChange={(e) => setBankCodeVal(e.target.value)}
+                        inputProps={{
+                          'data-testid': 'detail-bank-select',
+                          style: { fontFamily: 'Newsreader', fontWeight: 500 },
+                        }}
+                      >
+                        {banks.map((b) => (
+                          <MenuItem key={b.bankCode} value={b.bankCode}>
+                            {buildBankLabel(b)}
+                          </MenuItem>
+                        ))}
+                      </TextField>
+                    ),
+              })
+              fields.push({
+                label: 'Bank Account',
+                value: payment.accountDocId
+                  ? payment.accountDocId
+                  : (
+                      <TextField
+                        select
+                        size="small"
+                        value={accountIdVal}
+                        onChange={(e) => setAccountIdVal(e.target.value)}
+                        inputProps={{
+                          'data-testid': 'detail-bank-account-select',
+                          style: { fontFamily: 'Newsreader', fontWeight: 500 },
+                        }}
+                      >
+                        {accounts.map((a) => (
+                          <MenuItem key={a.accountDocId} value={a.accountDocId}>
+                            {a.accountType}
+                          </MenuItem>
+                        ))}
+                      </TextField>
+                    ),
+              })
+            }
             if (sessionOrds.length) {
               const { visible, hiddenCount } = truncateList(sessionOrds)
               fields.push({
@@ -414,22 +542,6 @@ export default function PaymentDetail({
                 ),
               })
             }
-            fields.push({
-              label: 'Bank Account',
-              value: payment.identifier ? (
-                payment.identifier
-              ) : (
-                <TextField
-                  size="small"
-                  value={identifierVal}
-                  onChange={(e) => setIdentifierVal(e.target.value)}
-                  onBlur={() => saveMeta('identifier', identifierVal)}
-                  inputProps={{
-                    style: { fontFamily: 'Newsreader', fontWeight: 500 },
-                  }}
-                />
-              ),
-            })
             fields.push({
               label: 'Reference #',
               value: payment.refNumber ? (
@@ -439,8 +551,8 @@ export default function PaymentDetail({
                   size="small"
                   value={refVal}
                   onChange={(e) => setRefVal(e.target.value)}
-                  onBlur={() => saveMeta('refNumber', refVal)}
                   inputProps={{
+                    'data-testid': 'detail-ref-input',
                     style: { fontFamily: 'Newsreader', fontWeight: 500 },
                   }}
                 />
@@ -776,7 +888,7 @@ export default function PaymentDetail({
       <Box
         className="dialog-footer"
         data-testid="dialog-footer"
-        sx={{ p: 1, display: 'flex', justifyContent: 'space-between' }}
+        sx={{ p: 1, display: 'flex', justifyContent: 'space-between', gap: 1 }}
       >
         <Button
           variant="text"
@@ -789,17 +901,31 @@ export default function PaymentDetail({
         >
           ← Back
         </Button>
-        {remaining > 0 && (
-          <Button
-            variant="contained"
-            onClick={handleAssign}
-            disabled={
-              assigning || totalSelected === 0 || totalSelected > remaining
-            }
-          >
-            Assign
-          </Button>
-        )}
+        <Box sx={{ display: 'flex', gap: 1 }}>
+          {needsMeta && (
+            <Button
+              variant="contained"
+              onClick={saveMetaDetails}
+              disabled={
+                !entityVal || (isErl && (!bankCodeVal || !accountIdVal))
+              }
+              data-testid="detail-save"
+            >
+              Save
+            </Button>
+          )}
+          {remaining > 0 && (
+            <Button
+              variant="contained"
+              onClick={handleAssign}
+              disabled={
+                assigning || totalSelected === 0 || totalSelected > remaining
+              }
+            >
+              Assign
+            </Button>
+          )}
+        </Box>
       </Box>
     </Box>
   )
diff --git a/components/StudentDialog/SessionsTab.tsx b/components/StudentDialog/SessionsTab.tsx
index 87e8434..f67f863 100644
--- a/components/StudentDialog/SessionsTab.tsx
+++ b/components/StudentDialog/SessionsTab.tsx
@@ -33,6 +33,7 @@ import { formatMMMDDYYYY } from '../../lib/date'
 import { PATHS, logPath } from '../../lib/paths'
 import { useSession } from 'next-auth/react'
 import { useColumnWidths } from '../../lib/useColumnWidths'
+import { sessionsComparator } from '../../lib/sessionsSort'
 import { toHKMidnight } from '../../lib/time'
 
 console.log('=== StudentDialog loaded version 1.1 ===')
@@ -148,36 +149,33 @@ export default function SessionsTab({
   })
   const [hover, setHover] = useState(false)
   const [voucherBalance, setVoucherBalance] = useState<number | null>(null)
-  const [sortBy, setSortBy] = useState<string>('date')
-  const [sortDir, setSortDir] = useState<'asc' | 'desc'>('desc')
-  const handleSort = (key: string) => {
-    if (sortBy === key) {
-      setSortDir((d) => (d === 'asc' ? 'desc' : 'asc'))
-    } else {
-      setSortBy(key)
-      setSortDir('asc')
+  const sortStorageKey = `sessions:sort:${userEmail}`
+  const getInitialSort = () => {
+    if (typeof window === 'undefined') return { by: 'date', dir: 'desc' }
+    try {
+      const raw = localStorage.getItem(sortStorageKey)
+      if (raw) {
+        const parsed = JSON.parse(raw)
+        if (parsed.by && parsed.dir) return parsed
+      }
+    } catch {
+      // ignore
     }
+    return { by: 'date', dir: 'desc' }
   }
-  const sortVal = (s: any, key: string) => {
-    switch (key) {
-      case 'date':
-      case 'time':
-        return s.startMs || 0
-      case 'duration':
-      case 'baseRate':
-        return Number(s[key]) || 0
-      case 'rateCharged':
-        return Number(s.rateSort) || 0
-      case 'payOn':
-        return s.payOnMs || 0
-      case 'paymentStatus':
-      case 'sessionType':
-      case 'billingType':
-      case 'voucherBalance':
-        return Number(s[key]) || 0
-      default:
-        return 0
+  const [{ by: sortBy, dir: sortDir }, setSort] = useState(getInitialSort)
+  useEffect(() => {
+    if (typeof window !== 'undefined') {
+      localStorage.setItem(
+        sortStorageKey,
+        JSON.stringify({ by: sortBy, dir: sortDir }),
+      )
     }
+  }, [sortBy, sortDir, sortStorageKey])
+  const handleSort = (key: string) => {
+    setSort((prev) =>
+      prev.by === key ? { by: key, dir: prev.dir === 'asc' ? 'desc' : 'asc' } : { by: key, dir: 'asc' },
+    )
   }
 
   useEffect(() => {
@@ -750,6 +748,13 @@ export default function SessionsTab({
                       data-col={c.key}
                       data-col-header
                       title={c.label}
+                      aria-sort={
+                        sortBy === c.key
+                          ? sortDir === 'asc'
+                            ? 'ascending'
+                            : 'descending'
+                          : 'none'
+                      }
                       sx={{
                         typography: 'body2',
                         fontFamily: 'Cantata One',
@@ -802,13 +807,7 @@ export default function SessionsTab({
                   const since = Date.now() - days * 24 * 60 * 60 * 1000
                   return s.startMs >= since
                 })
-                .sort((a, b) => {
-                  const av = sortVal(a, sortBy)
-                  const bv = sortVal(b, sortBy)
-                  if (av < bv) return sortDir === 'asc' ? -1 : 1
-                  if (av > bv) return sortDir === 'asc' ? 1 : -1
-                  return 0
-                })
+                .sort(sessionsComparator(sortBy, sortDir))
                 .map((s, i) => (
                   <TableRow
                     key={i}
diff --git a/lib/promptId.ts b/lib/promptId.ts
index 65884c8..7d3e59c 100644
--- a/lib/promptId.ts
+++ b/lib/promptId.ts
@@ -1 +1 @@
-export const CURRENT_PROMPT_ID = 'P-027-03r'
+export const CURRENT_PROMPT_ID = 'P-027-04r'
diff --git a/lib/sessionsSort.test.ts b/lib/sessionsSort.test.ts
new file mode 100644
index 0000000..034dbc9
--- /dev/null
+++ b/lib/sessionsSort.test.ts
@@ -0,0 +1,19 @@
+import { sessionsComparator } from './sessionsSort'
+
+describe('sessionsComparator', () => {
+  const rows = [
+    { startMs: 1, sessionType: 'A', rateCharged: 200 },
+    { startMs: 2, sessionType: 'B', rateCharged: 100 },
+  ]
+
+  test('sorts numeric columns', () => {
+    const sorted = [...rows].sort(sessionsComparator('rateCharged', 'asc'))
+    expect(sorted[0].rateCharged).toBe(100)
+  })
+
+  test('sorts text columns', () => {
+    const sorted = [...rows].sort(sessionsComparator('sessionType', 'desc'))
+    expect(sorted[0].sessionType).toBe('B')
+  })
+})
+
diff --git a/lib/sessionsSort.ts b/lib/sessionsSort.ts
new file mode 100644
index 0000000..d3fa4f6
--- /dev/null
+++ b/lib/sessionsSort.ts
@@ -0,0 +1,32 @@
+export function sessionSortValue(row: any, key: string): number | string {
+  switch (key) {
+    case 'date':
+    case 'time':
+      return row.startMs || 0
+    case 'duration':
+    case 'baseRate':
+    case 'rateCharged':
+      return Number(row[key]) || 0
+    case 'payOn':
+      return row.payOnMs || 0
+    default:
+      return (row[key] || '').toString().toLowerCase()
+  }
+}
+
+export function sessionsComparator(
+  key: string,
+  dir: 'asc' | 'desc',
+): (a: any, b: any) => number {
+  return (a, b) => {
+    const av = sessionSortValue(a, key)
+    const bv = sessionSortValue(b, key)
+    if (typeof av === 'number' && typeof bv === 'number') {
+      return dir === 'asc' ? av - bv : bv - av
+    }
+    return dir === 'asc'
+      ? String(av).localeCompare(String(bv))
+      : String(bv).localeCompare(String(av))
+  }
+}
+
diff --git a/pages/dashboard/businesses/coaching-sessions.test.tsx b/pages/dashboard/businesses/coaching-sessions.test.tsx
new file mode 100644
index 0000000..ef150d8
--- /dev/null
+++ b/pages/dashboard/businesses/coaching-sessions.test.tsx
@@ -0,0 +1,49 @@
+/**
+ * @jest-environment jsdom
+ */
+import React from 'react'
+import '@testing-library/jest-dom'
+import { render, screen } from '@testing-library/react'
+import CoachingSessions from './coaching-sessions'
+
+jest.mock('firebase/firestore', () => ({
+  collection: jest.fn(),
+  getDocs: jest.fn(async () => ({ docs: [] })),
+  query: jest.fn(),
+  where: jest.fn(),
+  orderBy: jest.fn(),
+  limit: jest.fn(),
+  onSnapshot: jest.fn(() => () => {}),
+  doc: jest.fn(),
+}))
+jest.mock('../../../lib/firebase', () => ({ db: {} }))
+jest.mock('../../../lib/paths', () => ({ PATHS: {}, logPath: jest.fn() }))
+jest.mock('../../../components/StudentDialog/OverviewTab', () => () => null)
+jest.mock('../../../components/StudentDialog/SessionDetail', () => () => null)
+jest.mock('../../../components/StudentDialog/FloatingWindow', () => ({ children }: any) => (
+  <div>{children}</div>
+))
+jest.mock('../../../lib/sessionStats', () => ({ clearSessionSummaries: jest.fn() }))
+jest.mock('../../../lib/sessions', () => ({ computeSessionStart: jest.fn() }))
+jest.mock('../../../lib/billing/useBilling', () => ({ useBilling: () => ({ data: null, isLoading: false }) }))
+jest.mock('../../../components/LoadingDash', () => () => null)
+jest.mock('../../../lib/scanLogs', () => ({
+  readScanLogs: jest.fn(async () => null),
+  writeScanLog: jest.fn(),
+}))
+jest.mock('next-auth/react', () => ({
+  useSession: () => ({ data: null, status: 'unauthenticated' }),
+}))
+
+describe('coaching sessions card view', () => {
+  it('renders settings button inside footer row and badge', () => {
+    render(<CoachingSessions />)
+    const footer = screen.getByTestId('card-footer-row')
+    const settings = screen.getByTestId('settings-3dots')
+    expect(footer).toContainElement(settings)
+    expect(screen.getByTestId('pprompt-badge-card').textContent).toBe(
+      'P-027-04r',
+    )
+  })
+})
+
diff --git a/pages/dashboard/businesses/coaching-sessions.tsx b/pages/dashboard/businesses/coaching-sessions.tsx
index 02546c0..0334f8c 100644
--- a/pages/dashboard/businesses/coaching-sessions.tsx
+++ b/pages/dashboard/businesses/coaching-sessions.tsx
@@ -1,7 +1,16 @@
 // pages/dashboard/businesses/coaching-sessions.tsx
 
 import React, { useEffect, useState } from 'react'
-import { collection, getDocs, query, where, orderBy, limit, onSnapshot, doc } from 'firebase/firestore'
+import {
+  collection,
+  getDocs,
+  query,
+  where,
+  orderBy,
+  limit,
+  onSnapshot,
+  doc,
+} from 'firebase/firestore'
 import SidebarLayout from '../../../components/SidebarLayout'
 import { db } from '../../../lib/firebase'
 import {
@@ -17,6 +26,7 @@ import {
   MenuItem,
   Snackbar,
   CircularProgress,
+  IconButton,
 } from '@mui/material'
 import { PATHS, logPath } from '../../../lib/paths'
 import OverviewTab from '../../../components/StudentDialog/OverviewTab'
@@ -24,11 +34,11 @@ import SessionDetail from '../../../components/StudentDialog/SessionDetail'
 import FloatingWindow from '../../../components/StudentDialog/FloatingWindow'
 import { clearSessionSummaries } from '../../../lib/sessionStats'
 import { computeSessionStart } from '../../../lib/sessions'
-import IconButton from '@mui/material/IconButton'
 import MoreVertIcon from '@mui/icons-material/MoreVert'
 import { useBilling } from '../../../lib/billing/useBilling'
 import LoadingDash from '../../../components/LoadingDash'
 import { readScanLogs, writeScanLog, ScanLog } from '../../../lib/scanLogs'
+import { CURRENT_PROMPT_ID } from '../../../lib/promptId'
 
 interface StudentMeta {
   abbr: string
@@ -322,6 +332,21 @@ export default function CoachingSessions() {
       )}
 
       <Box sx={{ position: 'relative', pb: 8 }}>
+        <Box
+          data-testid="pprompt-badge-card"
+          sx={{
+            position: 'absolute',
+            top: 4,
+            right: 8,
+            fontFamily: 'var(--font-nunito)',
+            fontWeight: 200,
+            fontSize: '10px',
+            opacity: 0.6,
+            pointerEvents: 'none',
+          }}
+        >
+          {CURRENT_PROMPT_ID}
+        </Box>
         <Grid container spacing={2} sx={{ mt: 2 }}>
           {students.map((s) => (
             <StudentCard key={s.abbr} student={s} onSelect={setSelected} />
@@ -371,7 +396,18 @@ export default function CoachingSessions() {
             </Typography>
           </Box>
         </Menu>
-        <Box sx={{ position: 'sticky', bottom: 0, pl: 1, pb: 1 }}>
+        <Box
+          data-testid="card-footer-row"
+          sx={{
+            position: 'sticky',
+            bottom: 0,
+            left: 0,
+            display: 'flex',
+            alignItems: 'center',
+            justifyContent: 'space-between',
+            p: 1,
+          }}
+        >
           <IconButton
             aria-label="Tools"
             onClick={openToolsMenu}
@@ -380,6 +416,16 @@ export default function CoachingSessions() {
           >
             <MoreVertIcon />
           </IconButton>
+          <Button
+            variant="contained"
+            onClick={() => setServiceMode((m) => !m)}
+            sx={{
+              bgcolor: serviceMode ? 'red' : 'primary.main',
+              animation: serviceMode ? 'blink 1s infinite' : 'none',
+            }}
+          >
+            Service Mode
+          </Button>
         </Box>
       </Box>
 
@@ -420,19 +466,6 @@ export default function CoachingSessions() {
         message={scanMessage}
         autoHideDuration={4000}
       />
-      <Button
-        variant="contained"
-        sx={{
-          position: 'fixed',
-          bottom: 16,
-          right: 16,
-          bgcolor: serviceMode ? 'red' : 'primary.main',
-          animation: serviceMode ? 'blink 1s infinite' : 'none',
-        }}
-        onClick={() => setServiceMode((m) => !m)}
-      >
-        Service Mode
-      </Button>
     </SidebarLayout>
   )
 }
diff --git a/prompts/p-027-04r.md b/prompts/p-027-04r.md
new file mode 100644
index 0000000..ab8aab3
--- /dev/null
+++ b/prompts/p-027-04r.md
@@ -0,0 +1,94 @@
+# P-027-04r — Add Payment cascade UI (detail), sticky Back, 3-dots placement, single Remaining blink, sessions sorting, card-view badge
+
+## Background
+Recent merges show identifier-normalization work and helpers, but the visible UI is still missing:
+- Entity → Bank → Bank Account **dropdowns** are not showing in Payment **Detail**.
+- The Back control is not reliably inside the **sticky footer**.
+- The **3-dots settings** button is not anchored correctly to the bottom-left **inside** the white card; it drifts toward the sidebar.
+- **Remaining** still risks double-render blink.
+- Sessions tab lacks **sorting**.
+- Keep the small “P-prompt” badge visible in the **card view** page (top-right).
+
+> PR-226 was docs-only; PR-227 title claims cascade UI, but the dropdowns aren’t visible in the app yet. Ensure UI is truly present and testable.
+
+## Deliverables
+
+### 1) Sticky footer & Back placement (StudentDialog)
+- Render **Back** inside the sticky footer/action bar (same container as primary actions).
+- Ensure the **dialog body** is the scroll container; add bottom padding equal to footer height so content is never obscured.
+- CSS (adapt to theme):
+  position: sticky; bottom: 0; z-index: 10;
+  border-top: 1px solid var(--mui-palette-divider);
+  box-shadow: 0 -2px 8px rgba(0,0,0,.04);
+  background: inherit;
+- Add test ids: `data-testid="dialog-footer"`, `data-testid="back-button"`.
+
+### 2) 3-dots settings button — exact placement inside card
+- Button must be **sticky to the bottom-left inside the white card** (NOT in the sidebar; NOT relative to page/viewport).
+- Implementation requirements:
+  - The **card container** is `position: relative;`.
+  - The 3-dots wrapper is **within that card** and uses `position: sticky; bottom: 0; left: 0;` (or a card-internal sticky area) so it tracks the card’s bottom edge.
+  - Layout aligns the 3-dots button to the **same Y/baseline** as any bottom controls (e.g., “Service Mode” if present in that card’s footer row). Use a card-footer flex row: `display: flex; align-items: center; justify-content: space-between;`.
+  - Add `data-testid="settings-3dots"` and `data-testid="card-footer-row"`.
+- Do not position it relative to the page/sidebar. Visual regression: the left edge of the button must remain **inside** the card’s padding box.
+
+### 3) Remaining blink — single element only
+- **Payment Amount** never blinks.
+- **Remaining** renders **once** with the blink class (e.g., `.blink-remaining`).
+- Remove any duplicate elements/spans; expose `data-testid="remaining-amount"`.
+- Respect reduced-motion.
+
+### 4) Payment **Detail** — Entity/Bank/Account dropdown **editing-on-empty**
+- In the **selected Payment** detail panel:
+  - When a field is **empty**, show edit controls:
+    - **Entity** (select): `Music Establish (ERL)` | `Personal`. (`data-testid="detail-entity-select"`)
+    - If ERL:
+      - **Bank** (select): list ERL banks labeled `{bankName} {bankCode}` (fallback `{docId} {collectionId}`). (`data-testid="detail-bank-select"`)
+      - **Bank Account** (select): dependent on bank; list accounts labeled by `accountType`, value=`accountDocId`. (`data-testid="detail-bank-account-select"`)
+    - **Reference Number** (text). (`data-testid="detail-ref-input"`)
+  - On **Save/Submit** in detail:
+    - Validate: `entity` required; if ERL then `bankCode` + `accountDocId` required.
+    - Write fields; compute **`identifier = "{bankCode}/{accountDocId}"`** for ERL.
+    - Stamp `timestamp` & `editedBy`.
+    - If user-entered identifier exists but fails `/^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/`, recompute from bank/account.
+  - When a field becomes non-empty, render it **read-only** (per earlier spec). Add a small “Edit anyway” affordance **behind a confirm dialog** if you need to override (optional, only if already present pattern).
+
+> Keep the Add Payment dialog cascade as implemented/queued; this item covers editing missing metadata in the **detail** view specifically.
+
+### 5) Sessions tab — sorting
+- Add column sorting to the **Sessions** table:
+  - Click header toggles asc/desc; keyboard accessible; ARIA `aria-sort` reflects state.
+  - Persist last sort per user (reuse your user settings store).
+  - Default sort unchanged unless user sets one.
+  - Keep min-width/ellipsis behavior intact.
+
+### 6) Badge in **card view** (top-right)
+- Render a tiny text badge at the **top-right of the card view page** showing the current prompt id: **“P-027-04r”**.
+- Style: font `Nunito`, weight 200 (ExtraLight), size 10–11px, opacity ~0.6; pointer-events: none.
+- `data-testid="pprompt-badge-card"`
+
+### 7) ERL helpers
+- Ensure `lib/erlDirectory.ts` provides:
+  - `listBanks(): Promise<Array<{ bankCode: string; bankName?: string }>>`
+  - `listAccounts(bankCode: string): Promise<Array<{ accountDocId: string; accountType?: string }>>`
+- Graceful fallback between both Firestore shapes (new `banks/{bankCode}` and legacy `bankAccount/{bankCode}/accounts/*`). No secrets in code.
+
+## Tests (no placeholders)
+### Unit
+- normalizeIdentifier: valid/invalid + ERL enforcement.
+- ERL label builders + fallbacks.
+- Sessions sort comparator (at least one numeric/date and one text column).
+
+### Cypress / component
+1) **Sticky Back**: `data-testid="back-button"` is inside `data-testid="dialog-footer"` and remains visible while body scrolls.
+2) **3-dots**: `data-testid="settings-3dots"` stays within `data-testid="card-footer-row"` and visually inside the card (check bounding rect).
+3) **Blink**: after selection change, only `data-testid="remaining-amount"` has blink class; Amount never blinks.
+4) **Detail editing**: with empty metadata, entity/bank/account dropdowns appear; pick values → Save → verify document writes `entity`, `bankCode`, `accountDocId`, `identifier`, `refNumber`, `timestamp`, `editedBy`; fields turn read-only.
+5) **Sessions sorting**: clicking a header toggles sort; `aria-sort` updates; order reflects comparator; state persists across refresh.
+6) **Badge**: `data-testid="pprompt-badge-card"` shows “P-027-04r” on the card view page.
+
+> Keep specs committed. If CI lacks GUI deps, guard with conditional skip. Do not edit workflows.
+
+## Acceptance
+- Back in sticky footer; 3-dots anchored bottom-left **inside** card; Remaining single-render; detail cascade editing works (write+lock); sessions sortable; badge shows “P-027-04r”; no new TS errors.
+
```
