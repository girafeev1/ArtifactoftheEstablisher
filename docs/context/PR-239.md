# PR #239 â€” Diff Summary

- **Base (target)**: `8d50046ab297e5ab96c9c27774f299917a3a2503`
- **Head (source)**: `20a9f99ce178b4fa8005ba206a888e560c2317c3`
- **Repo**: `girafeev1/ArtifactoftheEstablisher`

## Changed Files

```txt
M	components/StudentDialog/PaymentDetail.test.tsx
M	components/StudentDialog/PaymentDetail.tsx
A	components/StudentDialog/PaymentHistory.test.tsx
M	components/StudentDialog/PaymentHistory.tsx
M	components/StudentDialog/PaymentModal.test.tsx
M	components/StudentDialog/PaymentModal.tsx
M	cypress/e2e/add_payment_cascade.cy.tsx
A	lib/columnPrefs.ts
M	lib/erlDirectory.test.ts
M	lib/erlDirectory.ts
M	lib/paths.ts
M	pages/dashboard/businesses/coaching-sessions.tsx
M	styles/studentDialog.css
```

## Stats

```txt
 components/StudentDialog/PaymentDetail.test.tsx  |   2 +-
 components/StudentDialog/PaymentDetail.tsx       |   6 +
 components/StudentDialog/PaymentHistory.test.tsx |  66 ++
 components/StudentDialog/PaymentHistory.tsx      | 751 +++++++++++++----------
 components/StudentDialog/PaymentModal.test.tsx   |   2 +-
 components/StudentDialog/PaymentModal.tsx        |   6 +
 cypress/e2e/add_payment_cascade.cy.tsx           |   6 +-
 lib/columnPrefs.ts                               |  25 +
 lib/erlDirectory.test.ts                         | 144 +----
 lib/erlDirectory.ts                              |  14 +-
 lib/paths.ts                                     |   7 +-
 pages/dashboard/businesses/coaching-sessions.tsx |   6 +-
 styles/studentDialog.css                         |   4 +-
 13 files changed, 559 insertions(+), 480 deletions(-)
```

## Unified Diff (truncated to first 4000 lines)

```diff
diff --git a/components/StudentDialog/PaymentDetail.test.tsx b/components/StudentDialog/PaymentDetail.test.tsx
index 1dd6aa0..52a9655 100644
--- a/components/StudentDialog/PaymentDetail.test.tsx
+++ b/components/StudentDialog/PaymentDetail.test.tsx
@@ -36,7 +36,7 @@ jest.mock('../../lib/erlDirectory', () => ({
   listAccounts: jest
     .fn()
     .mockResolvedValue([{ accountDocId: 'A1', accountType: 'Savings' }]),
-  buildBankLabel: (b: any) => `${b.bankName || ''} ${b.bankCode}`.trim(),
+  buildBankLabel: (b: any) => `${b.bankName || ''} (${b.bankCode})`.trim(),
 }))
 
 describe('PaymentDetail', () => {
diff --git a/components/StudentDialog/PaymentDetail.tsx b/components/StudentDialog/PaymentDetail.tsx
index ea043f6..a582681 100644
--- a/components/StudentDialog/PaymentDetail.tsx
+++ b/components/StudentDialog/PaymentDetail.tsx
@@ -163,6 +163,12 @@ export default function PaymentDetail({
     }
   }, [isErl, selectedBank])
 
+  useEffect(() => {
+    if (accountIdVal && process.env.NODE_ENV !== 'production') {
+      console.debug('[edit-payment] account selected', accountIdVal)
+    }
+  }, [accountIdVal])
+
 
   const assignedSet = new Set(assignedSessionIds)
   const allRows = bill
diff --git a/components/StudentDialog/PaymentHistory.test.tsx b/components/StudentDialog/PaymentHistory.test.tsx
new file mode 100644
index 0000000..e850e7a
--- /dev/null
+++ b/components/StudentDialog/PaymentHistory.test.tsx
@@ -0,0 +1,66 @@
+/**
+ * @jest-environment jsdom
+ */
+import React from 'react'
+import '@testing-library/jest-dom'
+import { render, screen, waitFor } from '@testing-library/react'
+import PaymentHistory from './PaymentHistory'
+
+jest.mock('./PaymentModal', () => () => <div />)
+
+jest.mock('firebase/firestore', () => ({
+  collection: jest.fn(),
+  orderBy: jest.fn(),
+  query: jest.fn(),
+  onSnapshot: (q: any, next: any) => {
+    next({ docs: [] })
+    return jest.fn()
+  },
+  initializeFirestore: jest.fn(),
+  getFirestore: jest.fn(),
+}))
+
+jest.mock('../../lib/firebase', () => ({ db: {} }))
+jest.mock('../../lib/billing/useBilling', () => ({ useBilling: () => ({}) }))
+jest.mock('next-auth/react', () => ({
+  useSession: () => ({ data: { user: { email: 'tester@example.com' } } }),
+}))
+jest.mock('../../lib/paths', () => ({ PATHS: { payments: () => 'p' }, logPath: jest.fn() }))
+jest.mock('../../lib/useColumnWidths', () => ({
+  useColumnWidths: () => ({
+    widths: {
+      paymentMade: 140,
+      amount: 130,
+      method: 120,
+      entity: 160,
+      identifier: 160,
+      refNumber: 160,
+      session: 180,
+    },
+    startResize: jest.fn(),
+    dblClickResize: jest.fn(),
+    keyResize: jest.fn(),
+  }),
+}))
+
+test('shows default columns', async () => {
+  window.localStorage.clear()
+  render(
+    <PaymentHistory
+      abbr="A"
+      account="B"
+      active
+      onTitleChange={() => {}}
+    />,
+  )
+  await waitFor(() =>
+    expect(screen.getByText('No payments recorded.')).toBeInTheDocument(),
+  )
+  expect(screen.getByText('Date')).toBeInTheDocument()
+  expect(screen.getByText('Amount')).toBeInTheDocument()
+  expect(screen.getByText('For Session(s)')).toBeInTheDocument()
+  expect(screen.queryByText('Method')).not.toBeInTheDocument()
+  expect(screen.queryByText('Entity')).not.toBeInTheDocument()
+  expect(screen.queryByText('Bank Account')).not.toBeInTheDocument()
+  expect(screen.queryByText('Reference #')).not.toBeInTheDocument()
+})
diff --git a/components/StudentDialog/PaymentHistory.tsx b/components/StudentDialog/PaymentHistory.tsx
index 8d2993f..fdd95d5 100644
--- a/components/StudentDialog/PaymentHistory.tsx
+++ b/components/StudentDialog/PaymentHistory.tsx
@@ -10,6 +10,10 @@ import {
   Typography,
   TableSortLabel,
   Button,
+  Popover,
+  Checkbox,
+  FormGroup,
+  FormControlLabel,
 } from '@mui/material'
 import { collection, orderBy, query, onSnapshot } from 'firebase/firestore'
 import { db } from '../../lib/firebase'
@@ -25,6 +29,8 @@ import { useSession } from 'next-auth/react'
 import { useColumnWidths } from '../../lib/useColumnWidths'
 import Tooltip from '@mui/material/Tooltip'
 import IconButton from '@mui/material/IconButton'
+import FilterListIcon from '@mui/icons-material/FilterList'
+import { readColumnPrefs, writeColumnPrefs } from '../../lib/columnPrefs'
 
 const formatCurrency = (n: number) =>
   new Intl.NumberFormat(undefined, {
@@ -78,6 +84,23 @@ export default function PaymentHistory({
     { key: 'refNumber', label: 'Reference #', width: 160 },
     { key: 'session', label: 'For Session(s)', width: 180 },
   ] as const
+  const defaultVisible = columns.reduce((acc, c) => {
+    acc[c.key] = ['paymentMade', 'amount', 'session'].includes(c.key)
+    return acc
+  }, {} as Record<string, boolean>)
+  const prefsKey = `pms:ph:cols:${userEmail}`
+  const [visible, setVisible] = useState<Record<string, boolean>>(() =>
+    readColumnPrefs(prefsKey, defaultVisible),
+  )
+  useEffect(() => {
+    setVisible(readColumnPrefs(prefsKey, defaultVisible))
+  }, [prefsKey])
+  const toggleCol = (k: string) => {
+    const next = { ...visible, [k]: !visible[k] }
+    setVisible(next)
+    writeColumnPrefs(prefsKey, next)
+  }
+  const [filterAnchor, setFilterAnchor] = useState<HTMLElement | null>(null)
   const { widths, startResize, dblClickResize, keyResize } = useColumnWidths(
     'payments',
     columns,
@@ -130,6 +153,11 @@ export default function PaymentHistory({
     return sortAsc ? av - bv : bv - av
   })
 
+  const visibleCount = columns.reduce(
+    (acc, c) => acc + (visible[c.key] ? 1 : 0),
+    0,
+  )
+
   if (detail)
     return (
       <Box sx={{ height: '100%' }}>
@@ -150,23 +178,58 @@ export default function PaymentHistory({
           <CircularProgress />
         ) : (
           <>
-            <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>
+            <Box
+              sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}
+            >
               <Typography
                 variant="subtitle1"
                 sx={{ fontFamily: 'Cantata One', textDecoration: 'underline' }}
               >
                 Payment History
               </Typography>
-              <Tooltip title="Add Payment">
-                <IconButton
-                  color="primary"
-                  onClick={() => setModalOpen(true)}
-                  aria-label="Add Payment"
-                >
-                  <WriteIcon fontSize="small" />
-                </IconButton>
-              </Tooltip>
+              <Box>
+                <Tooltip title="Filter Columns">
+                  <IconButton
+                    aria-label="Filter Columns"
+                    data-testid="filter-columns"
+                    onClick={(e) => setFilterAnchor(e.currentTarget)}
+                    sx={{ mr: 1 }}
+                  >
+                    <FilterListIcon fontSize="small" />
+                  </IconButton>
+                </Tooltip>
+                <Tooltip title="Add Payment">
+                  <IconButton
+                    color="primary"
+                    onClick={() => setModalOpen(true)}
+                    aria-label="Add Payment"
+                  >
+                    <WriteIcon fontSize="small" />
+                  </IconButton>
+                </Tooltip>
+              </Box>
             </Box>
+            <Popover
+              open={Boolean(filterAnchor)}
+              anchorEl={filterAnchor}
+              onClose={() => setFilterAnchor(null)}
+              anchorOrigin={{ vertical: 'bottom', horizontal: 'right' }}
+            >
+              <FormGroup sx={{ p: 2 }}>
+                {columns.map((c) => (
+                  <FormControlLabel
+                    key={c.key}
+                    control={
+                      <Checkbox
+                        checked={visible[c.key]}
+                        onChange={() => toggleCol(c.key)}
+                      />
+                    }
+                    label={c.label}
+                  />
+                ))}
+              </FormGroup>
+            </Popover>
             <Table
               ref={tableRef}
               size="small"
@@ -186,242 +249,256 @@ export default function PaymentHistory({
                 },
               }}
             >
-              <TableHead>
-                <TableRow>
-                <TableCell
-                  data-col="paymentMade"
-                  data-col-header
-                  title="Date"
-                  sx={{
-                    fontFamily: 'Cantata One',
-                    fontWeight: 'bold',
-                    position: 'relative',
-                    width: widths['paymentMade'],
-                    whiteSpace: 'nowrap',
-                    overflow: 'hidden',
-                    textOverflow: 'ellipsis',
-                  }}
-                >
-                  <TableSortLabel
-                    active={sortField === 'paymentMade'}
-                    direction={sortField === 'paymentMade' && sortAsc ? 'asc' : 'desc'}
-                    onClick={() => {
-                      if (sortField === 'paymentMade') setSortAsc((s) => !s)
-                      else {
-                        setSortField('paymentMade')
-                        setSortAsc(false)
-                      }
+            <TableHead>
+              <TableRow>
+                {visible['paymentMade'] && (
+                  <TableCell
+                    data-col="paymentMade"
+                    data-col-header
+                    title="Date"
+                    sx={{
+                      fontFamily: 'Cantata One',
+                      fontWeight: 'bold',
+                      position: 'relative',
+                      width: widths['paymentMade'],
+                      whiteSpace: 'nowrap',
+                      overflow: 'hidden',
+                      textOverflow: 'ellipsis',
                     }}
                   >
-                    Date
-                  </TableSortLabel>
-                  <Box
-                    className="col-resizer"
-                    aria-label="Resize column Payment Date"
-                    role="separator"
-                    tabIndex={0}
-                    onMouseDown={(e) => startResize('paymentMade', e)}
-                    onDoubleClick={() =>
-                      dblClickResize('paymentMade', tableRef.current || undefined)
-                    }
-                    onKeyDown={(e) => {
-                      if (e.key === 'ArrowLeft') keyResize('paymentMade', 'left')
-                      if (e.key === 'ArrowRight') keyResize('paymentMade', 'right')
-                    }}
-                  />
-                </TableCell>
-                <TableCell
-                  data-col="amount"
-                  data-col-header
-                  title="Amount"
-                  sx={{
-                    fontFamily: 'Cantata One',
-                    fontWeight: 'bold',
-                    position: 'relative',
-                    width: widths['amount'],
-                    whiteSpace: 'nowrap',
-                    overflow: 'hidden',
-                    textOverflow: 'ellipsis',
-                  }}
-                >
-                  <TableSortLabel
-                    active={sortField === 'amount'}
-                    direction={sortField === 'amount' && sortAsc ? 'asc' : 'desc'}
-                    onClick={() => {
-                      if (sortField === 'amount') setSortAsc((s) => !s)
-                      else {
-                        setSortField('amount')
-                        setSortAsc(false)
+                    <TableSortLabel
+                      active={sortField === 'paymentMade'}
+                      direction={sortField === 'paymentMade' && sortAsc ? 'asc' : 'desc'}
+                      onClick={() => {
+                        if (sortField === 'paymentMade') setSortAsc((s) => !s)
+                        else {
+                          setSortField('paymentMade')
+                          setSortAsc(false)
+                        }
+                      }}
+                    >
+                      Date
+                    </TableSortLabel>
+                    <Box
+                      className="col-resizer"
+                      aria-label="Resize column Payment Date"
+                      role="separator"
+                      tabIndex={0}
+                      onMouseDown={(e) => startResize('paymentMade', e)}
+                      onDoubleClick={() =>
+                        dblClickResize('paymentMade', tableRef.current || undefined)
                       }
+                      onKeyDown={(e) => {
+                        if (e.key === 'ArrowLeft') keyResize('paymentMade', 'left')
+                        if (e.key === 'ArrowRight') keyResize('paymentMade', 'right')
+                      }}
+                    />
+                  </TableCell>
+                )}
+                {visible['amount'] && (
+                  <TableCell
+                    data-col="amount"
+                    data-col-header
+                    title="Amount"
+                    sx={{
+                      fontFamily: 'Cantata One',
+                      fontWeight: 'bold',
+                      position: 'relative',
+                      width: widths['amount'],
+                      whiteSpace: 'nowrap',
+                      overflow: 'hidden',
+                      textOverflow: 'ellipsis',
                     }}
                   >
-                    Amount
-                  </TableSortLabel>
-                  <Box
-                    className="col-resizer"
-                    aria-label="Resize column Amount"
-                    role="separator"
-                    tabIndex={0}
-                    onMouseDown={(e) => startResize('amount', e)}
-                    onDoubleClick={() =>
-                      dblClickResize('amount', tableRef.current || undefined)
-                    }
-                    onKeyDown={(e) => {
-                      if (e.key === 'ArrowLeft') keyResize('amount', 'left')
-                      if (e.key === 'ArrowRight') keyResize('amount', 'right')
-                    }}
-                  />
-                </TableCell>
-                <TableCell
-                  data-col="method"
-                  data-col-header
-                  title="Method"
-                  sx={{
-                    fontFamily: 'Cantata One',
-                    fontWeight: 'bold',
-                    position: 'relative',
-                    width: widths['method'],
-                    whiteSpace: 'nowrap',
-                    overflow: 'hidden',
-                    textOverflow: 'ellipsis',
-                  }}
-                >
-                  Method
-                  <Box
-                    className="col-resizer"
-                    aria-label="Resize column Method"
-                    role="separator"
-                    tabIndex={0}
-                    onMouseDown={(e) => startResize('method', e)}
-                    onDoubleClick={() =>
-                      dblClickResize('method', tableRef.current || undefined)
-                    }
-                    onKeyDown={(e) => {
-                      if (e.key === 'ArrowLeft') keyResize('method', 'left')
-                      if (e.key === 'ArrowRight') keyResize('method', 'right')
+                    <TableSortLabel
+                      active={sortField === 'amount'}
+                      direction={sortField === 'amount' && sortAsc ? 'asc' : 'desc'}
+                      onClick={() => {
+                        if (sortField === 'amount') setSortAsc((s) => !s)
+                        else {
+                          setSortField('amount')
+                          setSortAsc(false)
+                        }
+                      }}
+                    >
+                      Amount
+                    </TableSortLabel>
+                    <Box
+                      className="col-resizer"
+                      aria-label="Resize column Amount"
+                      role="separator"
+                      tabIndex={0}
+                      onMouseDown={(e) => startResize('amount', e)}
+                      onDoubleClick={() =>
+                        dblClickResize('amount', tableRef.current || undefined)
+                      }
+                      onKeyDown={(e) => {
+                        if (e.key === 'ArrowLeft') keyResize('amount', 'left')
+                        if (e.key === 'ArrowRight') keyResize('amount', 'right')
+                      }}
+                    />
+                  </TableCell>
+                )}
+                {visible['method'] && (
+                  <TableCell
+                    data-col="method"
+                    data-col-header
+                    title="Method"
+                    sx={{
+                      fontFamily: 'Cantata One',
+                      fontWeight: 'bold',
+                      position: 'relative',
+                      width: widths['method'],
+                      whiteSpace: 'nowrap',
+                      overflow: 'hidden',
+                      textOverflow: 'ellipsis',
                     }}
-                  />
-                </TableCell>
-                <TableCell
-                  data-col="entity"
-                  data-col-header
-                  title="Entity"
-                  sx={{
-                    fontFamily: 'Cantata One',
-                    fontWeight: 'bold',
-                    position: 'relative',
-                    width: widths['entity'],
-                    whiteSpace: 'nowrap',
-                    overflow: 'hidden',
-                    textOverflow: 'ellipsis',
-                  }}
-                >
-                  Entity
-                  <Box
-                    className="col-resizer"
-                    aria-label="Resize column Entity"
-                    role="separator"
-                    tabIndex={0}
-                    onMouseDown={(e) => startResize('entity', e)}
-                    onDoubleClick={() =>
-                      dblClickResize('entity', tableRef.current || undefined)
-                    }
-                    onKeyDown={(e) => {
-                      if (e.key === 'ArrowLeft') keyResize('entity', 'left')
-                      if (e.key === 'ArrowRight') keyResize('entity', 'right')
+                  >
+                    Method
+                    <Box
+                      className="col-resizer"
+                      aria-label="Resize column Method"
+                      role="separator"
+                      tabIndex={0}
+                      onMouseDown={(e) => startResize('method', e)}
+                      onDoubleClick={() =>
+                        dblClickResize('method', tableRef.current || undefined)
+                      }
+                      onKeyDown={(e) => {
+                        if (e.key === 'ArrowLeft') keyResize('method', 'left')
+                        if (e.key === 'ArrowRight') keyResize('method', 'right')
+                      }}
+                    />
+                  </TableCell>
+                )}
+                {visible['entity'] && (
+                  <TableCell
+                    data-col="entity"
+                    data-col-header
+                    title="Entity"
+                    sx={{
+                      fontFamily: 'Cantata One',
+                      fontWeight: 'bold',
+                      position: 'relative',
+                      width: widths['entity'],
+                      whiteSpace: 'nowrap',
+                      overflow: 'hidden',
+                      textOverflow: 'ellipsis',
                     }}
-                  />
-                </TableCell>
-                <TableCell
-                  data-col="identifier"
-                  data-col-header
-                  title="Bank Account"
-                  sx={{
-                    fontFamily: 'Cantata One',
-                    fontWeight: 'bold',
-                    position: 'relative',
-                    width: widths['identifier'],
-                    whiteSpace: 'nowrap',
-                    overflow: 'hidden',
-                    textOverflow: 'ellipsis',
-                  }}
-                >
-                  Bank Account
-                  <Box
-                    className="col-resizer"
-                    aria-label="Resize column Bank Account"
-                    role="separator"
-                    tabIndex={0}
-                    onMouseDown={(e) => startResize('identifier', e)}
-                    onDoubleClick={() =>
-                      dblClickResize('identifier', tableRef.current || undefined)
-                    }
-                    onKeyDown={(e) => {
-                      if (e.key === 'ArrowLeft') keyResize('identifier', 'left')
-                      if (e.key === 'ArrowRight') keyResize('identifier', 'right')
+                  >
+                    Entity
+                    <Box
+                      className="col-resizer"
+                      aria-label="Resize column Entity"
+                      role="separator"
+                      tabIndex={0}
+                      onMouseDown={(e) => startResize('entity', e)}
+                      onDoubleClick={() =>
+                        dblClickResize('entity', tableRef.current || undefined)
+                      }
+                      onKeyDown={(e) => {
+                        if (e.key === 'ArrowLeft') keyResize('entity', 'left')
+                        if (e.key === 'ArrowRight') keyResize('entity', 'right')
+                      }}
+                    />
+                  </TableCell>
+                )}
+                {visible['identifier'] && (
+                  <TableCell
+                    data-col="identifier"
+                    data-col-header
+                    title="Bank Account"
+                    sx={{
+                      fontFamily: 'Cantata One',
+                      fontWeight: 'bold',
+                      position: 'relative',
+                      width: widths['identifier'],
+                      whiteSpace: 'nowrap',
+                      overflow: 'hidden',
+                      textOverflow: 'ellipsis',
                     }}
-                  />
-                </TableCell>
-                <TableCell
-                  data-col="refNumber"
-                  data-col-header
-                  title="Reference #"
-                  sx={{
-                    fontFamily: 'Cantata One',
-                    fontWeight: 'bold',
-                    position: 'relative',
-                    width: widths['refNumber'],
-                    whiteSpace: 'nowrap',
-                    overflow: 'hidden',
-                    textOverflow: 'ellipsis',
-                  }}
-                >
-                  Reference #
-                  <Box
-                    className="col-resizer"
-                    aria-label="Resize column Reference #"
-                    role="separator"
-                    tabIndex={0}
-                    onMouseDown={(e) => startResize('refNumber', e)}
-                    onDoubleClick={() =>
-                      dblClickResize('refNumber', tableRef.current || undefined)
-                    }
-                    onKeyDown={(e) => {
-                      if (e.key === 'ArrowLeft') keyResize('refNumber', 'left')
-                      if (e.key === 'ArrowRight') keyResize('refNumber', 'right')
+                  >
+                    Bank Account
+                    <Box
+                      className="col-resizer"
+                      aria-label="Resize column Bank Account"
+                      role="separator"
+                      tabIndex={0}
+                      onMouseDown={(e) => startResize('identifier', e)}
+                      onDoubleClick={() =>
+                        dblClickResize('identifier', tableRef.current || undefined)
+                      }
+                      onKeyDown={(e) => {
+                        if (e.key === 'ArrowLeft') keyResize('identifier', 'left')
+                        if (e.key === 'ArrowRight') keyResize('identifier', 'right')
+                      }}
+                    />
+                  </TableCell>
+                )}
+                {visible['refNumber'] && (
+                  <TableCell
+                    data-col="refNumber"
+                    data-col-header
+                    title="Reference #"
+                    sx={{
+                      fontFamily: 'Cantata One',
+                      fontWeight: 'bold',
+                      position: 'relative',
+                      width: widths['refNumber'],
+                      whiteSpace: 'nowrap',
+                      overflow: 'hidden',
+                      textOverflow: 'ellipsis',
                     }}
-                  />
-                </TableCell>
-                <TableCell
-                  data-col="session"
-                  data-col-header
-                  title="For Session(s)"
-                  sx={{
-                    fontFamily: 'Cantata One',
-                    fontWeight: 'bold',
-                    position: 'relative',
-                    width: widths['session'],
-                    whiteSpace: 'nowrap',
-                    overflow: 'hidden',
-                    textOverflow: 'ellipsis',
-                  }}
-                >
-                  For Session(s)
-                  <Box
-                    className="col-resizer"
-                    aria-label="Resize column For Session(s)"
-                    role="separator"
-                    tabIndex={0}
-                    onMouseDown={(e) => startResize('session', e)}
-                    onDoubleClick={() =>
-                      dblClickResize('session', tableRef.current || undefined)
-                    }
-                    onKeyDown={(e) => {
-                      if (e.key === 'ArrowLeft') keyResize('session', 'left')
-                      if (e.key === 'ArrowRight') keyResize('session', 'right')
+                  >
+                    Reference #
+                    <Box
+                      className="col-resizer"
+                      aria-label="Resize column Reference #"
+                      role="separator"
+                      tabIndex={0}
+                      onMouseDown={(e) => startResize('refNumber', e)}
+                      onDoubleClick={() =>
+                        dblClickResize('refNumber', tableRef.current || undefined)
+                      }
+                      onKeyDown={(e) => {
+                        if (e.key === 'ArrowLeft') keyResize('refNumber', 'left')
+                        if (e.key === 'ArrowRight') keyResize('refNumber', 'right')
+                      }}
+                    />
+                  </TableCell>
+                )}
+                {visible['session'] && (
+                  <TableCell
+                    data-col="session"
+                    data-col-header
+                    title="For Session(s)"
+                    sx={{
+                      fontFamily: 'Cantata One',
+                      fontWeight: 'bold',
+                      position: 'relative',
+                      width: widths['session'],
+                      whiteSpace: 'nowrap',
+                      overflow: 'hidden',
+                      textOverflow: 'ellipsis',
                     }}
-                  />
-                </TableCell>
+                  >
+                    For Session(s)
+                    <Box
+                      className="col-resizer"
+                      aria-label="Resize column For Session(s)"
+                      role="separator"
+                      tabIndex={0}
+                      onMouseDown={(e) => startResize('session', e)}
+                      onDoubleClick={() =>
+                        dblClickResize('session', tableRef.current || undefined)
+                      }
+                      onKeyDown={(e) => {
+                        if (e.key === 'ArrowLeft') keyResize('session', 'left')
+                        if (e.key === 'ArrowRight') keyResize('session', 'right')
+                      }}
+                    />
+                  </TableCell>
+                )}
               </TableRow>
             </TableHead>
             <TableBody>
@@ -431,7 +508,7 @@ export default function PaymentHistory({
                   .map((id: string) => sessionMap[id])
                   .filter((n): n is number => typeof n === 'number')
                   .sort((a, b) => a - b)
-                const { visible, hiddenCount } = truncateList<number>(ords)
+                const { visible: ordVisible, hiddenCount } = truncateList<number>(ords)
                 return (
                   <TableRow
                     key={p.id}
@@ -447,102 +524,122 @@ export default function PaymentHistory({
                     }}
                     sx={{ cursor: 'pointer', py: 1 }}
                   >
-                    <TableCell
-                      data-col="paymentMade"
-                      title={formatDate(p.paymentMade)}
-                      sx={{
-                        fontFamily: 'Newsreader',
-                        fontWeight: 500,
-                        width: widths['paymentMade'],
-                        minWidth: widths['paymentMade'],
-                      }}
-                    >
-                      {formatDate(p.paymentMade)}
-                    </TableCell>
-                    <TableCell
-                      data-col="amount"
-                      title={formatCurrency(amount)}
-                      sx={{
-                        fontFamily: 'Newsreader',
-                        fontWeight: 500,
-                        width: widths['amount'],
-                        minWidth: widths['amount'],
-                      }}
-                    >
-                      {formatCurrency(amount)}
-                    </TableCell>
-                    <TableCell
-                      data-col="method"
-                      title={p.method || 'â€”'}
-                      sx={{
-                        fontFamily: 'Newsreader',
-                        fontWeight: 500,
-                        width: widths['method'],
-                        minWidth: widths['method'],
-                      }}
-                    >
-                      {p.method || 'â€”'}
-                    </TableCell>
-                    <TableCell
-                      data-col="entity"
-                      title={p.entity ? (p.entity === 'ME-ERL' ? 'Music Establish (ERL)' : p.entity) : 'â€”'}
-                      sx={{
-                        fontFamily: 'Newsreader',
-                        fontWeight: 500,
-                        width: widths['entity'],
-                        minWidth: widths['entity'],
-                      }}
-                    >
-                      {p.entity
-                        ? p.entity === 'ME-ERL'
-                          ? 'Music Establish (ERL)'
-                          : p.entity
-                        : 'â€”'}
-                    </TableCell>
-                    <TableCell
-                      data-col="identifier"
-                      title={p.identifier || 'â€”'}
-                      sx={{
-                        fontFamily: 'Newsreader',
-                        fontWeight: 500,
-                        width: widths['identifier'],
-                        minWidth: widths['identifier'],
-                      }}
-                    >
-                      {p.identifier || 'â€”'}
-                    </TableCell>
-                    <TableCell
-                      data-col="refNumber"
-                      title={p.refNumber || 'â€”'}
-                      sx={{
-                        fontFamily: 'Newsreader',
-                        fontWeight: 500,
-                        width: widths['refNumber'],
-                        minWidth: widths['refNumber'],
-                      }}
-                    >
-                      {p.refNumber || 'â€”'}
-                    </TableCell>
-                    <TableCell
-                      data-col="session"
-                      title={formatSessions(ords)}
-                      sx={{
-                        fontFamily: 'Newsreader',
-                        fontWeight: 500,
-                        width: widths['session'],
-                        minWidth: widths['session'],
-                      }}
-                    >
-                      {formatSessions(visible)}
-                      {hiddenCount > 0 && ' â€¦'}
-                    </TableCell>
+                    {visible['paymentMade'] && (
+                      <TableCell
+                        data-col="paymentMade"
+                        title={formatDate(p.paymentMade)}
+                        sx={{
+                          fontFamily: 'Newsreader',
+                          fontWeight: 500,
+                          width: widths['paymentMade'],
+                          minWidth: widths['paymentMade'],
+                        }}
+                      >
+                        {formatDate(p.paymentMade)}
+                      </TableCell>
+                    )}
+                    {visible['amount'] && (
+                      <TableCell
+                        data-col="amount"
+                        title={formatCurrency(amount)}
+                        sx={{
+                          fontFamily: 'Newsreader',
+                          fontWeight: 500,
+                          width: widths['amount'],
+                          minWidth: widths['amount'],
+                        }}
+                      >
+                        {formatCurrency(amount)}
+                      </TableCell>
+                    )}
+                    {visible['method'] && (
+                      <TableCell
+                        data-col="method"
+                        title={p.method || 'â€”'}
+                        sx={{
+                          fontFamily: 'Newsreader',
+                          fontWeight: 500,
+                          width: widths['method'],
+                          minWidth: widths['method'],
+                        }}
+                      >
+                        {p.method || 'â€”'}
+                      </TableCell>
+                    )}
+                    {visible['entity'] && (
+                      <TableCell
+                        data-col="entity"
+                        title={
+                          p.entity
+                            ? p.entity === 'ME-ERL'
+                              ? 'Music Establish (ERL)'
+                              : p.entity
+                            : 'â€”'
+                        }
+                        sx={{
+                          fontFamily: 'Newsreader',
+                          fontWeight: 500,
+                          width: widths['entity'],
+                          minWidth: widths['entity'],
+                        }}
+                      >
+                        {p.entity
+                          ? p.entity === 'ME-ERL'
+                            ? 'Music Establish (ERL)'
+                            : p.entity
+                          : 'â€”'}
+                      </TableCell>
+                    )}
+                    {visible['identifier'] && (
+                      <TableCell
+                        data-col="identifier"
+                        title={p.identifier || 'â€”'}
+                        sx={{
+                          fontFamily: 'Newsreader',
+                          fontWeight: 500,
+                          width: widths['identifier'],
+                          minWidth: widths['identifier'],
+                        }}
+                      >
+                        {p.identifier || 'â€”'}
+                      </TableCell>
+                    )}
+                    {visible['refNumber'] && (
+                      <TableCell
+                        data-col="refNumber"
+                        title={p.refNumber || 'â€”'}
+                        sx={{
+                          fontFamily: 'Newsreader',
+                          fontWeight: 500,
+                          width: widths['refNumber'],
+                          minWidth: widths['refNumber'],
+                        }}
+                      >
+                        {p.refNumber || 'â€”'}
+                      </TableCell>
+                    )}
+                    {visible['session'] && (
+                      <TableCell
+                        data-col="session"
+                        title={formatSessions(ords)}
+                        sx={{
+                          fontFamily: 'Newsreader',
+                          fontWeight: 500,
+                          width: widths['session'],
+                          minWidth: widths['session'],
+                        }}
+                      >
+                        {formatSessions(ordVisible)}
+                        {hiddenCount > 0 && ' â€¦'}
+                      </TableCell>
+                    )}
                   </TableRow>
                 )
               })}
               {sortedPayments.length === 0 && (
                 <TableRow>
                   <TableCell
-                    colSpan={7}
+                    colSpan={visibleCount}
                     sx={{ fontFamily: 'Newsreader', fontWeight: 500 }}
                   >
                     No payments recorded.
diff --git a/components/StudentDialog/PaymentModal.test.tsx b/components/StudentDialog/PaymentModal.test.tsx
index 236e81e..3bc7f17 100644
--- a/components/StudentDialog/PaymentModal.test.tsx
+++ b/components/StudentDialog/PaymentModal.test.tsx
@@ -16,7 +16,7 @@ jest.mock('../../lib/erlDirectory', () => ({
   listAccounts: jest.fn().mockResolvedValue([
     { accountDocId: 'a1', accountType: 'Savings' },
   ]),
-  buildBankLabel: jest.fn((b) => `${b.bankName} ${b.bankCode}`),
+  buildBankLabel: jest.fn((b) => `${b.bankName} (${b.bankCode})`),
 }))
 
 jest.mock('firebase/firestore', () => ({
diff --git a/components/StudentDialog/PaymentModal.tsx b/components/StudentDialog/PaymentModal.tsx
index 98b4232..138e0cd 100644
--- a/components/StudentDialog/PaymentModal.tsx
+++ b/components/StudentDialog/PaymentModal.tsx
@@ -96,6 +96,12 @@ export default function PaymentModal({
     setAccountId('')
   }, [selectedBank])
 
+  useEffect(() => {
+    if (accountId && process.env.NODE_ENV !== 'production') {
+      console.debug('[add-payment] account selected', accountId)
+    }
+  }, [accountId])
+
   const save = async () => {
     const paymentsPath = PATHS.payments(abbr)
     logPath('addPayment', paymentsPath)
diff --git a/cypress/e2e/add_payment_cascade.cy.tsx b/cypress/e2e/add_payment_cascade.cy.tsx
index 8107ab6..83606c4 100644
--- a/cypress/e2e/add_payment_cascade.cy.tsx
+++ b/cypress/e2e/add_payment_cascade.cy.tsx
@@ -58,7 +58,7 @@ describe('Add Payment cascade', () => {
     cy.contains('li', 'Music Establish (ERL)').click()
     cy.get('[data-testid="bank-select"]').should('be.visible')
     cy.get('[data-testid="bank-select"]').parent().click()
-    cy.contains('li', 'Bank 001').click()
+    cy.contains('li', 'Bank (001)').click()
     cy.get('[data-testid="bank-account-select"]').should('be.visible')
   })
 
@@ -88,7 +88,7 @@ describe('Add Payment cascade', () => {
     cy.get('[data-testid="entity-select"]').parent().click()
     cy.contains('li', 'Music Establish (ERL)').click()
     cy.get('[data-testid="bank-select"]').parent().click()
-    cy.contains('li', 'Bank 001').click()
+    cy.contains('li', 'Bank (001)').click()
     cy.get('[data-testid="bank-account-select"]').parent().click()
     cy.contains('li', 'Savings').click()
     cy.get('[data-testid="ref-input"]').type('123')
@@ -135,7 +135,7 @@ describe('Add Payment cascade', () => {
     cy.get('[data-testid="entity-select"]').parent().click()
     cy.contains('li', 'Music Establish (ERL)').click()
     cy.get('[data-testid="bank-select"]').parent().click()
-    cy.contains('li', 'Bank 001').click()
+    cy.contains('li', 'Bank (001)').click()
     cy.get('[data-testid="bank-account-select"]').parent().click()
     cy.contains('li', 'Savings').click()
     cy.get('[data-testid="entity-select"]').parent().click()
diff --git a/lib/columnPrefs.ts b/lib/columnPrefs.ts
new file mode 100644
index 0000000..f5aa984
--- /dev/null
+++ b/lib/columnPrefs.ts
@@ -0,0 +1,25 @@
+export function readColumnPrefs(
+  key: string,
+  defaults: Record<string, boolean>,
+): Record<string, boolean> {
+  if (typeof window === 'undefined') return { ...defaults }
+  try {
+    const raw = window.localStorage.getItem(key)
+    if (raw) return { ...defaults, ...JSON.parse(raw) }
+  } catch {
+    // ignore
+  }
+  return { ...defaults }
+}
+
+export function writeColumnPrefs(
+  key: string,
+  prefs: Record<string, boolean>,
+): void {
+  if (typeof window === 'undefined') return
+  try {
+    window.localStorage.setItem(key, JSON.stringify(prefs))
+  } catch {
+    // ignore
+  }
+}
diff --git a/lib/erlDirectory.test.ts b/lib/erlDirectory.test.ts
index 1d841d2..ab4b9ac 100644
--- a/lib/erlDirectory.test.ts
+++ b/lib/erlDirectory.test.ts
@@ -1,141 +1,7 @@
-import {
-  buildBankLabel,
-  listBanks,
-  listAccounts,
-  normalizeCode,
-} from './erlDirectory'
-import { collection, getDocs } from 'firebase/firestore'
+import { normalizeCode, buildBankLabel } from './erlDirectory'
 
-jest.mock('./firebase', () => ({ app: {} }))
-
-jest.mock('firebase/firestore', () => ({
-  getFirestore: jest.fn(() => ({})),
-  initializeFirestore: jest.fn(() => ({})),
-  collection: jest.fn((_: any, ...parts: string[]) => parts.join('/')),
-  getDocs: jest.fn(),
-}))
-
-describe('buildBankLabel', () => {
-  test('uses name and code when available', () => {
-    expect(
-      buildBankLabel({ bankName: 'HK Bank', bankCode: '012', rawCodeSegment: '(012)' }),
-    ).toBe('HK Bank 012')
-  })
-
-  test('falls back to code when name missing', () => {
-    expect(buildBankLabel({ bankCode: '012', bankName: '', rawCodeSegment: '(012)' })).toBe(
-      '012',
-    )
-  })
-})
-
-describe('normalizeCode', () => {
-  test('normalizes various inputs', () => {
-    expect(normalizeCode(40)).toEqual({ code: '040', raw: '(040)' })
-    expect(normalizeCode('040')).toEqual({ code: '040', raw: '(040)' })
-    expect(normalizeCode('(040)')).toEqual({ code: '040', raw: '(040)' })
-  })
-})
-
-describe('listBanks', () => {
-  beforeEach(() => {
-    ;(getDocs as jest.Mock).mockReset()
-    ;(collection as jest.Mock).mockClear()
-  })
-
-  test('returns banks collection when present', async () => {
-    ;(getDocs as jest.Mock).mockResolvedValueOnce({
-      docs: [{ id: '001', data: () => ({ name: 'Bank1' }) }],
-    })
-    const res = await listBanks()
-    expect(collection).toHaveBeenCalledWith(expect.anything(), 'banks')
-    expect(res).toEqual([
-      {
-        bankCode: '001',
-        bankName: 'Bank1',
-        rawCodeSegment: '(001)',
-      },
-    ])
-  })
-
-  test('falls back to bankAccount collection using code field', async () => {
-    ;(getDocs as jest.Mock)
-      .mockResolvedValueOnce({ docs: [] })
-      .mockResolvedValueOnce({
-        docs: [
-          { id: 'Dah Sing Bank', data: () => ({ code: [40, 12, 40] }) },
-        ],
-      })
-    const res = await listBanks()
-    expect(collection).toHaveBeenCalledWith(expect.anything(), 'bankAccount')
-    expect(res).toEqual([
-      { bankCode: '040', bankName: 'Dah Sing Bank', rawCodeSegment: '(040)' },
-      { bankCode: '012', bankName: 'Dah Sing Bank', rawCodeSegment: '(012)' },
-    ])
-  })
-})
-
-describe('listAccounts', () => {
-  beforeEach(() => {
-    ;(getDocs as jest.Mock).mockReset()
-    ;(collection as jest.Mock).mockClear()
-  })
-
-  test('returns accounts under banks/{code} when present', async () => {
-    ;(getDocs as jest.Mock)
-      .mockResolvedValueOnce({
-        docs: [{ id: 'a1', data: () => ({ accountType: 'chk' }) }],
-      })
-      .mockResolvedValueOnce({ docs: [] })
-    const res = await listAccounts({
-      bankCode: '001',
-      bankName: 'Bank',
-      rawCodeSegment: '(001)',
-    })
-    expect(collection).toHaveBeenNthCalledWith(
-      1,
-      expect.anything(),
-      'banks',
-      '001',
-      'accounts',
-    )
-    expect(collection).toHaveBeenNthCalledWith(
-      2,
-      expect.anything(),
-      'bankAccount',
-      'Bank',
-      '(001)',
-    )
-    expect(res).toEqual([{ accountDocId: 'a1', accountType: 'chk' }])
-  })
-
-  test('merges legacy accounts when new schema empty', async () => {
-    ;(getDocs as jest.Mock)
-      .mockResolvedValueOnce({ docs: [] })
-      .mockResolvedValueOnce({
-        docs: [
-          { id: 'acc1', data: () => ({ accountType: 'sv' }) },
-        ],
-      })
-    const res = await listAccounts({
-      bankCode: '040',
-      bankName: 'DSB',
-      rawCodeSegment: '(040)',
-    })
-    expect(collection).toHaveBeenNthCalledWith(
-      1,
-      expect.anything(),
-      'banks',
-      '040',
-      'accounts',
-    )
-    expect(collection).toHaveBeenNthCalledWith(
-      2,
-      expect.anything(),
-      'bankAccount',
-      'DSB',
-      '(040)',
-    )
-    expect(res).toEqual([{ accountDocId: 'acc1', accountType: 'sv' }])
-  })
+test('normalizeCode and buildBankLabel', () => {
+  expect(normalizeCode(40)).toEqual({ code: '040', raw: '(040)' })
+  expect(normalizeCode('040')).toEqual({ code: '040', raw: '(040)' })
+  expect(buildBankLabel({ bankCode: '040', bankName: 'Bank', rawCodeSegment: '(040)' })).toBe('Bank (040)')
 })
diff --git a/lib/erlDirectory.ts b/lib/erlDirectory.ts
index 8994cf9..2e29205 100644
--- a/lib/erlDirectory.ts
+++ b/lib/erlDirectory.ts
@@ -48,7 +48,9 @@ export async function listBanks(): Promise<BankInfo[]> {
     if (banks.length) return banks
     throw new Error('empty banks collection')
   } catch (e) {
-    console.warn('preferred bank directory failed', e)
+    if (process.env.NODE_ENV !== 'production') {
+      console.warn('preferred bank directory failed', e)
+    }
     const snap = await getDocs(collection(dbDirectory, 'bankAccount'))
     const banks: BankInfo[] = []
     snap.docs.forEach((d) => {
@@ -75,7 +77,9 @@ export async function listAccounts(bank: BankInfo): Promise<AccountInfo[]> {
       res[d.id] = { accountDocId: d.id, ...(d.data() as any) }
     })
   } catch (e) {
-    console.warn('preferred accounts failed', e)
+    if (process.env.NODE_ENV !== 'production') {
+      console.warn('preferred accounts failed', e)
+    }
   }
   try {
     const snap = await getDocs(
@@ -90,12 +94,14 @@ export async function listAccounts(bank: BankInfo): Promise<AccountInfo[]> {
       if (!res[d.id]) res[d.id] = { accountDocId: d.id, ...(d.data() as any) }
     })
   } catch (e) {
-    console.warn('legacy accounts failed', e)
+    if (process.env.NODE_ENV !== 'production') {
+      console.warn('legacy accounts failed', e)
+    }
   }
   return Object.values(res)
 }
 
 export function buildBankLabel(b: BankInfo): string {
-  if (b.bankName && b.bankCode) return `${b.bankName} ${b.bankCode}`
+  if (b.bankName && b.bankCode) return `${b.bankName} (${b.bankCode})`
   return b.bankCode
 }
diff --git a/lib/paths.ts b/lib/paths.ts
index 06b9be9..d650689 100644
--- a/lib/paths.ts
+++ b/lib/paths.ts
@@ -12,5 +12,8 @@ export const PATHS = {
   sessionHistory: (sessionId: string) => `Sessions/${sessionId}/appointmentHistory`,
   sessionVoucher: (sessionId: string) => `Sessions/${sessionId}/sessionVoucher`,
 }
-export const logPath = (label: string, path: string) =>
-  console.debug(`[paths] ${label}: ${path}`)
+export const logPath = (label: string, path: string) => {
+  if (process.env.NODE_ENV !== 'production') {
+    console.debug(`[paths] ${label}: ${path}`)
+  }
+}
diff --git a/pages/dashboard/businesses/coaching-sessions.tsx b/pages/dashboard/businesses/coaching-sessions.tsx
index 889c100..f256b80 100644
--- a/pages/dashboard/businesses/coaching-sessions.tsx
+++ b/pages/dashboard/businesses/coaching-sessions.tsx
@@ -400,14 +400,18 @@ export default function CoachingSessions() {
         <Box
           data-testid="card-footer-row"
           sx={{
-            position: 'sticky',
+            position: 'fixed',
             bottom: 0,
             left: 0,
+            right: 0,
             display: 'flex',
             alignItems: 'center',
             justifyContent: 'space-between',
             gap: '12px',
             p: 1,
+            bgcolor: 'background.paper',
+            boxShadow: '0 -2px 8px rgba(0,0,0,0.1)',
+            zIndex: 1200,
           }}
         >
           <IconButton
diff --git a/styles/studentDialog.css b/styles/studentDialog.css
index 68715fa..51986b5 100644
--- a/styles/studentDialog.css
+++ b/styles/studentDialog.css
@@ -132,8 +132,8 @@
   bottom: 0;
   z-index: 10;
   border-top: 1px solid var(--mui-palette-divider);
-  box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.04);
-  background: inherit;
+  box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
+  background: var(--mui-palette-background-paper);
 }
 
 .student-dialog-modal .MuiDialog-paper,
```
