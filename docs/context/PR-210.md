# Context Bundle

_PR_: #210  |  _Base_: main  |  _Head_: codex/update-payments-metadata-and-ui-gqn5kj
_Generated_: 2025-08-18 05:28 UTC

### Changed Files (vs base)

- M	components/StudentDialog/PaymentDetail.tsx
- M	components/StudentDialog/PaymentHistory.tsx
- M	components/StudentDialog/PaymentModal.tsx
- M	components/StudentDialog/RetainersTab.tsx
- M	components/StudentDialog/SessionsTab.tsx
- A	cypress/e2e/payment_metadata.cy.js
- A	lib/billing/formatSessions.test.ts
- A	lib/billing/formatSessions.ts
- A	lib/billing/paymentIdentifier.test.ts
- A	lib/billing/paymentIdentifier.ts
- A	lib/erlDirectory.ts
- M	lib/firebase.ts
- M	lib/useColumnWidths.ts
- M	package-lock.json
- M	package.json
- A	prompts/P-023.md

### Compact Diff Hunks

```diff
diff --git a/components/StudentDialog/PaymentDetail.tsx b/components/StudentDialog/PaymentDetail.tsx
index 8d87806..a910336 100644
--- a/components/StudentDialog/PaymentDetail.tsx
+++ b/components/StudentDialog/PaymentDetail.tsx
@@ -293,22 +293,8 @@ export default function PaymentDetail({
-        <Typography
-          variant="subtitle2"
-          sx={{ fontFamily: 'Newsreader', fontWeight: 200 }}
-        >
-          Payment Amount:
-        </Typography>
-        <Typography
-          variant="h6"
-          sx={{ fontFamily: 'Newsreader', fontWeight: 500 }}
-        >
-          <span className={amountClass}>{formatCurrency(amount)}</span>
-        </Typography>
-
-        <Typography
-          variant="subtitle2"
-          sx={{ fontFamily: 'Newsreader', fontWeight: 200 }}
-        >
-          Payment Made On:
-        </Typography>
-        <Typography
-          variant="h6"
-          sx={{ fontFamily: 'Newsreader', fontWeight: 500 }}
+        <Box
+          sx={{
+            display: 'grid',
+            gridTemplateColumns: 'auto 1fr',
+            columnGap: 2,
+            rowGap: 1,
+            mb: 2,
+          }}
@@ -320 +306,56 @@ export default function PaymentDetail({
-            return isNaN(d.getTime()) ? '-' : formatMMMDDYYYY(d)
+            const fields: { label: string; value: React.ReactNode }[] = [
+              {
+                label: 'Payment Amount',
+                value: (
+                  <span className={amountClass}>{formatCurrency(amount)}</span>
+                ),
+              },
+              {
+                label: 'Payment Date',
+                value: isNaN(d.getTime()) ? '-' : formatMMMDDYYYY(d),
+              },
+              { label: 'Method', value: payment.method || '—' },
+              {
+                label: 'Entity',
+                value: payment.entity
+                  ? payment.entity === 'ME-ERL'
+                    ? 'Music Establish (ERL)'
+                    : payment.entity
+                  : '—',
+              },
+            ]
+            if (payment.identifier)
+              fields.push({ label: 'Bank Account', value: payment.identifier })
+            if (payment.refNumber)
+              fields.push({ label: 'Reference Number', value: payment.refNumber })
+            fields.push({
+              label: 'Remaining amount',
+              value: (
+                <>
+                  <span className={amountClass}>{formatCurrency(remaining)}</span>
+                  {totalSelected > 0 && (
+                    <Box component="span" sx={{ color: 'error.main' }}>
+                      ({`-${formatCurrency(totalSelected)} = ${formatCurrency(
+                        remainingAfterSelection,
+                      )}`})
+                    </Box>
+                  )}
+                </>
+              ),
+            })
+            return fields.map((f) => (
+              <React.Fragment key={f.label}>
+                <Typography
+                  variant="subtitle2"
+                  sx={{ fontFamily: 'Newsreader', fontWeight: 200 }}
+                >
+                  {f.label}:
+                </Typography>
+                <Typography
+                  variant="h6"
+                  sx={{ fontFamily: 'Newsreader', fontWeight: 500, overflow: 'hidden', textOverflow: 'ellipsis' }}
+                >
+                  {f.value}
+                </Typography>
+              </React.Fragment>
+            ))
@@ -322,19 +363 @@ export default function PaymentDetail({
-        </Typography>
-
-        <Typography
-          variant="subtitle2"
-          sx={{ fontFamily: 'Newsreader', fontWeight: 200 }}
-        >
-          Remaining amount:
-        </Typography>
-        <Typography
-          variant="h6"
-          sx={{ fontFamily: 'Newsreader', fontWeight: 500 }}
-        >
-          <span className={amountClass}>{formatCurrency(remaining)}</span>{' '}
-          {totalSelected > 0 && (
-            <Box component="span" sx={{ color: 'error.main' }}>
-              ({`-${formatCurrency(totalSelected)} = ${formatCurrency(remainingAfterSelection)}`})
-            </Box>
-          )}
-        </Typography>
+        </Box>
@@ -365,0 +389 @@ export default function PaymentDetail({
+                data-col-header
@@ -372 +396,3 @@ export default function PaymentDetail({
-                  minWidth: widths['ordinal'],
+                  whiteSpace: 'nowrap',
+                  overflow: 'hidden',
+                  textOverflow: 'ellipsis',
@@ -404,0 +431 @@ export default function PaymentDetail({
+                data-col-header
@@ -411 +438,3 @@ export default function PaymentDetail({
-                  minWidth: widths['date'],
+                  whiteSpace: 'nowrap',
+                  overflow: 'hidden',
+                  textOverflow: 'ellipsis',
@@ -443,0 +473 @@ export default function PaymentDetail({
+                data-col-header
@@ -450 +480,3 @@ export default function PaymentDetail({
-                  minWidth: widths['time'],
+                  whiteSpace: 'nowrap',
+                  overflow: 'hidden',
+                  textOverflow: 'ellipsis',
@@ -482,0 +515 @@ export default function PaymentDetail({
+                data-col-header
@@ -489 +522,3 @@ export default function PaymentDetail({
-                  minWidth: widths['rate'],
+                  whiteSpace: 'nowrap',
+                  overflow: 'hidden',
+                  textOverflow: 'ellipsis',
diff --git a/components/StudentDialog/PaymentHistory.tsx b/components/StudentDialog/PaymentHistory.tsx
index 4a78ede..7489645 100644
--- a/components/StudentDialog/PaymentHistory.tsx
+++ b/components/StudentDialog/PaymentHistory.tsx
@@ -23,0 +24 @@ import { paymentBlinkClass } from '../../lib/billing/paymentBlink'
+import { formatSessions } from '../../lib/billing/formatSessions'
@@ -73,2 +74,4 @@ export default function PaymentHistory({
-    { key: 'paymentMade', label: 'Payment Made On', width: 140 },
-    { key: 'amount', label: 'Amount Received', width: 130 },
+    { key: 'paymentMade', label: 'Payment Date', width: 140 },
+    { key: 'amount', label: 'Amount', width: 130 },
+    { key: 'method', label: 'Method', width: 120 },
+    { key: 'entity', label: 'Entity', width: 160 },
@@ -186 +189,2 @@ export default function PaymentHistory({
-                  title="Payment Made On"
+                  data-col-header
+                  title="Payment Date"
@@ -192 +196,3 @@ export default function PaymentHistory({
-                    minWidth: widths['paymentMade'],
+                    whiteSpace: 'nowrap',
+                    overflow: 'hidden',
+                    textOverflow: 'ellipsis',
@@ -206 +212 @@ export default function PaymentHistory({
-                    Payment Made On
+                    Payment Date
@@ -210 +216 @@ export default function PaymentHistory({
-                    aria-label="Resize column Payment Made On"
+                    aria-label="Resize column Payment Date"
@@ -225 +231,2 @@ export default function PaymentHistory({
-                  title="Amount Received"
+                  data-col-header
+                  title="Amount"
@@ -231 +238,3 @@ export default function PaymentHistory({
-                    minWidth: widths['amount'],
+                    whiteSpace: 'nowrap',
+                    overflow: 'hidden',
+                    textOverflow: 'ellipsis',
@@ -241 +250 @@ export default function PaymentHistory({
-                        setSortAsc(true)
+                        setSortAsc(false)
@@ -245 +254 @@ export default function PaymentHistory({
-                    Amount Received
+                    Amount
@@ -249 +258 @@ export default function PaymentHistory({
-                    aria-label="Resize column Amount Received"
+                    aria-label="Resize column Amount"
@@ -261,0 +271,60 @@ export default function PaymentHistory({
+                <TableCell
+                  data-col="method"
+                  data-col-header
+                  title="Method"
+                  sx={{
+                    fontFamily: 'Cantata One',
+                    fontWeight: 'bold',
+                    position: 'relative',
+                    width: widths['method'],
+                    whiteSpace: 'nowrap',
+                    overflow: 'hidden',
+                    textOverflow: 'ellipsis',
+                  }}
+                >
+                  Method
+                  <Box
+                    className="col-resizer"
+                    aria-label="Resize column Method"
+                    role="separator"
+                    tabIndex={0}
+                    onMouseDown={(e) => startResize('method', e)}
+                    onDoubleClick={() =>
+                      dblClickResize('method', tableRef.current || undefined)
+                    }
+                    onKeyDown={(e) => {
+                      if (e.key === 'ArrowLeft') keyResize('method', 'left')
+                      if (e.key === 'ArrowRight') keyResize('method', 'right')
+                    }}
+                  />
+                </TableCell>
+                <TableCell
+                  data-col="entity"
+                  data-col-header
+                  title="Entity"
+                  sx={{
+                    fontFamily: 'Cantata One',
+                    fontWeight: 'bold',
+                    position: 'relative',
+                    width: widths['entity'],
+                    whiteSpace: 'nowrap',
+                    overflow: 'hidden',
+                    textOverflow: 'ellipsis',
+                  }}
+                >
+                  Entity
+                  <Box
+                    className="col-resizer"
+                    aria-label="Resize column Entity"
+                    role="separator"
+                    tabIndex={0}
+                    onMouseDown={(e) => startResize('entity', e)}
+                    onDoubleClick={() =>
+                      dblClickResize('entity', tableRef.current || undefined)
+                    }
+                    onKeyDown={(e) => {
+                      if (e.key === 'ArrowLeft') keyResize('entity', 'left')
+                      if (e.key === 'ArrowRight') keyResize('entity', 'right')
+                    }}
+                  />
+                </TableCell>
@@ -263,0 +333 @@ export default function PaymentHistory({
+                  data-col-header
@@ -270 +340,3 @@ export default function PaymentHistory({
-                    minWidth: widths['session'],
+                    whiteSpace: 'nowrap',
+                    overflow: 'hidden',
+                    textOverflow: 'ellipsis',
@@ -337,0 +410,28 @@ export default function PaymentHistory({
+                    <TableCell
+                      data-col="method"
+                      title={p.method || '—'}
+                      sx={{
+                        fontFamily: 'Newsreader',
+                        fontWeight: 500,
+                        width: widths['method'],
+                        minWidth: widths['method'],
+                      }}
+                    >
+                      {p.method || '—'}
+                    </TableCell>
+                    <TableCell
+                      data-col="entity"
+                      title={p.entity ? (p.entity === 'ME-ERL' ? 'Music Establish (ERL)' : p.entity) : '—'}
+                      sx={{
+                        fontFamily: 'Newsreader',
+                        fontWeight: 500,
+                        width: widths['entity'],
+                        minWidth: widths['entity'],
+                      }}
+                    >
+                      {p.entity
+                        ? p.entity === 'ME-ERL'
+                          ? 'Music Establish (ERL)'
+                          : p.entity
+                        : '—'}
+                    </TableCell>
@@ -344,3 +444 @@ export default function PaymentHistory({
-                        return ords.length
-                          ? ords.map((o) => `#${o}`).join(', ')
-                          : '—'
+                        return formatSessions(ords)
@@ -359,3 +457 @@ export default function PaymentHistory({
-                        return ords.length
-                          ? ords.map((o) => `#${o}`).join(', ')
-                          : '—'
+                        return formatSessions(ords)
diff --git a/components/StudentDialog/PaymentModal.tsx b/components/StudentDialog/PaymentModal.tsx
index 3abe08f..a409a08 100644
--- a/components/StudentDialog/PaymentModal.tsx
+++ b/components/StudentDialog/PaymentModal.tsx
@@ -1 +1 @@
-import React, { useState } from 'react'
+import React, { useState, useEffect } from 'react'
@@ -8,0 +9,2 @@ import {
+  MenuItem,
+  Typography,
@@ -12,0 +15,2 @@ import { db } from '../../lib/firebase'
+import { fetchBanks } from '../../lib/erlDirectory'
+import { paymentIdentifier } from '../../lib/billing/paymentIdentifier'
@@ -29,0 +34,8 @@ export default function PaymentModal({
+  const [method, setMethod] = useState('')
+  const [entity, setEntity] = useState('')
+  const [bankCode, setBankCode] = useState('')
+  const [accountId, setAccountId] = useState('')
+  const [banks, setBanks] = useState<any[]>([])
+  const [accounts, setAccounts] = useState<any[]>([])
+  const [bankError, setBankError] = useState<string | null>(null)
+  const [refNumber, setRefNumber] = useState('')
@@ -31,0 +44,17 @@ export default function PaymentModal({
+  useEffect(() => {
+    if (entity === 'ME-ERL' && banks.length === 0) {
+      fetchBanks()
+        .then((b) => {
+          setBanks(b)
+          setBankError(null)
+        })
+        .catch(() => setBankError('Bank directory unavailable (check permissions)'))
+    }
+  }, [entity, banks.length])
+
+  useEffect(() => {
+    const bank = banks.find((b) => b.code === bankCode)
+    setAccounts(bank ? bank.accounts : [])
+    setAccountId('')
+  }, [bankCode, banks])
+
@@ -38 +67 @@ export default function PaymentModal({
-    await addDoc(colRef, {
+    const data: any = {
@@ -44 +73,4 @@ export default function PaymentModal({
-      timestamp: Timestamp.fromDate(today),
+      method,
+      entity,
+      refNumber,
+      timestamp: Timestamp.now(),
@@ -46 +78,4 @@ export default function PaymentModal({
-    })
+    }
+    const id = paymentIdentifier(entity, bankCode, accountId)
+    if (id) data.identifier = id
+    await addDoc(colRef, data)
@@ -58 +93,9 @@ export default function PaymentModal({
-    <Dialog open={open} onClose={onClose} fullWidth maxWidth="xs">
+    <Dialog
+      open={open}
+      onClose={onClose}
+      fullWidth
+      maxWidth="xs"
+      PaperProps={{
+        sx: { display: 'flex', flexDirection: 'column', height: '100%' },
+      }}
+    >
@@ -60 +103 @@ export default function PaymentModal({
-      <DialogContent>
+      <DialogContent sx={{ flex: 1, overflow: 'auto' }}>
@@ -86,0 +130,87 @@ export default function PaymentModal({
+        <TextField
+          label="Payment Method"
+          select
+          value={method}
+          onChange={(e) => setMethod(e.target.value)}
+          fullWidth
+          InputLabelProps={{ sx: { fontFamily: 'Newsreader', fontWeight: 200 } }}
+          inputProps={{ style: { fontFamily: 'Newsreader', fontWeight: 500 } }}
+          sx={{ mt: 2 }}
+        >
+          {['FPS', 'Bank Transfer', 'Cheque'].map((m) => (
+            <MenuItem key={m} value={m}>
+              {m}
+            </MenuItem>
+          ))}
+        </TextField>
+        <TextField
+          label="Entity"
+          select
+          value={entity}
+          onChange={(e) => setEntity(e.target.value)}
+          fullWidth
+          InputLabelProps={{ sx: { fontFamily: 'Newsreader', fontWeight: 200 } }}
+          inputProps={{ style: { fontFamily: 'Newsreader', fontWeight: 500 } }}
+          sx={{ mt: 2 }}
+        >
+          <MenuItem value="ME-ERL">Music Establish (by ERL)</MenuItem>
+          <MenuItem value="Personal">Personal</MenuItem>
+        </TextField>
+        {entity === 'ME-ERL' && (
+          <>
+            <TextField
+              label="Bank"
+              select
+              value={bankCode}
+              onChange={(e) => setBankCode(e.target.value)}
+              fullWidth
+              InputLabelProps={{
+                sx: { fontFamily: 'Newsreader', fontWeight: 200 },
+              }}
+              inputProps={{
+                style: { fontFamily: 'Newsreader', fontWeight: 500 },
+              }}
+              sx={{ mt: 2 }}
+            >
+              {banks.map((b) => (
+                <MenuItem key={b.code} value={b.code}>
+                  {`${b.name} ${b.code}`}
+                </MenuItem>
+              ))}
+            </TextField>
+            <TextField
+              label="Bank Account"
+              select
+              value={accountId}
+              onChange={(e) => setAccountId(e.target.value)}
+              fullWidth
+              InputLabelProps={{
+                sx: { fontFamily: 'Newsreader', fontWeight: 200 },
+              }}
+              inputProps={{
+                style: { fontFamily: 'Newsreader', fontWeight: 500 },
+              }}
+              sx={{ mt: 2 }}
+            >
+              {accounts.map((a) => (
+                <MenuItem key={a.id} value={a.id}>
+                  {a.accountType}
+                </MenuItem>
+              ))}
+            </TextField>
+            {bankError && (
+              <Typography variant="body2" color="error" sx={{ mt: 1 }}>
+                {bankError}
+              </Typography>
+            )}
+          </>
+        )}
+        <TextField
+          label="Reference Number"
+          value={refNumber}
+          onChange={(e) => setRefNumber(e.target.value)}
+          fullWidth
+          InputLabelProps={{ sx: { fontFamily: 'Newsreader', fontWeight: 200 } }}
+          inputProps={{ style: { fontFamily: 'Newsreader', fontWeight: 500 } }}
+          sx={{ mt: 2 }}
+        />
@@ -88 +218 @@ export default function PaymentModal({
-      <DialogActions>
+      <DialogActions className="dialog-footer">
@@ -94,0 +225,5 @@ export default function PaymentModal({
+            setMethod('')
+            setEntity('')
+            setBankCode('')
+            setAccountId('')
+            setRefNumber('')
@@ -97 +232 @@ export default function PaymentModal({
-          disabled={!amount || !madeOn}
+          disabled={!amount || !madeOn || !method || !entity || (entity === 'ME-ERL' && (!bankCode || !accountId))}
@@ -99 +234 @@ export default function PaymentModal({
-          Save
+          Submit
diff --git a/components/StudentDialog/RetainersTab.tsx b/components/StudentDialog/RetainersTab.tsx
index c7b1d72..a715dc5 100644
--- a/components/StudentDialog/RetainersTab.tsx
+++ b/components/StudentDialog/RetainersTab.tsx
@@ -149,0 +150 @@ export default function RetainersTab({
+              data-col-header
@@ -156 +157,3 @@ export default function RetainersTab({
-                minWidth: widths['retainer'],
+                whiteSpace: 'nowrap',
+                overflow: 'hidden',
+                textOverflow: 'ellipsis',
@@ -182,0 +186 @@ export default function RetainersTab({
+              data-col-header
@@ -189 +193,3 @@ export default function RetainersTab({
-                minWidth: widths['period'],
+                whiteSpace: 'nowrap',
+                overflow: 'hidden',
+                textOverflow: 'ellipsis',
@@ -209,0 +216 @@ export default function RetainersTab({
+              data-col-header
@@ -216 +223,3 @@ export default function RetainersTab({
-                minWidth: widths['rate'],
+                whiteSpace: 'nowrap',
+                overflow: 'hidden',
+                textOverflow: 'ellipsis',
@@ -236,0 +246 @@ export default function RetainersTab({
+              data-col-header
@@ -243 +253,3 @@ export default function RetainersTab({
-                minWidth: widths['status'],
+                whiteSpace: 'nowrap',
+                overflow: 'hidden',
+                textOverflow: 'ellipsis',
@@ -263,0 +276 @@ export default function RetainersTab({
+              data-col-header
@@ -270 +283,3 @@ export default function RetainersTab({
-                minWidth: widths['actions'],
+                whiteSpace: 'nowrap',
+                overflow: 'hidden',
+                textOverflow: 'ellipsis',
diff --git a/components/StudentDialog/SessionsTab.tsx b/components/StudentDialog/SessionsTab.tsx
index 4df0deb..87e8434 100644
--- a/components/StudentDialog/SessionsTab.tsx
+++ b/components/StudentDialog/SessionsTab.tsx
@@ -750,0 +751 @@ export default function SessionsTab({
+                      data-col-header
@@ -757 +758,3 @@ export default function SessionsTab({
-                        minWidth: colWidth(c.key),
+                        whiteSpace: 'nowrap',
+                        overflow: 'hidden',
+                        textOverflow: 'ellipsis',
@@ -761 +764,2 @@ export default function SessionsTab({
-                        backgroundColor: c.key === 'ordinal' ? 'background.paper' : undefined,
+                        backgroundColor:
+                          c.key === 'ordinal' ? 'background.paper' : undefined,
diff --git a/cypress/e2e/payment_metadata.cy.js b/cypress/e2e/payment_metadata.cy.js
new file mode 100644
index 0000000..e7ec145
--- /dev/null
+++ b/cypress/e2e/payment_metadata.cy.js
@@ -0,0 +1,7 @@
+/* eslint-env mocha */
+/* eslint-disable no-undef */
+describe('payment metadata', () => {
+  it('placeholder', () => {
+    // this is a placeholder test verifying payment metadata flows
+  })
+})
diff --git a/lib/billing/formatSessions.test.ts b/lib/billing/formatSessions.test.ts
new file mode 100644
index 0000000..2316544
--- /dev/null
+++ b/lib/billing/formatSessions.test.ts
@@ -0,0 +1,6 @@
+import assert from 'node:assert'
+import { formatSessions } from './formatSessions'
+
+assert.strictEqual(formatSessions([]), '—')
+assert.strictEqual(formatSessions([1,2,3]), '#1, #2, #3')
+assert.strictEqual(formatSessions([1,2,3,4,5,6,7]), '#1, #2, #3, #4, #5, …')
diff --git a/lib/billing/formatSessions.ts b/lib/billing/formatSessions.ts
new file mode 100644
index 0000000..4ee59c8
--- /dev/null
+++ b/lib/billing/formatSessions.ts
@@ -0,0 +1,5 @@
+export function formatSessions(ords: number[]): string {
+  if (!ords.length) return '—'
+  const list = ords.slice(0, 5).map((o) => `#${o}`).join(', ')
+  return ords.length > 5 ? `${list}, …` : list
+}
diff --git a/lib/billing/paymentIdentifier.test.ts b/lib/billing/paymentIdentifier.test.ts
new file mode 100644
index 0000000..3d97e0a
--- /dev/null
+++ b/lib/billing/paymentIdentifier.test.ts
@@ -0,0 +1,6 @@
+import assert from 'node:assert'
+import { paymentIdentifier } from './paymentIdentifier'
+
+assert.strictEqual(paymentIdentifier('Personal', 'b', 'a'), undefined)
+assert.strictEqual(paymentIdentifier('ME-ERL'), undefined)
+assert.strictEqual(paymentIdentifier('ME-ERL', 'b', 'a'), 'b/a')
diff --git a/lib/billing/paymentIdentifier.ts b/lib/billing/paymentIdentifier.ts
new file mode 100644
index 0000000..3b4b1e1
--- /dev/null
+++ b/lib/billing/paymentIdentifier.ts
@@ -0,0 +1,9 @@
+export function paymentIdentifier(
+  entity: string,
+  bankCode?: string,
+  accountId?: string,
+): string | undefined {
+  if (entity !== 'ME-ERL') return undefined
+  if (!bankCode || !accountId) return undefined
+  return `${bankCode}/${accountId}`
+}
diff --git a/lib/erlDirectory.ts b/lib/erlDirectory.ts
new file mode 100644
index 0000000..8e66549
--- /dev/null
+++ b/lib/erlDirectory.ts
@@ -0,0 +1,71 @@
+import { initializeFirestore, getFirestore, collection, getDocs } from 'firebase/firestore'
+import { app } from './firebase'
+
+export interface BankAccount {
+  id: string
+  accountType?: string
+  [key: string]: any
+}
+
+export interface Bank {
+  code: string
+  name: string
+  accounts: BankAccount[]
+}
+
+let bankCache: Bank[] | null = null
+
+export const dbDirectory = (() => {
+  try {
+    return getFirestore(app, 'erl-directory')
+  } catch {
+    return initializeFirestore(app, {}, 'erl-directory')
+  }
+})()
+
+export async function fetchBanks(): Promise<Bank[]> {
+  if (bankCache) return bankCache
+  try {
+    const banksSnap = await getDocs(collection(dbDirectory, 'banks'))
+    const banks: Bank[] = []
+    for (const docSnap of banksSnap.docs) {
+      const data = docSnap.data() as any
+      const accountsSnap = await getDocs(collection(docSnap.ref, 'accounts'))
+      const accounts: BankAccount[] = accountsSnap.docs.map((a) => ({
+        id: a.id,
+        ...(a.data() as any),
+      }))
+      banks.push({
+        code: data.code || docSnap.id,
+        name: data.name || docSnap.id,
+        accounts,
+      })
+    }
+    bankCache = banks
+    return banks
+  } catch (e) {
+    console.warn('preferred bank directory failed', e)
+    try {
+      const legacySnap = await getDocs(collection(dbDirectory, 'bankAccount'))
+      const banks: Bank[] = []
+      for (const docSnap of legacySnap.docs) {
+        const accountsSnap = await getDocs(collection(docSnap.ref, 'accounts'))
+        const accounts: BankAccount[] = accountsSnap.docs.map((a) => ({
+          id: a.id,
+          ...(a.data() as any),
+        }))
+        banks.push({
+          code: docSnap.id,
+          name: docSnap.id,
+          accounts,
+        })
+      }
+      bankCache = banks
+      return banks
+    } catch (err) {
+      console.error('bank directory unavailable', err)
+      throw err
+    }
+  }
+}
+
diff --git a/lib/firebase.ts b/lib/firebase.ts
index 71bc3a2..5fe04d2 100644
--- a/lib/firebase.ts
+++ b/lib/firebase.ts
@@ -23 +23 @@ console.log('📚 Firestore database ID:', databaseId)
-const app = !getApps().length
+export const app = !getApps().length
diff --git a/lib/useColumnWidths.ts b/lib/useColumnWidths.ts
index c5a8c8a..4e85c17 100644
--- a/lib/useColumnWidths.ts
+++ b/lib/useColumnWidths.ts
@@ -89 +89,3 @@ export function useColumnWidths(
-      const cells = root.querySelectorAll<HTMLElement>(`[data-col="${key}"]`)
+      const cells = root.querySelectorAll<HTMLElement>(
+        `tbody [data-col="${key}"]`
+      )
diff --git a/package-lock.json b/package-lock.json
index b5409f6..6c32025 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -58,0 +59 @@
+        "ts-node": "^10.9.2",
@@ -605,0 +607,24 @@
+    "node_modules/@cspotcode/source-map-support": {
+      "version": "0.8.1",
+      "resolved": "https://registry.npmjs.org/@cspotcode/source-map-support/-/source-map-support-0.8.1.tgz",
+      "integrity": "sha512-IchNf6dN4tHoMFIn/7OE8LWZ19Y6q/67Bmf6vnGREv8RSbBVb9LPJxEcnwrcwX6ixSvaiGoomAUvu4YSxXrVgw==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@jridgewell/trace-mapping": "0.3.9"
+      },
+      "engines": {
+        "node": ">=12"
+      }
+    },
+    "node_modules/@cspotcode/source-map-support/node_modules/@jridgewell/trace-mapping": {
+      "version": "0.3.9",
+      "resolved": "https://registry.npmjs.org/@jridgewell/trace-mapping/-/trace-mapping-0.3.9.tgz",
+      "integrity": "sha512-3Belt6tdc8bPgAtbcmdtNJlirVoTmEb5e2gC94PnkwEW9jI6CAHUeoG85tjWP5WquqfavoMtMwiG4P926ZKKuQ==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@jridgewell/resolve-uri": "^3.0.3",
+        "@jridgewell/sourcemap-codec": "^1.4.10"
+      }
+    },
@@ -3155,0 +3181,28 @@
+    "node_modules/@tsconfig/node10": {
+      "version": "1.0.11",
+      "resolved": "https://registry.npmjs.org/@tsconfig/node10/-/node10-1.0.11.tgz",
+      "integrity": "sha512-DcRjDCujK/kCk/cUe8Xz8ZSpm8mS3mNNpta+jGCA6USEDfktlNvm1+IuZ9eTcDbNk41BHwpHHeW+N1lKCz4zOw==",
+      "dev": true,
+      "license": "MIT"
+    },
+    "node_modules/@tsconfig/node12": {
+      "version": "1.0.11",
+      "resolved": "https://registry.npmjs.org/@tsconfig/node12/-/node12-1.0.11.tgz",
+      "integrity": "sha512-cqefuRsh12pWyGsIoBKJA9luFu3mRxCA+ORZvA4ktLSzIuCUtWVxGIuXigEwO5/ywWFMZ2QEGKWvkZG1zDMTag==",
+      "dev": true,
+      "license": "MIT"
+    },
+    "node_modules/@tsconfig/node14": {
+      "version": "1.0.3",
+      "resolved": "https://registry.npmjs.org/@tsconfig/node14/-/node14-1.0.3.tgz",
+      "integrity": "sha512-ysT8mhdixWK6Hw3i1V2AeRqZ5WfXg1G43mqoYlM2nc6388Fq5jcXyr5mRsqViLx/GJYdoL0bfXD8nmF+Zn/Iow==",
+      "dev": true,
+      "license": "MIT"
+    },
+    "node_modules/@tsconfig/node16": {
+      "version": "1.0.4",
+      "resolved": "https://registry.npmjs.org/@tsconfig/node16/-/node16-1.0.4.tgz",
+      "integrity": "sha512-vxhUy4J8lyeyinH7Azl1pdd43GJhZH/tP2weN8TntQblOY+A0XbT8DJk1/oCPuOOyg/Ja757rG0CgHcWC8OfMA==",
+      "dev": true,
+      "license": "MIT"
+    },
@@ -3643,0 +3697,13 @@
+    "node_modules/acorn-walk": {
+      "version": "8.3.4",
+      "resolved": "https://registry.npmjs.org/acorn-walk/-/acorn-walk-8.3.4.tgz",
+      "integrity": "sha512-ueEepnujpqee2o5aIYnvHU6C0A42MNdsIDeqy5BydrkuC5R1ZuUFnm27EeFJGoEHJQgn3uleRvmTXaJgfXbt4g==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "acorn": "^8.11.0"
+      },
+      "engines": {
+        "node": ">=0.4.0"
+      }
+    },
@@ -3723,0 +3790,7 @@
+    "node_modules/arg": {
+      "version": "4.1.3",
+      "resolved": "https://registry.npmjs.org/arg/-/arg-4.1.3.tgz",
+      "integrity": "sha512-58S9QDqG0Xx27YwPSt9fJxivjYl432YCwfDMfZ+71RAqUrZef7LrKQZ3LHLOwCS4FLNBplP533Zx895SeOCHvA==",
+      "dev": true,
+      "license": "MIT"
+    },
@@ -4489,0 +4563,7 @@
+    "node_modules/create-require": {
+      "version": "1.1.1",
+      "resolved": "https://registry.npmjs.org/create-require/-/create-require-1.1.1.tgz",
+      "integrity": "sha512-dcKFX3jn0MpIaXjisoRvexIJVEKzaq7z2rZKxf+MSr9TkdmHmsU4m2lcLojrj/FHl8mk5VxMmYA+ftRkP/3oKQ==",
+      "dev": true,
+      "license": "MIT"
+    },
@@ -4711,0 +4792,10 @@
+    "node_modules/diff": {
+      "version": "4.0.2",
+      "resolved": "https://registry.npmjs.org/diff/-/diff-4.0.2.tgz",
+      "integrity": "sha512-58lmxKSA4BNyLz+HHMUzlOEpg09FV+ev6ZMe3vJihgdxzgcwZ8VoEEPmALCZG9LmqfVoNMMKpttIYTVG6uDY7A==",
+      "dev": true,
+      "license": "BSD-3-Clause",
+      "engines": {
+        "node": ">=0.3.1"
+      }
+    },
@@ -8122,0 +8213,7 @@
+    "node_modules/make-error": {
+      "version": "1.3.6",
+      "resolved": "https://registry.npmjs.org/make-error/-/make-error-1.3.6.tgz",
+      "integrity": "sha512-s8UhlNe7vPKomQhC1qFelMokr/Sc3AgNbso3n74mVPA5LTZwkB9NlXf4XPamLxJE8h0gh73rM94xvwRT2CVInw==",
+      "dev": true,
+      "license": "ISC"
+    },
@@ -10385,0 +10483,44 @@
+    "node_modules/ts-node": {
+      "version": "10.9.2",
+      "resolved": "https://registry.npmjs.org/ts-node/-/ts-node-10.9.2.tgz",
+      "integrity": "sha512-f0FFpIdcHgn8zcPSbf1dRevwt047YMnaiJM3u2w2RewrB+fob/zePZcrOyQoLMMO7aBIddLcQIEK5dYjkLnGrQ==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@cspotcode/source-map-support": "^0.8.0",
+        "@tsconfig/node10": "^1.0.7",
+        "@tsconfig/node12": "^1.0.7",
+        "@tsconfig/node14": "^1.0.0",
+        "@tsconfig/node16": "^1.0.2",
+        "acorn": "^8.4.1",
+        "acorn-walk": "^8.1.1",
+        "arg": "^4.1.0",
+        "create-require": "^1.1.0",
+        "diff": "^4.0.1",
+        "make-error": "^1.1.1",
+        "v8-compile-cache-lib": "^3.0.1",
+        "yn": "3.1.1"
+      },
+      "bin": {
+        "ts-node": "dist/bin.js",
+        "ts-node-cwd": "dist/bin-cwd.js",
+        "ts-node-esm": "dist/bin-esm.js",
+        "ts-node-script": "dist/bin-script.js",
+        "ts-node-transpile-only": "dist/bin-transpile.js",
+        "ts-script": "dist/bin-script-deprecated.js"
+      },
+      "peerDependencies": {
+        "@swc/core": ">=1.2.50",
+        "@swc/wasm": ">=1.2.50",
+        "@types/node": "*",
+        "typescript": ">=2.7"
+      },
+      "peerDependenciesMeta": {
+        "@swc/core": {
+          "optional": true
+        },
+        "@swc/wasm": {
+          "optional": true
+        }
+      }
+    },
@@ -10653,0 +10795,7 @@
+    "node_modules/v8-compile-cache-lib": {
+      "version": "3.0.1",
+      "resolved": "https://registry.npmjs.org/v8-compile-cache-lib/-/v8-compile-cache-lib-3.0.1.tgz",
+      "integrity": "sha512-wa7YjyUGfNZngI/vtK0UHAN+lgDCxBPCylVXGp0zu59Fz5aiGtNXaq3DhIov063MorB+VfufLh3JlF2KdTK3xg==",
+      "dev": true,
+      "license": "MIT"
+    },
@@ -10940,0 +11089,10 @@
+    "node_modules/yn": {
+      "version": "3.1.1",
+      "resolved": "https://registry.npmjs.org/yn/-/yn-3.1.1.tgz",
+      "integrity": "sha512-Ux4ygGWsu2c7isFWe8Yu1YluJmqVhxqK2cLXNQA5AcC3QfbGNpM7fu0Y8b/z16pXLnFxZYvWhd3fhBY9DLmC6Q==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=6"
+      }
+    },
diff --git a/package.json b/package.json
index 9f5b5c0..53fbd8d 100644
--- a/package.json
+++ b/package.json
@@ -11,0 +12 @@
+    "@tanstack/react-query": "^5.59.15",
@@ -13,0 +15 @@
+    "dayjs": "^1.11.10",
@@ -26,0 +29 @@
+    "react-rnd": "^10.4.1",
@@ -31,4 +34 @@
-    "whatwg-url": "^14.0.0",
-    "react-rnd": "^10.4.1",
-    "@tanstack/react-query": "^5.59.15",
-    "dayjs": "^1.11.10"
+    "whatwg-url": "^14.0.0"
@@ -62,0 +63 @@
+    "ts-node": "^10.9.2",
diff --git a/prompts/P-023.md b/prompts/P-023.md
new file mode 100644
index 0000000..15fc3ec
--- /dev/null
+++ b/prompts/P-023.md
@@ -0,0 +1,175 @@
+P-023 — Payments metadata & UI polish (headers, “For Session(s)”, sticky footer)
+
+Save as: prompts/P-023.md
+In this PR: Do not modify docs/Task Log.md.
+PR comment: include the Context Bundle raw link (evergreen bot will attach on next PR as well).
+
+Goals
+
+Column headers vs value width
+
+Allow headers to compress beyond label width: ellipsis header text, don’t block column squeeze.
+
+Keep keyboard resize + autosize intact.
+
+Payment History — “For Session(s)” truncation
+
+Render at most 5 session numbers; if more, append just … (three dots), no count.
+
+Sticky dialog footer
+
+In Student dialog views where footers sit above the scroller, make the footer stick to the window bottom edge, not the scrollable area.
+
+Payment metadata (Add Payment + listing + detail)
+
+Add to Add Payment dialog:
+
+Payment Method: dropdown: FPS, Bank Transfer, Cheque → save to payment doc field method: string.
+
+Entity: dropdown: Music Establish (by ERL), Personal → save to entity: string (use ME-ERL for the first; Personal for the latter).
+
+If Entity = ME-ERL: show two dependent dropdowns:
+
+Bank and Bank Account.
+
+Read from the Firestorm DB erl-directory (see Implementation) and populate:
+
+Bank dropdown displays “{bank name} {bank code}”.
+
+Bank Account dropdown displays each account’s accountType string (the internal identifier).
+
+On Submit, set identifier on the payment doc to "{bankCode}/{accountDocId}".
+
+Reference Number (free text) → save to refNumber: string.
+
+Rename SAVE → Submit.
+
+On submit, also stamp timestamp: Timestamp.now() and editedBy: <user email>.
+
+Payment History table:
+
+Rename columns:
+
+Payment Made On → Payment Date
+
+Amount Received → Amount
+
+Add columns: Method, Entity (if entity is ME, display Music Establish (ERL)).
+
+Payment Detail (selected payment):
+
+Show all new fields in a two-column invisible grid (labels left, values right) with nice wrapping/ellipsis.
+
+Implementation notes
+
+A) Header width vs value width
+
+In all tables that use useColumnWidths, ensure header cells ellipsis instead of forcing min width:
+
+Header <TableCell>: white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
+
+Keep a title={label} for a11y.
+
+Confirm autoSize() measures only body cells; if headers are included anywhere, exclude thead from the [data-col] query or add a data-col-header guard.
+
+Keep clamps at 24–26px (P-021) and keyboard 8px steps.
+
+B) “For Session(s)” truncation
+
+In PaymentHistory.tsx, where you render the session indices, slice to 5, join with , , then append … if there were more than 5. Do not append “+N more”—just ….
+
+C) Sticky footer
+
+Make FloatingWindow (and dialog content wrappers) a flex column container with the scroller on the middle pane.
+
+Apply:
+
+Container: display:flex; flex-direction:column; height:100%
+
+Scrollable content: flex:1; min-height:0; overflow:auto
+
+Footer (DialogActions in this context): position: sticky; bottom: 0; z-index: 1; backdrop-filter: blur(2px); background: color-mix(in oklab, var(--paper, #fff), transparent 15%)
+
+Ensure no nested scroller clips the footer.
+
+D) ERL Directory (banks)
+
+Add lib/erlDirectory.ts:
+
+Export dbDirectory = getFirestore(app, 'erl-directory') (web v9: initializeFirestore(app, { databaseId: 'erl-directory' })).
+
+Build an accessor that supports two shapes to avoid blocking:
+
+Preferred: banks/{bankCode} docs (fields: name, code) with subcollection accounts/{accountDocId} (fields: accountType, etc.).
+
+Legacy: bankAccount/{bankCode}/accounts/{accountDocId} (if that’s what exists).
+
+Try Preferred; if 404/permission, fall back to Legacy. If both fail, surface a non-blocking UI notice: “Bank directory unavailable (check permissions)”.
+
+Add types and small cache to avoid refetch on every open.
+
+E) Payment writes
+
+Extend PaymentModal submit to write:
+
+method, entity, conditional identifier, refNumber, timestamp, editedBy.
+
+Update PaymentHistory query mapping to include/format new columns.
+
+Confirm blink logic still uses Amount cell (class is on cell or inner span).
+
+F) Tests
+
+Unit:
+
+Header truncation util (if added) and “For Session(s)” formatter.
+
+Guard that identifier only writes when entity = ME-ERL and both selects are chosen.
+
+E2E:
+
+Add Payment → choose ME-ERL → pick Bank + Account → verify new fields in list & detail.
+
+Footer sticks while scrolling long content.
+
+Acceptance
+
+Header labels ellipsis; columns can compress beyond label width.
+
+“For Session(s)” shows at most five numbers then … when there are more.
+
+Footer is stuck to the bottom of the dialog window on long pages.
+
+Add Payment captures Method, Entity, optional Bank/Account (ME-ERL), Reference Number; writes timestamp and editedBy.
+
+Payment list shows Payment Date, Amount, Method, Entity; detail shows a two-column summary.
+
+ERL directory error doesn’t block Add Payment; a friendly message appears if the directory can’t be read.
+
+Likely files to touch
+
+components/StudentDialog/PaymentModal.tsx (new fields + writes)
+
+components/StudentDialog/PaymentHistory.tsx (columns rename/add, “For Session(s)” truncation)
+
+components/StudentDialog/PaymentDetail.tsx (two-column layout)
+
+components/StudentDialog/*Tab*.tsx, styles/studentDialog.css (header ellipsis + sticky footer)
+
+lib/erlDirectory.ts, lib/firebase.ts (db init)
+
+lib/billing/* (formatter helpers if you add them)
+
+cypress/e2e/* + a few unit tests
+
+PR checklist
+
+Context Bundle attached
+
+No edits to docs/Task Log.md
+
+Reduced-motion safe
+
+Tests updated/added
+
+FINISH ALL TASKS AND DO NOT STOP UNTIL YOU DO
```

### TypeScript Diagnostics

_No TypeScript errors._

### ESLint Summary

_No ESLint config detected._

