# PR #225 — Diff Summary

- **Base (target)**: `c5ed22b604beb1362e337ab3c146f21763dc79a7`
- **Head (source)**: `921721244fd8c38f0c51f784967ddbf9d27c13ed`
- **Repo**: `girafeev1/ArtifactoftheEstablisher`

## Changed Files

```txt
M	components/StudentDialog/PaymentDetail.tsx
M	components/StudentDialog/PaymentModal.tsx
M	lib/billing/formatSessions.test.ts
M	lib/billing/minUnpaidRate.test.ts
M	lib/billing/paymentBlink.test.ts
M	lib/billing/paymentBlink.ts
M	lib/billing/paymentIdentifier.test.ts
M	lib/erlDirectory.test.ts
M	lib/erlDirectory.ts
M	lib/payments/format.test.ts
M	lib/payments/format.ts
A	prompts/p-027-02r.md
M	styles/studentDialog.css
```

## Stats

```txt
 components/StudentDialog/PaymentDetail.tsx |  10 +-
 components/StudentDialog/PaymentModal.tsx  |  72 ++++++----
 lib/billing/formatSessions.test.ts         |  13 +-
 lib/billing/minUnpaidRate.test.ts          |  20 +--
 lib/billing/paymentBlink.test.ts           |  11 +-
 lib/billing/paymentBlink.ts                |  10 +-
 lib/billing/paymentIdentifier.test.ts      |  11 +-
 lib/erlDirectory.test.ts                   |  65 ++-------
 lib/erlDirectory.ts                        |  96 +++++++------
 lib/payments/format.test.ts                |  18 ++-
 lib/payments/format.ts                     |  10 +-
 prompts/p-027-02r.md                       | 207 +++++++++++++++++++++++++++++
 styles/studentDialog.css                   |   4 +
 13 files changed, 380 insertions(+), 167 deletions(-)
```

## Unified Diff (truncated to first 4000 lines)

```diff
diff --git a/components/StudentDialog/PaymentDetail.tsx b/components/StudentDialog/PaymentDetail.tsx
index 9f9c86b..0c42417 100644
--- a/components/StudentDialog/PaymentDetail.tsx
+++ b/components/StudentDialog/PaymentDetail.tsx
@@ -450,7 +450,12 @@ export default function PaymentDetail({
               label: 'Remaining amount',
               value: (
                 <>
-                  <span className={remainingClass}>{formatCurrency(remaining)}</span>
+                  <span
+                    data-testid="remaining-amount"
+                    className={remainingClass}
+                  >
+                    {formatCurrency(remaining)}
+                  </span>
                   {totalSelected > 0 && (
                     <Box component="span" sx={{ color: 'error.main' }}>
                       ({`-${formatCurrency(totalSelected)} = ${formatCurrency(
@@ -766,6 +771,7 @@ export default function PaymentDetail({
                     <TableCell
                       colSpan={4}
                       sx={{ fontFamily: 'Newsreader', fontWeight: 500 }}
+                      data-testid="assignment-zero"
                     >
                       No sessions available.
                     </TableCell>
@@ -778,6 +784,7 @@ export default function PaymentDetail({
       </Box>
       <Box
         className="dialog-footer"
+        data-testid="dialog-footer"
         sx={{ p: 1, display: 'flex', justifyContent: 'space-between' }}
       >
         <Button
@@ -787,6 +794,7 @@ export default function PaymentDetail({
             onTitleChange?.(null)
           }}
           aria-label="back to payments"
+          data-testid="back-button"
         >
           ← Back
         </Button>
diff --git a/components/StudentDialog/PaymentModal.tsx b/components/StudentDialog/PaymentModal.tsx
index 8730bf9..bfb8d5f 100644
--- a/components/StudentDialog/PaymentModal.tsx
+++ b/components/StudentDialog/PaymentModal.tsx
@@ -12,8 +12,8 @@ import {
 import { collection, addDoc, Timestamp } from 'firebase/firestore'
 import { getAuth } from 'firebase/auth'
 import { db } from '../../lib/firebase'
-import { fetchBanks } from '../../lib/erlDirectory'
-import { normalizeIdentifier } from '../../lib/payments/format'
+import { listBanks, listAccounts, buildBankLabel, BankInfo, AccountInfo } from '../../lib/erlDirectory'
+import { buildIdentifier } from '../../lib/payments/format'
 import { PATHS, logPath } from '../../lib/paths'
 import { useBillingClient, billingKey } from '../../lib/billing/useBilling'
 import { writeSummaryFromCache } from '../../lib/liveRefresh'
@@ -35,8 +35,8 @@ export default function PaymentModal({
   const [entity, setEntity] = useState('')
   const [bankCode, setBankCode] = useState('')
   const [accountId, setAccountId] = useState('')
-  const [banks, setBanks] = useState<any[]>([])
-  const [accounts, setAccounts] = useState<any[]>([])
+  const [banks, setBanks] = useState<BankInfo[]>([])
+  const [accounts, setAccounts] = useState<AccountInfo[]>([])
   const [bankError, setBankError] = useState<string | null>(null)
   const [refNumber, setRefNumber] = useState('')
   const qc = useBillingClient()
@@ -52,7 +52,7 @@ export default function PaymentModal({
 
   useEffect(() => {
     if (isErl && banks.length === 0) {
-      fetchBanks()
+      listBanks()
         .then((b) => {
           setBanks(b)
           setBankError(null)
@@ -62,10 +62,15 @@ export default function PaymentModal({
   }, [isErl, banks.length])
 
   useEffect(() => {
-    const bank = banks.find((b) => b.code === bankCode)
-    setAccounts(bank ? bank.accounts : [])
+    if (bankCode) {
+      listAccounts(bankCode)
+        .then((a) => setAccounts(a))
+        .catch(() => setAccounts([]))
+    } else {
+      setAccounts([])
+    }
     setAccountId('')
-  }, [bankCode, banks])
+  }, [bankCode])
 
   const save = async () => {
     const paymentsPath = PATHS.payments(abbr)
@@ -149,7 +154,10 @@ export default function PaymentModal({
           onChange={(e) => setMethod(e.target.value)}
           fullWidth
           InputLabelProps={{ sx: { fontFamily: 'Newsreader', fontWeight: 200 } }}
-          inputProps={{ style: { fontFamily: 'Newsreader', fontWeight: 500 } }}
+          inputProps={{
+            style: { fontFamily: 'Newsreader', fontWeight: 500 },
+            'data-testid': 'method-select',
+          }}
           sx={{ mt: 2 }}
         >
           {['FPS', 'Bank Transfer', 'Cheque'].map((m) => (
@@ -162,10 +170,20 @@ export default function PaymentModal({
           label="Entity"
           select
           value={entity}
-          onChange={(e) => setEntity(e.target.value)}
+          onChange={(e) => {
+            const val = e.target.value
+            setEntity(val)
+            if (val !== 'Music Establish (ERL)') {
+              setBankCode('')
+              setAccountId('')
+            }
+          }}
           fullWidth
           InputLabelProps={{ sx: { fontFamily: 'Newsreader', fontWeight: 200 } }}
-          inputProps={{ style: { fontFamily: 'Newsreader', fontWeight: 500 } }}
+          inputProps={{
+            style: { fontFamily: 'Newsreader', fontWeight: 500 },
+            'data-testid': 'entity-select',
+          }}
           sx={{ mt: 2 }}
         >
           <MenuItem value="Music Establish (ERL)">Music Establish (ERL)</MenuItem>
@@ -184,18 +202,15 @@ export default function PaymentModal({
               }}
               inputProps={{
                 style: { fontFamily: 'Newsreader', fontWeight: 500 },
+                'data-testid': 'bank-select',
               }}
               sx={{ mt: 2 }}
             >
-              {banks.map((b) => {
-                const fallback = `${b.docId || b.id || ''} ${b.collectionId || ''}`.trim()
-                const label = b.name && b.code ? `${b.name} ${b.code}` : fallback
-                return (
-                  <MenuItem key={b.code} value={b.code}>
-                    {label}
-                  </MenuItem>
-                )
-              })}
+              {banks.map((b) => (
+                <MenuItem key={b.bankCode} value={b.bankCode}>
+                  {buildBankLabel(b)}
+                </MenuItem>
+              ))}
             </TextField>
             <TextField
               label="Bank Account"
@@ -208,11 +223,12 @@ export default function PaymentModal({
               }}
               inputProps={{
                 style: { fontFamily: 'Newsreader', fontWeight: 500 },
+                'data-testid': 'bank-account-select',
               }}
               sx={{ mt: 2 }}
             >
               {accounts.map((a) => (
-                <MenuItem key={a.id} value={a.id}>
+                <MenuItem key={a.accountDocId} value={a.accountDocId}>
                   {a.accountType}
                 </MenuItem>
               ))}
@@ -230,12 +246,17 @@ export default function PaymentModal({
           onChange={(e) => setRefNumber(e.target.value)}
           fullWidth
           InputLabelProps={{ sx: { fontFamily: 'Newsreader', fontWeight: 200 } }}
-          inputProps={{ style: { fontFamily: 'Newsreader', fontWeight: 500 } }}
+          inputProps={{
+            style: { fontFamily: 'Newsreader', fontWeight: 500 },
+            'data-testid': 'ref-input',
+          }}
           sx={{ mt: 2 }}
         />
       </DialogContent>
-      <DialogActions className="dialog-footer">
-        <Button onClick={onClose}>Cancel</Button>
+      <DialogActions className="dialog-footer" data-testid="dialog-footer">
+        <Button onClick={onClose} data-testid="back-button">
+          Back
+        </Button>
         <Button
           onClick={async () => {
             await save()
@@ -248,7 +269,8 @@ export default function PaymentModal({
             setRefNumber('')
             onClose()
           }}
-          disabled={!amount || !madeOn || !method || !entity || (isErl && (!bankCode || !accountId))}
+          disabled={!method || !entity || (isErl && (!bankCode || !accountId))}
+          data-testid="submit-payment"
         >
           Submit
         </Button>
diff --git a/lib/billing/formatSessions.test.ts b/lib/billing/formatSessions.test.ts
index 2316544..86e84ec 100644
--- a/lib/billing/formatSessions.test.ts
+++ b/lib/billing/formatSessions.test.ts
@@ -1,6 +1,11 @@
-import assert from 'node:assert'
 import { formatSessions } from './formatSessions'
 
-assert.strictEqual(formatSessions([]), '—')
-assert.strictEqual(formatSessions([1,2,3]), '#1, #2, #3')
-assert.strictEqual(formatSessions([1,2,3,4,5,6,7]), '#1, #2, #3, #4, #5, …')
+describe('formatSessions', () => {
+  test('formats ordinals with truncation', () => {
+    expect(formatSessions([])).toBe('—')
+    expect(formatSessions([1, 2, 3])).toBe('#1, #2, #3')
+    expect(formatSessions([1, 2, 3, 4, 5, 6, 7])).toBe(
+      '#1, #2, #3, #4, #5, …',
+    )
+  })
+})
diff --git a/lib/billing/minUnpaidRate.test.ts b/lib/billing/minUnpaidRate.test.ts
index 0647b71..cbad9c9 100644
--- a/lib/billing/minUnpaidRate.test.ts
+++ b/lib/billing/minUnpaidRate.test.ts
@@ -1,11 +1,13 @@
-import assert from 'node:assert'
 import { minUnpaidRate } from './minUnpaidRate'
 
-const rows = [
-  { amountDue: 100, flags: {} },
-  { amountDue: 50, flags: { voucherUsed: true } },
-  { amountDue: 75, flags: {} },
-  { amountDue: 20, flags: {}, assignedPaymentId: 'p1' },
-]
-
-assert.strictEqual(minUnpaidRate(rows), 75)
+describe('minUnpaidRate', () => {
+  test('ignores paid or voucher sessions', () => {
+    const rows = [
+      { amountDue: 100, flags: {} },
+      { amountDue: 50, flags: { voucherUsed: true } },
+      { amountDue: 75, flags: {} },
+      { amountDue: 20, flags: {}, assignedPaymentId: 'p1' },
+    ]
+    expect(minUnpaidRate(rows)).toBe(75)
+  })
+})
diff --git a/lib/billing/paymentBlink.test.ts b/lib/billing/paymentBlink.test.ts
index 7d6810d..39c8130 100644
--- a/lib/billing/paymentBlink.test.ts
+++ b/lib/billing/paymentBlink.test.ts
@@ -1,6 +1,9 @@
-import assert from 'node:assert'
 import { paymentBlinkClass } from './paymentBlink'
 
-assert.strictEqual(paymentBlinkClass(50, 40), 'blink-amount--warn')
-assert.strictEqual(paymentBlinkClass(30, 40), 'blink-amount--error')
-assert.strictEqual(paymentBlinkClass(0, 40), undefined)
+describe('paymentBlinkClass', () => {
+  test('returns appropriate blink classes', () => {
+    expect(paymentBlinkClass(50, 40)).toBe('blink-remaining blink-amount--warn')
+    expect(paymentBlinkClass(30, 40)).toBe('blink-remaining blink-amount--error')
+    expect(paymentBlinkClass(0, 40)).toBeUndefined()
+  })
+})
diff --git a/lib/billing/paymentBlink.ts b/lib/billing/paymentBlink.ts
index baa0db1..4437da0 100644
--- a/lib/billing/paymentBlink.ts
+++ b/lib/billing/paymentBlink.ts
@@ -1,7 +1,11 @@
-export function paymentBlinkClass(remaining: number, minRate: number | null | undefined): string | undefined {
+export function paymentBlinkClass(
+  remaining: number,
+  minRate: number | null | undefined,
+): string | undefined {
   if (remaining > 0) {
-    if (minRate != null && remaining < minRate) return 'blink-amount--error'
-    return 'blink-amount--warn'
+    if (minRate != null && remaining < minRate)
+      return 'blink-remaining blink-amount--error'
+    return 'blink-remaining blink-amount--warn'
   }
   return undefined
 }
diff --git a/lib/billing/paymentIdentifier.test.ts b/lib/billing/paymentIdentifier.test.ts
index 3d97e0a..81a038b 100644
--- a/lib/billing/paymentIdentifier.test.ts
+++ b/lib/billing/paymentIdentifier.test.ts
@@ -1,6 +1,9 @@
-import assert from 'node:assert'
 import { paymentIdentifier } from './paymentIdentifier'
 
-assert.strictEqual(paymentIdentifier('Personal', 'b', 'a'), undefined)
-assert.strictEqual(paymentIdentifier('ME-ERL'), undefined)
-assert.strictEqual(paymentIdentifier('ME-ERL', 'b', 'a'), 'b/a')
+describe('paymentIdentifier', () => {
+  test('computes identifier based on entity', () => {
+    expect(paymentIdentifier('Personal', 'b', 'a')).toBeUndefined()
+    expect(paymentIdentifier('ME-ERL')).toBeUndefined()
+    expect(paymentIdentifier('ME-ERL', 'b', 'a')).toBe('b/a')
+  })
+})
diff --git a/lib/erlDirectory.test.ts b/lib/erlDirectory.test.ts
index 944f1b8..0524598 100644
--- a/lib/erlDirectory.test.ts
+++ b/lib/erlDirectory.test.ts
@@ -1,62 +1,13 @@
-import { jest } from '@jest/globals'
+import { buildBankLabel, BankInfo } from './erlDirectory'
 
-jest.mock('firebase/firestore', () => ({
-  initializeFirestore: jest.fn(),
-  getFirestore: jest.fn(),
-  collection: jest.fn((db, path) => path),
-  getDocs: jest.fn(),
-}))
-
-describe('fetchBanks', () => {
-  afterEach(() => {
-    jest.resetModules()
-  })
-
-  test('reads preferred bank structure', async () => {
-    const { getDocs } = require('firebase/firestore') as any
-    getDocs.mockResolvedValueOnce({
-      docs: [
-        { id: '001', data: () => ({ code: '001', name: 'Bank A' }), ref: 'banks/001' },
-      ],
-    })
-    getDocs.mockResolvedValueOnce({
-      docs: [
-        { id: 'acc1', data: () => ({ accountType: 'Checking' }) },
-      ],
-    })
-    const { fetchBanks } = require('./erlDirectory')
-    const banks = await fetchBanks()
-    expect(banks).toEqual([
-      {
-        code: '001',
-        name: 'Bank A',
-        accounts: [{ id: 'acc1', accountType: 'Checking' }],
-      },
-    ])
+describe('buildBankLabel', () => {
+  test('uses bankName and code when available', () => {
+    const b: BankInfo = { bankCode: '123', bankName: 'Test Bank' }
+    expect(buildBankLabel(b)).toBe('Test Bank 123')
   })
 
-  test('falls back to legacy structure', async () => {
-    const { getDocs } = require('firebase/firestore') as any
-    getDocs.mockRejectedValueOnce(new Error('fail banks'))
-    getDocs.mockResolvedValueOnce({
-      docs: [
-        { id: '002', ref: 'bankAccount/002', data: () => ({}) },
-      ],
-    })
-    getDocs.mockResolvedValueOnce({
-      docs: [
-        { id: 'acc2', data: () => ({ accountType: 'Savings' }) },
-      ],
-    })
-    const { fetchBanks } = require('./erlDirectory')
-    const banks = await fetchBanks()
-    expect(banks).toEqual([
-      {
-        code: '002',
-        name: '002',
-        accounts: [{ id: 'acc2', accountType: 'Savings' }],
-      },
-    ])
+  test('falls back to docId and collectionId', () => {
+    const b: BankInfo = { bankCode: '', docId: 'abc', collectionId: 'banks' }
+    expect(buildBankLabel(b)).toBe('abc banks')
   })
 })
-
diff --git a/lib/erlDirectory.ts b/lib/erlDirectory.ts
index 8e66549..a040c19 100644
--- a/lib/erlDirectory.ts
+++ b/lib/erlDirectory.ts
@@ -1,20 +1,19 @@
 import { initializeFirestore, getFirestore, collection, getDocs } from 'firebase/firestore'
 import { app } from './firebase'
 
-export interface BankAccount {
-  id: string
-  accountType?: string
-  [key: string]: any
+export interface BankInfo {
+  bankCode: string
+  bankName?: string
+  docId?: string
+  collectionId?: string
 }
 
-export interface Bank {
-  code: string
-  name: string
-  accounts: BankAccount[]
+export interface AccountInfo {
+  accountDocId: string
+  accountType?: string
+  [key: string]: any
 }
 
-let bankCache: Bank[] | null = null
-
 export const dbDirectory = (() => {
   try {
     return getFirestore(app, 'erl-directory')
@@ -23,49 +22,46 @@ export const dbDirectory = (() => {
   }
 })()
 
-export async function fetchBanks(): Promise<Bank[]> {
-  if (bankCache) return bankCache
+export async function listBanks(): Promise<BankInfo[]> {
   try {
-    const banksSnap = await getDocs(collection(dbDirectory, 'banks'))
-    const banks: Bank[] = []
-    for (const docSnap of banksSnap.docs) {
-      const data = docSnap.data() as any
-      const accountsSnap = await getDocs(collection(docSnap.ref, 'accounts'))
-      const accounts: BankAccount[] = accountsSnap.docs.map((a) => ({
-        id: a.id,
-        ...(a.data() as any),
-      }))
-      banks.push({
-        code: data.code || docSnap.id,
-        name: data.name || docSnap.id,
-        accounts,
-      })
-    }
-    bankCache = banks
-    return banks
+    const snap = await getDocs(collection(dbDirectory, 'banks'))
+    const banks = snap.docs.map((d) => {
+      const data = d.data() as any
+      return {
+        bankCode: data.code || d.id,
+        bankName: data.name,
+        docId: d.id,
+        collectionId: 'banks',
+      } as BankInfo
+    })
+    if (banks.length) return banks
+    throw new Error('empty banks collection')
   } catch (e) {
     console.warn('preferred bank directory failed', e)
-    try {
-      const legacySnap = await getDocs(collection(dbDirectory, 'bankAccount'))
-      const banks: Bank[] = []
-      for (const docSnap of legacySnap.docs) {
-        const accountsSnap = await getDocs(collection(docSnap.ref, 'accounts'))
-        const accounts: BankAccount[] = accountsSnap.docs.map((a) => ({
-          id: a.id,
-          ...(a.data() as any),
-        }))
-        banks.push({
-          code: docSnap.id,
-          name: docSnap.id,
-          accounts,
-        })
-      }
-      bankCache = banks
-      return banks
-    } catch (err) {
-      console.error('bank directory unavailable', err)
-      throw err
-    }
+    const snap = await getDocs(collection(dbDirectory, 'bankAccount'))
+    return snap.docs.map((d) => ({
+      bankCode: d.id,
+      bankName: (d.data() as any)?.name,
+      docId: d.id,
+      collectionId: 'bankAccount',
+    }))
   }
 }
 
+export async function listAccounts(bankCode: string): Promise<AccountInfo[]> {
+  try {
+    const snap = await getDocs(collection(dbDirectory, 'banks', bankCode, 'accounts'))
+    if (!snap.empty)
+      return snap.docs.map((d) => ({ accountDocId: d.id, ...(d.data() as any) }))
+  } catch (e) {
+    console.warn('preferred accounts failed', e)
+  }
+  const snap = await getDocs(collection(dbDirectory, 'bankAccount', bankCode, 'accounts'))
+  return snap.docs.map((d) => ({ accountDocId: d.id, ...(d.data() as any) }))
+}
+
+export function buildBankLabel(b: BankInfo): string {
+  if (b.bankName && b.bankCode) return `${b.bankName} ${b.bankCode}`
+  const fallback = `${b.docId ?? ''} ${b.collectionId ?? ''}`.trim()
+  return fallback || b.bankCode
+}
diff --git a/lib/payments/format.test.ts b/lib/payments/format.test.ts
index 25f89a8..cb05951 100644
--- a/lib/payments/format.test.ts
+++ b/lib/payments/format.test.ts
@@ -19,15 +19,21 @@ describe('buildIdentifier', () => {
 })
 
 describe('normalizeIdentifier', () => {
-  test('returns existing valid identifier', () => {
-    expect(normalizeIdentifier('ABC/123', 'ZZZ', '999')).toBe('ABC/123')
+  test('returns undefined for Personal entity', () => {
+    expect(
+      normalizeIdentifier('Personal', 'HK', 'acc_1', 'HK/acc_1'),
+    ).toBeUndefined()
   })
 
-  test('recomputes when invalid', () => {
-    expect(normalizeIdentifier('bad id', 'ABC', '123')).toBe('ABC/123')
+  test('keeps valid identifier for ERL', () => {
+    expect(
+      normalizeIdentifier('Music Establish (ERL)', 'HK', 'acc_1', 'HK/acc_1'),
+    ).toBe('HK/acc_1')
   })
 
-  test('returns undefined when cannot build', () => {
-    expect(normalizeIdentifier('bad', 'ABC')).toBeUndefined()
+  test('recomputes invalid identifier', () => {
+    expect(
+      normalizeIdentifier('Music Establish (ERL)', 'HK', 'acc_1', 'bad'),
+    ).toBe('HK/acc_1')
   })
 })
diff --git a/lib/payments/format.ts b/lib/payments/format.ts
index ef711ec..ff1eb8e 100644
--- a/lib/payments/format.ts
+++ b/lib/payments/format.ts
@@ -10,11 +10,13 @@ export function buildIdentifier(
 }
 
 export function normalizeIdentifier(
-  identifier?: string,
+  entity: string,
   bankCode?: string,
   accountDocId?: string,
+  identifier?: string,
 ): string | undefined {
-  if (identifier && /^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/.test(identifier))
-    return identifier
-  return buildIdentifier(bankCode, accountDocId)
+  if (entity !== 'Music Establish (ERL)' && entity !== 'ME-ERL') return undefined
+  const built = buildIdentifier(bankCode, accountDocId)
+  if (!identifier) return built
+  return /^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/.test(identifier) ? identifier : built
 }
diff --git a/prompts/p-027-02r.md b/prompts/p-027-02r.md
new file mode 100644
index 0000000..a741e03
--- /dev/null
+++ b/prompts/p-027-02r.md
@@ -0,0 +1,207 @@
+P-027-02r — Ship the actual Add Payment cascade UI + sticky Back + single Remaining blink + stable assignment
+
+Save exactly at: prompts/p-027-02r.md
+Branch: codex/complete-add-payment-cascade-02r
+PR title: feat(payment): Add Payment cascade (Entity→Bank→Account) UI, sticky Back, single Remaining blink, stable assignment (P-027-02r)
+Labels: payments, ui, codex
+Do not modify: CI/workflows, deployment configs, Task Log (separate prompt will handle docs).
+
+Background (what’s still missing)
+
+Add Payment dialog doesn’t yet render the Entity → Bank → Bank Account dependent dropdowns; only submit-time stamping exists.
+
+Back button is not reliably inside the sticky footer.
+
+Remaining sometimes doubles up (two renders/classes).
+
+Session assignment UI can disappear; needs a persistent shell/zero-state.
+
+Keep the list view “For Session(s)” column (≤5 + …) and header ellipsis work intact.
+
+Deliverables
+A) Sticky footer & Back placement (StudentDialog)
+
+Render the Back control inside the sticky footer/action bar (same container as primary actions).
+
+Ensure the dialog body is the scroll container; add bottom padding equal to the footer height so content is never obscured.
+
+Footer style (adapt to your styling system):
+
+position: sticky;
+bottom: 0;
+z-index: 10;
+border-top: 1px solid var(--mui-palette-divider);
+box-shadow: 0 -2px 8px rgba(0,0,0,.04);
+background: inherit;
+
+
+Add data-testid="dialog-footer" and data-testid="back-button".
+
+B) Remaining blink — single render only
+
+Payment Amount: never blinks.
+
+Remaining: render once with the blink class (e.g., .blink-remaining); remove any duplicate element/spans.
+
+If you currently compute remaining in two places, refactor to a single memo + one <span data-testid="remaining-amount">…</span>.
+
+Respect prefers-reduced-motion (existing tokens/classes).
+
+C) Session assignment — always visible & functional
+
+Keep the assignment section mounted even when no rows: render a zero-state (e.g., “No sessions available”) with data-testid="assignment-zero".
+
+Selecting/unselecting sessions updates Remaining immediately and persists via existing hooks/services.
+
+Ensure “For Session(s)” summary in detail view does not hide/replace the assignment controls.
+
+D) Add Payment dialog — full cascade UI + writes
+
+Implement the exact UI + data flow. Use controlled components with clear state, types, and data-testids.
+
+Payment Method (dropdown)
+
+Options: FPS, Bank Transfer, Cheque
+
+Save to method: string.
+
+data-testid="method-select"
+
+Entity (dropdown)
+
+Options: Music Establish (ERL), Personal
+
+Save to entity: string (use the label text).
+
+On change to Personal, clear bankCode, accountDocId, and **identifier`.
+
+data-testid="entity-select"
+
+If Entity = "Music Establish (ERL)" show two dependent dropdowns:
+
+Bank
+
+Fetch from ERL directory DB. Prefer structure banks/{bankCode}; gracefully fallback to legacy bankAccount/{bankCode}/accounts/*.
+
+Option label: {bankName} {bankCode} (fallback {docId} {collectionId} if missing).
+
+Save selected bankCode.
+
+data-testid="bank-select"
+
+Bank Account
+
+Dependent on Bank; list sub-collection accounts for the selected bank.
+
+Option label: accountType; value: accountDocId.
+
+Save selected accountDocId.
+
+data-testid="bank-account-select"
+
+Reference Number (text)
+
+Save to refNumber: string.
+
+data-testid="ref-input"
+
+Submit (rename from Save)
+
+On submit:
+
+If entity === "Music Establish (ERL)", set identifier = "${bankCode}/${accountDocId}".
+
+If user entered identifier exists but doesn’t match /^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/, recompute from {bankCode}/{accountDocId}.
+
+Stamp timestamp and editedBy.
+
+data-testid="submit-payment"
+
+Validation UX
+
+Disable Submit until required fields are valid:
+
+Always: method, entity.
+
+If ERL: bankCode & accountDocId.
+
+Show inline helper/error text; keep to your existing pattern.
+
+Data access helper
+
+If missing, add lib/erlDirectory.ts with typed helpers:
+
+listBanks(): Promise<Array<{ bankCode: string; bankName?: string }>>
+
+listAccounts(bankCode): Promise<Array<{ accountDocId: string; accountType?: string }>>
+
+Implement graceful fallback between the two Firestore shapes above; no secrets in code.
+
+E) List view “For Session(s)”
+
+Keep the column present; display ≤5 ordinals with a trailing … when more exist.
+
+Do not regress header ellipsis/resizers.
+
+File hints (search/adapt)
+
+components/StudentDialog/PaymentModal.tsx — cascade UI + submit logic
+
+components/StudentDialog/PaymentDetail.tsx — single Remaining render; assignment shell/zero-state
+
+components/StudentDialog/PaymentHistory.tsx — verify sessions column & header ellipsis
+
+styles/studentDialog.css — sticky footer polish
+
+lib/erlDirectory.ts — ERL directory helpers (banks/accounts)
+
+Tests (no placeholders; add data-testids above to target)
+Unit
+
+normalizeIdentifier() — valid, invalid → recompute; ERL vs Personal transitions.
+
+ERL directory transforms (label builders, fallbacks).
+
+Cypress / component (run locally; guard in CI if needed)
+
+Sticky Back
+
+Assert data-testid="back-button" is inside data-testid="dialog-footer" and remains visible while body scrolls.
+
+Blink
+
+Change assignment selection; assert only data-testid="remaining-amount" has the blink class; amount never has it.
+
+Assignment
+
+With zero available rows, data-testid="assignment-zero" is visible (section doesn’t vanish).
+
+Selecting a session moves it to assigned and updates Remaining (numeric assertion).
+
+Cascade
+
+Select method, entity="Music Establish (ERL)", pick a Bank, then Bank Account; fill refNumber; Submit.
+
+Verify document writes: method, entity, bankCode, accountDocId, identifier = bankCode/accountDocId, refNumber, timestamp, editedBy.
+
+Switch entity to Personal and ensure bank/account fields clear and identifier isn’t forced.
+
+Keep specs committed. If CI lacks GUI deps, wrap with if (Cypress.env('CI_HEADLESS')) this.skip() or similar. Do not edit Actions.
+
+Acceptance checklist
+
+ Back sits inside sticky footer; footer sticks to window edge.
+
+ Remaining uses one blinking element; Payment Amount is static.
+
+ Assignment section is persistent with a zero-state and works end-to-end.
+
+ Add Payment cascade UI works exactly: Entity→Bank→Account, with writes & normalization + audit fields.
+
+ List “For Session(s)” remains (≤5 + …).
+
+ No new TypeScript errors; tests added with real assertions.
+
+Save this prompt
+
+Create prompts/p-027-02r.md with this content verbatim (no renames).
diff --git a/styles/studentDialog.css b/styles/studentDialog.css
index 1b0bb6f..68715fa 100644
--- a/styles/studentDialog.css
+++ b/styles/studentDialog.css
@@ -110,6 +110,10 @@
   text-shadow: 0 0 2px rgba(0, 0, 0, 0.12);
 }
 
+.blink-remaining {
+  /* marker for tests */
+}
+
 @media (prefers-reduced-motion: reduce) {
   .blink-amount--warn,
   .blink-amount--error {
```
