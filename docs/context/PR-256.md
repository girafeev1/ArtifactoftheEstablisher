# PR #256 â€” Diff Summary

- **Base (target)**: `5d817838627998d755db14a03580691e26564fa6`
- **Head (source)**: `55ffbc43cbd230fcc399d5394b11a460e5597766`
- **Repo**: `girafeev1/ArtifactoftheEstablisher`

## Changed Files

```txt
M	lib/firebaseAdmin.ts
M	pages/api/auth/[...nextauth].ts
A	pages/api/auth/firebase-diagnostics.ts
M	pages/auth/signin.tsx
```

## Stats

```txt
 lib/firebaseAdmin.ts                   |  35 ++++++++++--
 pages/api/auth/[...nextauth].ts        |  56 +++++++++++-------
 pages/api/auth/firebase-diagnostics.ts | 100 +++++++++++++++++++++++++++++++++
 pages/auth/signin.tsx                  |  87 ++++++++++++++++++++++++++--
 4 files changed, 250 insertions(+), 28 deletions(-)
```

## Unified Diff (truncated to first 4000 lines)

```diff
diff --git a/lib/firebaseAdmin.ts b/lib/firebaseAdmin.ts
index 1d3dcf0..04b996f 100644
--- a/lib/firebaseAdmin.ts
+++ b/lib/firebaseAdmin.ts
@@ -1,19 +1,44 @@
 import admin from 'firebase-admin'
 
+function stripWrappingQuotes(value: string): string {
+  if (value.length >= 2) {
+    const first = value[0]
+    const last = value[value.length - 1]
+    if (first === last && (first === '"' || first === "'")) {
+      return value.slice(1, -1)
+    }
+  }
+  return value
+}
+
 const projectId = process.env.FIREBASE_ADMIN_PROJECT_ID
 const clientEmail = process.env.FIREBASE_ADMIN_CLIENT_EMAIL
-const privateKey = process.env.FIREBASE_ADMIN_PRIVATE_KEY?.replace(/\\n/g, '\n')
+const privateKey = process.env.FIREBASE_ADMIN_PRIVATE_KEY
+  ? stripWrappingQuotes(process.env.FIREBASE_ADMIN_PRIVATE_KEY).replace(/\\n/g, '\n')
+  : undefined
+
+const hasServiceAccountCredentials = Boolean(projectId && clientEmail && privateKey)
+
+export const firebaseAdminConfigStatus = {
+  hasProjectId: Boolean(projectId),
+  hasClientEmail: Boolean(clientEmail),
+  hasPrivateKey: Boolean(privateKey),
+  credentialSource: hasServiceAccountCredentials ? 'service-account' : 'default',
+} as const
 
 if (!admin.apps.length) {
-  if (projectId && clientEmail && privateKey) {
+  if (hasServiceAccountCredentials) {
     admin.initializeApp({
       credential: admin.credential.cert({
-        projectId,
-        clientEmail,
-        privateKey,
+        projectId: projectId!,
+        clientEmail: clientEmail!,
+        privateKey: privateKey!,
       }),
     })
   } else {
+    console.warn(
+      '[auth] Firebase Admin initialized without FIREBASE_ADMIN service-account credentials. Token verification will fail until they are configured.'
+    )
     admin.initializeApp()
   }
 }
diff --git a/pages/api/auth/[...nextauth].ts b/pages/api/auth/[...nextauth].ts
index 40c5e47..ac14c39 100644
--- a/pages/api/auth/[...nextauth].ts
+++ b/pages/api/auth/[...nextauth].ts
@@ -2,7 +2,10 @@ import type { NextAuthOptions } from 'next-auth'
 import NextAuth from 'next-auth'
 import CredentialsProvider from 'next-auth/providers/credentials'
 
-import { firebaseAdminAuth } from '../../../lib/firebaseAdmin'
+import {
+  firebaseAdminAuth,
+  firebaseAdminConfigStatus,
+} from '../../../lib/firebaseAdmin'
 import { loadSecrets } from '../../../lib/server/secretManager'
 
 async function buildAuthOptions(): Promise<NextAuthOptions> {
@@ -22,25 +25,40 @@ async function buildAuthOptions(): Promise<NextAuthOptions> {
             throw new Error('Missing Firebase ID token')
           }
 
-          const decoded = await firebaseAdminAuth.verifyIdToken(credentials.idToken)
-          const userRecord = await firebaseAdminAuth
-            .getUser(decoded.uid)
-            .catch(() => null)
+          if (firebaseAdminConfigStatus.credentialSource !== 'service-account') {
+            throw new Error(
+              'Firebase Admin credentials are missing or incomplete. Please configure FIREBASE_ADMIN_PROJECT_ID, FIREBASE_ADMIN_CLIENT_EMAIL, and FIREBASE_ADMIN_PRIVATE_KEY.'
+            )
+          }
+
+          try {
+            const decoded = await firebaseAdminAuth.verifyIdToken(credentials.idToken)
+            const userRecord = await firebaseAdminAuth
+              .getUser(decoded.uid)
+              .catch(() => null)
 
-          return {
-            id: decoded.uid,
-            name: userRecord?.displayName ?? decoded.name ?? null,
-            email: userRecord?.email ?? decoded.email ?? null,
-            image: userRecord?.photoURL ?? decoded.picture ?? null,
-            firebase: {
-              claims: decoded,
-              idToken: credentials.idToken,
-            },
-            google: {
-              accessToken: credentials.accessToken ?? null,
-              refreshToken: credentials.refreshToken ?? null,
-            },
-          } as any
+            return {
+              id: decoded.uid,
+              name: userRecord?.displayName ?? decoded.name ?? null,
+              email: userRecord?.email ?? decoded.email ?? null,
+              image: userRecord?.photoURL ?? decoded.picture ?? null,
+              firebase: {
+                claims: decoded,
+                idToken: credentials.idToken,
+              },
+              google: {
+                accessToken: credentials.accessToken ?? null,
+                refreshToken: credentials.refreshToken ?? null,
+              },
+            } as any
+          } catch (error) {
+            const errorMessage =
+              error instanceof Error
+                ? `Firebase token verification failed: ${error.message}`
+                : 'Firebase token verification failed'
+            console.error('[auth] Failed to verify Firebase ID token', error)
+            throw new Error(errorMessage)
+          }
         },
       }),
     ],
diff --git a/pages/api/auth/firebase-diagnostics.ts b/pages/api/auth/firebase-diagnostics.ts
new file mode 100644
index 0000000..4bf6366
--- /dev/null
+++ b/pages/api/auth/firebase-diagnostics.ts
@@ -0,0 +1,100 @@
+import type { NextApiRequest, NextApiResponse } from 'next'
+
+import {
+  firebaseAdminAuth,
+  firebaseAdminConfigStatus,
+} from '../../../lib/firebaseAdmin'
+
+type DiagnosticsSuccessResponse = {
+  ok: true
+  uid: string
+  projectId: string | null
+}
+
+type DiagnosticsFailureResponse = {
+  ok: false
+  message: string
+  code?: string
+  config: typeof firebaseAdminConfigStatus
+}
+
+type DiagnosticsResponse = DiagnosticsSuccessResponse | DiagnosticsFailureResponse
+
+function buildMissingEnvMessage(): string | null {
+  const missing: string[] = []
+  if (!firebaseAdminConfigStatus.hasProjectId) {
+    missing.push('FIREBASE_ADMIN_PROJECT_ID')
+  }
+  if (!firebaseAdminConfigStatus.hasClientEmail) {
+    missing.push('FIREBASE_ADMIN_CLIENT_EMAIL')
+  }
+  if (!firebaseAdminConfigStatus.hasPrivateKey) {
+    missing.push('FIREBASE_ADMIN_PRIVATE_KEY')
+  }
+
+  if (!missing.length) {
+    return null
+  }
+
+  return `Missing environment variables: ${missing.join(', ')}`
+}
+
+export default async function handler(
+  req: NextApiRequest,
+  res: NextApiResponse<DiagnosticsResponse>
+) {
+  if (req.method !== 'POST') {
+    res.setHeader('Allow', ['POST'])
+    res.status(405).json({
+      ok: false,
+      message: 'Method Not Allowed',
+      config: firebaseAdminConfigStatus,
+    })
+    return
+  }
+
+  const idToken = typeof req.body === 'object' ? (req.body as any)?.idToken : undefined
+
+  if (typeof idToken !== 'string' || !idToken.trim()) {
+    res.status(400).json({
+      ok: false,
+      message: 'Missing Firebase ID token',
+      config: firebaseAdminConfigStatus,
+    })
+    return
+  }
+
+  if (firebaseAdminConfigStatus.credentialSource !== 'service-account') {
+    const missingMessage = buildMissingEnvMessage()
+    res.status(200).json({
+      ok: false,
+      message:
+        missingMessage ??
+        'Firebase Admin was initialized without service-account credentials. Token verification cannot proceed.',
+      config: firebaseAdminConfigStatus,
+    })
+    return
+  }
+
+  try {
+    const decoded = await firebaseAdminAuth.verifyIdToken(idToken)
+    res.status(200).json({
+      ok: true,
+      uid: decoded.uid,
+      projectId: (decoded as any)?.aud ?? null,
+    })
+  } catch (error) {
+    const message =
+      error instanceof Error
+        ? error.message
+        : 'Firebase Admin could not verify the provided token.'
+    const code = typeof error === 'object' && error && 'code' in error ? String((error as any).code) : undefined
+
+    res.status(200).json({
+      ok: false,
+      message,
+      code,
+      config: firebaseAdminConfigStatus,
+    })
+  }
+}
diff --git a/pages/auth/signin.tsx b/pages/auth/signin.tsx
index 594fa54..bed353d 100644
--- a/pages/auth/signin.tsx
+++ b/pages/auth/signin.tsx
@@ -1,4 +1,4 @@
-import { useEffect, useMemo, useState } from 'react'
+import { useCallback, useEffect, useMemo, useState } from 'react'
 import Head from 'next/head'
 import { useRouter } from 'next/router'
 import {
@@ -21,6 +21,20 @@ import {
   Typography,
 } from '@mui/material'
 
+type FirebaseDiagnosticsResponse =
+  | { ok: true; uid: string; projectId: string | null }
+  | {
+      ok: false
+      message: string
+      code?: string
+      config: {
+        hasProjectId: boolean
+        hasClientEmail: boolean
+        hasPrivateKey: boolean
+        credentialSource: 'service-account' | 'default'
+      }
+    }
+
 const buttonStyles = {
   height: 48,
   justifyContent: 'center',
@@ -50,6 +64,58 @@ export default function SignInPage() {
     return provider
   }, [])
 
+  const diagnoseCredentialFailure = useCallback(async (idToken: string) => {
+    try {
+      const response = await fetch('/api/auth/firebase-diagnostics', {
+        method: 'POST',
+        headers: { 'Content-Type': 'application/json' },
+        body: JSON.stringify({ idToken }),
+      })
+
+      if (!response.ok) {
+        return null
+      }
+
+      const data = (await response.json()) as FirebaseDiagnosticsResponse
+
+      if (data.ok) {
+        return 'Firebase Admin accepted the token when retried directly, but NextAuth still rejected the exchange. Check the server logs for additional context.'
+      }
+
+      const messageParts: string[] = []
+
+      if (data.message) {
+        messageParts.push(data.message)
+      }
+
+      if (data.code) {
+        messageParts.push(`(code: ${data.code})`)
+      }
+
+      if (data.config) {
+        if (data.config.credentialSource !== 'service-account') {
+          messageParts.push(
+            'Firebase Admin is running without service-account credentials. Set FIREBASE_ADMIN_PROJECT_ID, FIREBASE_ADMIN_CLIENT_EMAIL, and FIREBASE_ADMIN_PRIVATE_KEY.'
+          )
+        } else {
+          const missing: string[] = []
+          if (!data.config.hasProjectId) missing.push('FIREBASE_ADMIN_PROJECT_ID')
+          if (!data.config.hasClientEmail) missing.push('FIREBASE_ADMIN_CLIENT_EMAIL')
+          if (!data.config.hasPrivateKey) missing.push('FIREBASE_ADMIN_PRIVATE_KEY')
+
+          if (missing.length) {
+            messageParts.push(`Missing environment variables: ${missing.join(', ')}`)
+          }
+        }
+      }
+
+      return messageParts.join(' ')
+    } catch (diagnosticError) {
+      console.error('[auth] Failed to run Firebase diagnostics', diagnosticError)
+      return null
+    }
+  }, [])
+
   const completeNextAuth = async (params: {
     idToken: string
     accessToken?: string | null
@@ -62,11 +128,24 @@ export default function SignInPage() {
       redirect: false,
     })
 
-    if (response?.error) {
-      throw new Error(response.error)
+    if (!response) {
+      throw new Error('No response from authentication service')
+    }
+
+    if (response.error) {
+      console.error('[auth] NextAuth credential exchange failed', response)
+      let mappedError = response.error
+
+      if (response.error === 'CredentialsSignin') {
+        mappedError =
+          (await diagnoseCredentialFailure(params.idToken)) ??
+          'Google sign-in was rejected by the server. Please verify the Firebase Admin environment variables.'
+      }
+
+      throw new Error(mappedError)
     }
 
-    await router.replace('/')
+    await router.replace(response.url ?? '/')
   }
 
   const handleGoogleSignIn = async () => {
```
