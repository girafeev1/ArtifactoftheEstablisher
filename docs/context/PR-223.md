# PR #223 — Diff Summary

- **Base (target)**: `bd636d2b6e50144ba7d8e5b721bb3a1682c166b7`
- **Head (source)**: `0c271a4de921ac57912076b4f557862f2e2d2f7e`
- **Repo**: `girafeev1/ArtifactoftheEstablisher`

## Changed Files

```txt
M	components/StudentDialog/PaymentDetail.tsx
M	components/StudentDialog/PaymentModal.tsx
M	lib/payments/format.test.ts
M	lib/payments/format.ts
A	prompts/p-027.md
```

## Stats

```txt
 components/StudentDialog/PaymentDetail.tsx |  12 +--
 components/StudentDialog/PaymentModal.tsx  |   6 +-
 lib/payments/format.test.ts                |  16 +++-
 lib/payments/format.ts                     |  10 +++
 prompts/p-027.md                           | 137 +++++++++++++++++++++++++++++
 5 files changed, 171 insertions(+), 10 deletions(-)
```

## Unified Diff (truncated to first 4000 lines)

```diff
diff --git a/components/StudentDialog/PaymentDetail.tsx b/components/StudentDialog/PaymentDetail.tsx
index a0283e0..9f9c86b 100644
--- a/components/StudentDialog/PaymentDetail.tsx
+++ b/components/StudentDialog/PaymentDetail.tsx
@@ -23,7 +23,7 @@ import { minUnpaidRate } from '../../lib/billing/minUnpaidRate'
 import { paymentBlinkClass } from '../../lib/billing/paymentBlink'
 import { formatSessions } from '../../lib/billing/formatSessions'
 import { truncateList } from '../../lib/payments/truncate'
-import { buildIdentifier } from '../../lib/payments/format'
+import { normalizeIdentifier } from '../../lib/payments/format'
 import {
   patchBillingAssignedSessions,
   writeSummaryFromCache,
@@ -104,11 +104,11 @@ export default function PaymentDetail({
     const ref = doc(db, PATHS.payments(abbr), payment.id)
     const patch: any = {}
     if (field === 'identifier') {
-      let val = value.trim()
-      if (!/^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/.test(val)) {
-        const built = buildIdentifier(payment.bankCode, payment.accountDocId)
-        if (built) val = built
-      }
+      const val = normalizeIdentifier(
+        value.trim(),
+        payment.bankCode,
+        payment.accountDocId,
+      )
       if (!val) return
       patch.identifier = val
       setIdentifierVal(val)
diff --git a/components/StudentDialog/PaymentModal.tsx b/components/StudentDialog/PaymentModal.tsx
index 3163f98..4ddb796 100644
--- a/components/StudentDialog/PaymentModal.tsx
+++ b/components/StudentDialog/PaymentModal.tsx
@@ -13,7 +13,7 @@ import { collection, addDoc, Timestamp } from 'firebase/firestore'
 import { getAuth } from 'firebase/auth'
 import { db } from '../../lib/firebase'
 import { fetchBanks } from '../../lib/erlDirectory'
-import { buildIdentifier } from '../../lib/payments/format'
+import { normalizeIdentifier } from '../../lib/payments/format'
 import { PATHS, logPath } from '../../lib/paths'
 import { useBillingClient, billingKey } from '../../lib/billing/useBilling'
 import { writeSummaryFromCache } from '../../lib/liveRefresh'
@@ -40,7 +40,7 @@ export default function PaymentModal({
   const [bankError, setBankError] = useState<string | null>(null)
   const [refNumber, setRefNumber] = useState('')
   const qc = useBillingClient()
-  const isErl = entity === 'Music Establish (ERL)' || entity === 'ME-ERL'
+  const isErl = entity === 'Music Establish (ERL)'
 
   useEffect(() => {
     if (isErl && banks.length === 0) {
@@ -78,7 +78,7 @@ export default function PaymentModal({
       editedBy: getAuth().currentUser?.email || 'system',
     }
     if (isErl) {
-      const id = buildIdentifier(bankCode, accountId)
+      const id = normalizeIdentifier(data.identifier, bankCode, accountId)
       if (id) {
         data.identifier = id
         data.bankCode = bankCode
diff --git a/lib/payments/format.test.ts b/lib/payments/format.test.ts
index 6fa6639..25f89a8 100644
--- a/lib/payments/format.test.ts
+++ b/lib/payments/format.test.ts
@@ -1,4 +1,4 @@
-import { buildIdentifier } from './format'
+import { buildIdentifier, normalizeIdentifier } from './format'
 
 describe('buildIdentifier', () => {
   test('returns undefined when parts are missing', () => {
@@ -17,3 +17,17 @@ describe('buildIdentifier', () => {
     expect(buildIdentifier('@@', '##')).toBeUndefined()
   })
 })
+
+describe('normalizeIdentifier', () => {
+  test('returns existing valid identifier', () => {
+    expect(normalizeIdentifier('ABC/123', 'ZZZ', '999')).toBe('ABC/123')
+  })
+
+  test('recomputes when invalid', () => {
+    expect(normalizeIdentifier('bad id', 'ABC', '123')).toBe('ABC/123')
+  })
+
+  test('returns undefined when cannot build', () => {
+    expect(normalizeIdentifier('bad', 'ABC')).toBeUndefined()
+  })
+})
diff --git a/lib/payments/format.ts b/lib/payments/format.ts
index 767babd..ef711ec 100644
--- a/lib/payments/format.ts
+++ b/lib/payments/format.ts
@@ -8,3 +8,13 @@ export function buildIdentifier(
   const id = `${cleanBank}/${cleanAccount}`
   return /^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/.test(id) ? id : undefined
 }
+
+export function normalizeIdentifier(
+  identifier?: string,
+  bankCode?: string,
+  accountDocId?: string,
+): string | undefined {
+  if (identifier && /^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/.test(identifier))
+    return identifier
+  return buildIdentifier(bankCode, accountDocId)
+}
diff --git a/prompts/p-027.md b/prompts/p-027.md
new file mode 100644
index 0000000..480c2ec
--- /dev/null
+++ b/prompts/p-027.md
@@ -0,0 +1,137 @@
+# P-027 — Finish Add Payment cascade + sticky Back + single Remaining blink + stable assignment
+
+**Save this prompt exactly at:** `prompts/p-027.md`
+**Branch:** `codex/finalize-add-payment-cascade-p027`
+**PR title:** `feat(payment): Add Payment cascade (Entity→Bank→Account), sticky Back, single Remaining blink, stable assignment (P-027)`
+**Labels:** `payments`, `ui`, `codex`
+**Rules:** Do **not** modify CI/Actions or deployment settings. Do **not** touch Task Log in this prompt.
+
+## Background (what’s still missing)
+
+* **Add Payment cascade UI** is not fully implemented (Entity → Bank → Bank Account).
+* **Back** control is not consistently inside the **sticky footer**.
+* **Remaining** sometimes renders twice (blink/flicker).
+* **Assignment section** can still disappear without a persistent shell/zero-state in some flows.
+* List view “For Session(s)” column exists; keep it intact.
+
+---
+
+## What to build
+
+### A) Sticky footer & Back placement (StudentDialog)
+
+* Render the **Back** control **inside** the dialog’s sticky footer/action bar (same container as primary actions).
+* Ensure the **dialog body** is the scroll container. Add **bottom padding** equal to the footer height so content isn’t obscured.
+* Footer CSS (adapt to stack):
+
+  * `position: sticky; bottom: 0; z-index: 10;`
+  * `border-top: 1px solid var(--mui-palette-divider);`
+  * `box-shadow: 0 -2px 8px rgba(0,0,0,.04);`
+  * `background: inherit;`
+
+### B) Remaining blink — single element only
+
+* **Payment Amount** must never blink.
+* **Remaining** must render **once** using the blink class; remove any duplicate span/fragment that causes double-blink/flicker.
+* Respect reduced-motion prefs.
+
+### C) Session assignment list — always visible & functional
+
+* Keep a **persistent container** (zero-state when rows are 0) so the section never disappears during loading/filters.
+* Selecting/unselecting sessions updates **Remaining** immediately and persists via the **existing hooks/services**.
+
+### D) **Add Payment** dialog — full cascade + writes
+
+Implement the UI and data writes exactly as follows:
+
+1. **Payment Method** dropdown — options: `FPS`, `Bank Transfer`, `Cheque`
+
+   * Save to `method: string`.
+
+2. **Entity** dropdown — options: `Music Establish (ERL)`, `Personal`
+
+   * Save to `entity: string` (use the label text).
+
+3. If **Entity = "Music Establish (ERL)"**:
+
+   * **Bank** dropdown:
+
+     * Fetch banks from the ERL directory DB. Prefer structure `banks/{bankCode}`, fallback legacy `bankAccount/{bankCode}/accounts/*`.
+     * Label each option as **`{bankName} {bankCode}`**, fallback **`{docId} {collectionId}`** if missing.
+     * Save chosen `bankCode`.
+   * **Bank Account** dropdown (dependent on Bank):
+
+     * List sub-collection accounts for the chosen bank.
+     * Label with each account’s **`accountType`**.
+     * Save chosen **`accountDocId`**.
+   * On **Submit**, compute & write **`identifier = "{bankCode}/{accountDocId}"`**.
+
+4. **Reference Number** input → save to **`refNumber: string`**.
+
+5. Rename **Save** → **Submit**.
+
+6. On **Submit**, also stamp **`timestamp`** and **`editedBy`**.
+
+7. **Normalization guard**: if a user-entered `identifier` exists but **doesn’t** match `/^[0-9A-Za-z]+\/[0-9A-Za-z_-]+$/`, **recompute** from `{bankCode}/{accountDocId}` before write.
+
+#### Data access notes
+
+* Use any existing ERL directory reader; otherwise add a small `lib/erlDirectory.ts` with typed helpers to fetch banks/accounts with graceful fallback between the two shapes above.
+* No secrets in code; rely on existing runtime config.
+
+### E) Payment History (list) — keep “For Session(s)”
+
+* Ensure the column remains present and displays up to **5** ordinals; if more, append a trailing `…`.
+* Keep header ellipsis behavior and resizers intact.
+
+### F) A11y & UX polish
+
+* Keyboard navigation for all new selects (focus ring, ARIA labels).
+* Reduced-motion respected for blinks/transitions.
+
+---
+
+## File hints (search/adapt)
+
+* `components/StudentDialog/PaymentModal.tsx` (all cascade UI and submit logic)
+* `components/StudentDialog/PaymentDetail.tsx` (blink class, single render; assignment shell/zero-state)
+* `components/StudentDialog/PaymentHistory.tsx` (verify “For Session(s)” column; header ellipsis intact)
+* `styles/studentDialog.css` (footer stickiness/shadow)
+* `lib/erlDirectory.ts` (add if missing; banks+accounts fetch, typed)
+
+---
+
+## Tests
+
+### Unit
+
+* `lib/payments/format.test.ts` — keep/build on `buildIdentifier` (valid, invalid → recompute).
+* `lib/payments/truncate.test.ts` — already exists; ensure still green.
+* If new helpers added for ERL fetch/transform, add light unit tests with mocked data.
+
+### E2E / Component (Cypress)
+
+* **Sticky Back**: Back renders in sticky footer; remains visible while body scrolls.
+* **Remaining blink**: only Remaining blinks when selection changes; Payment Amount never blinks.
+* **Assignment**: zero-state visible; selecting a session updates Remaining and persists.
+* **Add Payment cascade**: choose Entity=ERL → pick Bank → pick Bank Account → Submit → verify document has `method`, `entity`, `bankCode`, `accountDocId`, `identifier`, `refNumber`, plus `timestamp`, `editedBy`.
+* **List “For Session(s)”**: shows ≤5 ordinals with trailing `…` when more exist.
+
+> Keep specs committed. If CI lacks GUI deps, guard with conditional skip; **do not** edit workflows.
+
+---
+
+## Acceptance criteria (self-check)
+
+* [ ] Back control sits inside sticky footer; footer sticks to window edge on all StudentDialog screens.
+* [ ] Remaining uses a **single** blinking element; Payment Amount is static.
+* [ ] Assignment section has a persistent shell (zero-state) and works end-to-end.
+* [ ] Add Payment cascade fully implemented; correct writes & normalization; audit fields present.
+* [ ] Payment History list shows “For Session(s)” ≤5 + `…`.
+* [ ] No new TypeScript errors; existing tests pass; new tests added.
+
+---
+
+## Save this prompt
+
+Create **exactly** `prompts/p-027.md` and copy this prompt’s full text into it (no renames).
```
