P-015 — Code & UX Fixes

Goal: close the gaps called out in PR feedback and our last review:

restore session counts (show proceeded & cancelled like before),
add double-click auto-fit on column levers,
fix Balance Due single-source-of-truth,
make all dialogs layer correctly (no “covered” modals),
add Base Rate audit trail with editedBy,
harden calendar scan with a shared secret,
fix Firestore numeric types in Apps Script.

Scope & acceptance criteria
A. Sessions summary — restore proceeded/cancelled

In components/StudentDialog/SessionsTab.tsx:

Compute and display:

Total Sessions (includes all sessions),
Proceeded (= not cancelled & started in the past),
Cancelled (= flagged cancelled or sessionType cancelled).

Keep existing Joint Date / Last Session.

Ensure table filters (period, visible columns) do not change the summary numbers.

✅ AC: Summary shows Total, Proceeded, Cancelled. Numbers match expectations even when filters change.

B. Column auto-fit on double-click

In lib/useColumnWidths.ts add a autoFit(key: string, root: HTMLElement) function that:

Measures header cell and visible body cells for that column (use scrollWidth), adds padding + min/max clamp (min 60px, max 600px), then persists width.

In each table (SessionsTab, PaymentHistory, RetainersTab, PaymentDetail’s small table):

Add data-col="<key>" on header TableCell and every body TableCell for that column.

On the .col-resizer element add onDoubleClick={() => autoFit('paymentMade', tableRef.current!)} etc.

Provide a ref to the table root (tableRef) to pass into autoFit.

Narrow the default widths a bit (start ~100–140px for most text columns, 70–90px for #/amount-only).

✅ AC: Double-clicking a lever fits to content like Google Sheets; widths persist per user.

C. Balance Due: one source of truth

Treat Students/{abbr}.billingSummary.balanceDue as authoritative.

Audit all mutating flows and call writeSummaryFromCache(qc, abbr, account) after success:

Payment add / assign / unassign (already in PaymentDetail, keep).

Rate changes (in RateModal on save → ensure it calls writeSummaryFromCache).

Voucher mark/unmark (already in SessionDetail via createVoucherEntry, re-confirm and keep).

Retainer add/edit (RetainerModal on save → call writeSummaryFromCache).

In cards (pages/dashboard/businesses/coaching-sessions.tsx), keep reading billingSummary.balanceDue (already hooked).

✅ AC: After any change, the card’s Balance Due updates within the same session (snapshot). There are no discrepancies vs. details.

D. Dialog layering & portals

Convert any custom fixed overlay modals (e.g., RetainerModal) to MUI <Dialog> with open, onClose, and portal to document.body (your theme already sets Menu/Popover/Popper containers).

Ensure PaymentModal is also a MUI Dialog and not nested inside a container that creates a stacking context (no parent with transform, filter, or opacity<1 that might trap z-index).

Keep sticky footers; do not increase z-index beyond MUI’s defaults (Dialog = 1300+).

Add a quick Cypress test: open Student dialog → open Add Payment → assert the Add Payment dialog is visible above the student dialog.

✅ AC: Add Payment dialog never gets covered; same for similar dialogs.

E. Base Rate audit trail (+editedBy)

Where “Base Rate” is shown (Session detail and/or relevant settings UI), add a small Info icon (InfoOutlined) next to the label.

Clicking opens a Base Rate History dialog:

Firestore path: Students/{abbr}/BaseRateHistory/{id}.

Fields: rate (number), timestamp (server or client Date), editedBy (string; from next-auth session user email).

Show a small table of entries (latest first) and an “Add new rate” form (rate input).

On add, also call writeSummaryFromCache(qc, abbr, account) so derived fields stay current.

✅ AC: History lists prior entries; adding a new rate writes rate, timestamp, editedBy and updates summaries.

F. Secure the calendar scan endpoint

Apps Script (apps-script/ScanEndpoint.gs):

Store SCAN_SECRET in Script Properties (File → Project properties → Script properties).

In doPost(e), require body.secret === scriptProps.getProperty('SCAN_SECRET'). If not, return { ok:false, message:'unauthorized' } (HTTP 401 if you like).

Next.js (pages/api/calendar-scan.ts):

Read process.env.CALENDAR_SCAN_URL and process.env.CALENDAR_SCAN_SECRET.

Always include { secret: process.env.CALENDAR_SCAN_SECRET, ...existingBody } in the POST body.

✅ AC: Calls without the correct secret are rejected by Apps Script.

G. Firestore numeric types in Apps Script

In apps-script/Firestore.gs → toFirestoreFields:

For numbers, use:
} else if (typeof val === 'number') {
  if (Math.floor(val) === val) {
    fields[key] = { integerValue: String(val) };
  } else {
    fields[key] = { doubleValue: val };
  }
}

✅ AC: Decimals are written as doubleValue. Integers remain integerValue.

Implementation notes

Add data-col consistently: e.g., in SessionsTab for ordinal, date, time, etc.; in PaymentHistory add for paymentMade, amount, session; in RetainersTab for retainer, period, rate, status, actions; in PaymentDetail table for ordinal, date, time, rate.

Provide a shared TableRoot ref to pass into autoFit.

Keep the slimmer .col-resizer lever (already done); simply bind onDoubleClick now.

After retainer save & rate save, make sure we call writeSummaryFromCache(...) and close the dialog.

Config changes

.env.local (and Vercel env):

CALENDAR_SCAN_URL="https://script.google.com/macros/s/AKfycbzESImrT9yROHCEq0HFM70mGNLd_x-HYT-nJ1E9X_urFxxOPKi3XYqHZW79bGk3tqgFZA/exec"
CALENDAR_SCAN_SECRET="<choose-a-long-random-string>"

Apps Script → Script Properties:

SCAN_SECRET=<same-long-random-string>

Test plan

Sessions summary: Load a student with a known cancelled event + past completed event → see Total, Proceeded, Cancelled counts correct. Toggle filters → counts unchanged.

Auto-fit: Manually shrink a column, double-click its lever → fits to widest visible content. Refresh → width persists.

Balance Due: Change a rate, mark voucher, assign payment, add retainer → card value matches details immediately.

Dialogs: Open Student dialog → open Add Payment → visually on top; run the Cypress spec.

Base Rate history: Add a new rate → entry includes editedBy; derived summaries refresh.

Scan security: Call /api/calendar-scan with wrong secret (temporarily) → Apps Script rejects. With correct secret → works.

Numeric types: Write a decimal rate via Apps Script flow → stored as doubleValue (spot-check in Firestore REST view).
