# P-017 — Task Log guardrails + finish P-016 acceptance (autosize, session totals, balance due, modal stacking, base-rate audit, scan security)

> Save this exact prompt to: `prompts/p-017.md` in the repo.

## A. Task Log guardrails (finish the HOTFIX)
1) Ensure `docs/Task Log.md` is restored from `main` and is **append-only**.
2) Add CI check: `.github/workflows/task-log-guard.yml`
   - Job: fetch `origin/main`, compute line count of `docs/Task Log.md` at `HEAD` vs `origin/main`. Fail if decreased by >10 lines.
3) Update `CONTRIBUTING.md` with the append-only rule and the “new rows at the top” convention.

## B. Double-click autosize for columns (Sessions/Retainers/Payments)
- File: `lib/useColumnWidths.ts`
  - Add `dblClickResize(key: string, rootEl?: HTMLElement)` that:
    - Measures widest visible cell in that column (header + body). Use an off-screen measurer div with same font styles.
    - Adds padding buffer (e.g. +20px) and clamps (min 60px, max 600px).
    - Updates `widths[key]` and persists.
- Wire up `onDoubleClick` on each `.col-resizer`:
  - `components/StudentDialog/SessionsTab.tsx`
  - `components/StudentDialog/RetainersTab.tsx`
  - `components/StudentDialog/PaymentHistory.tsx`
- Acceptance: double-click lever fits to content quickly (no visible layout jank); drag-resize still works and persists.

## C. “Total Sessions” parity (include cancelled/proceeded)
- `components/StudentDialog/SessionsTab.tsx`:
  - Recompute `summary.totalSessions` to include **all** sessions in the active window (as it used to), including cancelled/proceeded.
  - (Nice) Show a small breakdown: `Total: N • Cancelled: C • Proceeded: P`.
- Acceptance: totals match legacy behavior; tests/manual checks show parity.

## D. Balance-Due single source of truth
- Canonicalize Reads:
  - Option 1 (preferred): source from `useBilling(abbr, account)` summary for both **cards** (`coaching-sessions.tsx`) and **dialogs**.
  - Option 2: maintain `Students/{abbr}/Billing/Summary` doc that `writeSummaryFromCache` updates; read this in both places.
- Ensure every mutation path calls `writeSummaryFromCache`:
  - Payment assignment/unassignment, voucher mark/unmark, rate edits, retainer payments.
- Acceptance: Card “Due” matches dialog “Balance Due” after any change; no stale “—” except while loading.

## E. Modal stacking (Payment/Retainer/etc.)
- Convert overlays to MUI `Dialog` (or ensure `<Portal container={document.body}>` with `zIndex` > parent dialog).
- Files to verify:
  - `components/StudentDialog/PaymentModal.tsx`
  - `components/StudentDialog/RetainerModal.tsx`
  - Anywhere else we use custom overlay.
- Theme: if needed, set `theme.zIndex.modal >= 1500` and ensure controlling dialogs get higher `z-index` than parent.
- Acceptance: “Add Payment” (and peers) always appear above Student dialog; focus trap and ESC close work.

## F. Base-Rate audit trail
- Add an info icon next to “Base Rate” in `SessionDetail.tsx` that opens `BaseRateHistoryDialog`.
- New: `components/StudentDialog/BaseRateHistoryDialog.tsx`
  - List history entries `{ rate: number, timestamp: Timestamp, editedBy: string }` (desc).
  - “Add entry” form writes a new record with `editedBy = session.user.email || 'unknown'`.
  - Suggested path: `Students/{abbr}/BaseRateHistory` (or per-account if required).
- Acceptance: view/add history works; `editedBy` captured.

## G. Apps Script hardening (timezone + shared secret)
- `apps-script/CONFIG.gs`: set `TIMEZONE` to `'Asia/Hong_Kong'` (or read Script Property).
- `apps-script/ScanEndpoint.gs`:
  - Require header `X-Scan-Secret`; compare to Script Property `SCAN_SECRET`. Return 401 on mismatch.
- `pages/api/calendar-scan.ts`:
  - Send `X-Scan-Secret` from `process.env.SCAN_SECRET`.
- `.env.local.example`:
```
CALENDAR_SCAN_URL="https://script.google.com/macros/s/AKfycbzESImrT9yROHCEq0HFM70mGNLd_x-HYT-nJ1E9X_urFxxOPKi3XYqHZW79bGk3tqgFZA/exec"
SCAN_SECRET="choose-a-long-random-string"
```
- Acceptance: scan returns 401 without/with wrong secret; OK with correct secret; HK timestamps.

## H. QA & docs
- Add/refresh inline comments near touched areas.
- Update `README` (env vars) and `docs/Task Log.md` (see P-017 update prompt).

