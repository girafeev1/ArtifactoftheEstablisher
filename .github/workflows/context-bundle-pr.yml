name: PR Context Bundle

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, edited]

permissions:
  contents: write
  pull-requests: write

jobs:
  bundle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      # ⬇️ Replace this with your real generator; write to .tmp_new_context.md
      - name: Generate context (replace this step)
        run: |
          mkdir -p docs/context
          echo "# Context for PR #${{ github.event.number }}" > .tmp_new_context.md
          # your generator should append real content to .tmp_new_context.md

      # ✅ Commit ONLY if the file actually changed (Option C)
      - name: Check if context changed
        id: ctxdiff
        run: |
          set -e
          file="docs/context/PR-${{ github.event.number }}.md"
          if [ -f "$file" ]; then
            if diff -q "$file" .tmp_new_context.md >/dev/null; then
              echo "changed=false" >> $GITHUB_OUTPUT
            else
              mv .tmp_new_context.md "$file"
              echo "changed=true" >> $GITHUB_OUTPUT
            fi
          else
            mv .tmp_new_context.md "$file"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # 🔁 Write back to the PR branch ONLY (Option B2)
      - name: Commit context to PR branch
        if: steps.ctxdiff.outputs.changed == 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/context/PR-${{ github.event.number }}.md
          git commit -m "chore(context): update PR #${{ github.event.number }}"
          git push origin HEAD:${{ github.head_ref }}

      - name: Log context bundle update
        if: steps.ctxdiff.outputs.changed == 'true'
        run: |
          {
            echo "## Context bundle updated"
            echo "- PR: #${{ github.event.number }}"
            echo "- File: docs/context/PR-${{ github.event.number }}.md"
          } >> "$GITHUB_STEP_SUMMARY"
